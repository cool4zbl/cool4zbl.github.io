<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Fun with Codemod &amp; AST- cool4zbl</title>
    <meta name="description" content="TL;DR Facebook ä¸ºäº†è§£å†³ã€Œå¤§å‹ä»£ç åº“ã€è¿ç§»ï¼ŒåŸºäº AST é€ äº†ä¸ªå·¥å…· Codemod åŸºäº Codemod åˆæ„å»ºäº† JavaScript ä»£ç è¿ç§»ä¸“ç”¨çš„å·¥å…· jscodeshift å’Œ React-codemod ç†è§£è¿™äº›å·¥å…·èƒŒåçš„åŸç†æœ‰åŠ©äºä»ä¸€ä¸ªå•çº¯çš„ã€ŒAPI ä½¿ç”¨è€…ã€å˜æˆä¸€ä¸ªå·¥ç¨‹å¸ˆèˆ¬çš„ã€Œåˆ›é€ è€…ã€ Demo Timeï¼Let&amp;#39;s write a codemod ä¸€äº›æœ‰ä»·å€¼çš„å‚è€ƒ èƒŒæ™¯ ä½œä¸ºä¸€ä¸ªè‡ªä¿¡è€Œè‡ªè±ªçš„å‰ç«¯å¼„æ½®å„¿ï¼ˆF2Eï¼‰ï¼Œæˆ‘ä»¬æ€»æ˜¯å¸Œæœ›èƒ½å¤Ÿåœ¨è¿™ä¸ªæ¯å¤©éƒ½åœ¨é£é€Ÿè¿­ä»£çš„è¡Œä¸šï¼Œä¸æ—¶æ¸è¿›ã€‚ å‰ç«¯ä»¬æ˜¯ä¸€ç¾¤ä¸å®‰åˆ†çš„äººï¼Œå¤§å®¶å–œçˆ±æ–°æ¡†æ¶ã€æ–°è¯­æ³•ï¼Œè€Œ JavaScript ä¹Ÿæ˜¯ä¸€é—¨éå¸¸çµæ´»çš„è¯­è¨€ï¼Œå®ƒæä¾›ç»™æˆ‘ä»¬çš„ API ä¹Ÿåœ¨ä¸æ—¶æ¸è¿›ã€‚æ¯”å¦‚ï¼Œå½“ ES2015 / ES2016 / ES2017â€¦ å‡ºæ¥çš„æ—¶å€™ï¼Œé‚£äº›æ–°è¯­æ³•ç³–ï¼Œç®€æ´æ¼‚äº®ï¼Œä¸”æ›´æ˜“äºç†è§£é€»è¾‘ï¼Œäºæ˜¯æˆ‘ä»¬éƒ½æƒ³å»å°è¯•ä¸‹ã€‚ ä½†æ˜¯å°è¯•å½’å°è¯•ï¼Œå¯¹äºæ–°é¡¹ç›®å°è¯•èµ·æ¥æˆæœ¬å¾ˆä½ï¼Œåªéœ€è¦æŠŠæ–°åŠŸèƒ½éƒ½ç”¨æ–°è¯­æ³•ç¼–å†™å°±å¥½ã€‚ è€Œåˆ›å»ºæ–°é¡¹ç›®çš„åŒæ—¶ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿåœ¨ç»´æŠ¤ç€ä¸€äº›å·²æœ‰çš„æ—§é¡¹ç›®ã€‚å¦‚æœä½ è¿˜å¹¶æ²¡æ€ä¹ˆç†å®ƒä»¬ï¼Œå¯èƒ½å®ƒä»¬è¿˜æ´»å¾—ä¸é”™ã€‚ä½†æ˜¯ä¸€æ—¦ PM å¿ƒæƒ…å¥½æƒ³åŠ ä¸ªæ–°åŠŸèƒ½ï¼Œæˆ–è€…ä½ å“ªå¤©å¿ƒæƒ…å¥½æƒ³å»æ›´æ–°ä¸‹ä»£ç åº“ï¼Œç„¶åçœ‹åˆ°è‡ªå·±ä¹‹å‰å†™çš„é‚£äº›ä»£ç ï¼Œé‚£äº›ç°åœ¨å…¶å®å¯ä»¥æ›´ä¼˜é›…æ¼‚äº®çš„ä»£ç ï¼Œæ˜¯ä¸æ˜¯æ‰‹é‡Œç‰¹ç—’ç—’ç‰¹æƒ³æŠŠå®ƒä»¬æ›´æ–°äº†ï¼Ÿ æ‰§è¡ŒåŠ›å¼ºçš„å°ä¼™ä¼´å¯èƒ½è¯´å¹²å°±å¹²äº†ã€‚å—¯ï¼Œå°±å‡è®¾æˆ‘ä»¬æœ‰ä¸ªé¡¹ç›®ï¼Œé‡Œé¢ä½¿ç”¨çš„æ˜¯ç”¨ES5 ç‰ˆ React ä½œä¸º UI Viewå±‚ï¼Œç„¶åå®ƒå¤§æ¦‚å››ä¸ªé¡µé¢(Page)ï¼Œæ¯ä¸ªé¡µé¢åŒ…å«å¤§æ¦‚å››ä¸ªç»„ä»¶(Component)ï¼Œç„¶åä½ ä»æŸä¸ªçœ‹èµ·æ¥æ¯”è¾ƒå°ã€ä¸å®¹æ˜“å‡ºé”™çš„Component å…¥æ‰‹ï¼Œå¼€å§‹ä¸€è¡Œä¸€è¡Œæ”¹å†™ä»£ç ï¼Œå—¯ï¼Œvar React = require(&amp;#39;reactâ€™) æ”¹ä¸º import React from &amp;#39;reactâ€™ï¼Œ vartech,programming,frontend" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#d55b6a">
    <meta name="theme-color" content="#ffffff">


    <link rel="stylesheet" type="text/css"
        href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />

    <link rel="stylesheet" type="text/css" href="/assets/built/hl-styles/atom-one-dark.css" />


    <meta name="generator" content="Ghost ?" />
<link rel="alternate" type="application/rss+xml" title="Doodles" href="/rss/index.xml">
<link rel="canonical" href="http://zhangbinliu.me/2017-02-15-fun-with-codemod-and-ast/" />
</head>

<body class="author-template author- post-template tag-tech tag-programming tag-frontend nav-closed">

    

    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
    </nav>
</header>

<main class="content" role="main">
    <article class="post tag-tech tag-programming tag-frontend">

        <header class="post-header">
            <h1 class="post-title">Fun with Codemod &amp; AST</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2017-02-15">15 February 2017</time>  on <a href="/tag/tech/">tech</a>, <a href="/tag/programming/">programming</a>, <a href="/tag/frontend/">frontend</a>
            </section>
        </header>


        <section class="post-content">
          <h2 id="tl-dr">TL;DR</h2>
<ul>
<li>Facebook ä¸ºäº†è§£å†³ã€Œå¤§å‹ä»£ç åº“ã€è¿ç§»ï¼ŒåŸºäº AST é€ äº†ä¸ªå·¥å…· <strong>Codemod</strong></li>
<li>åŸºäº Codemod åˆæ„å»ºäº† JavaScript ä»£ç è¿ç§»ä¸“ç”¨çš„å·¥å…· <strong>jscodeshift</strong> å’Œ <strong>React-codemod</strong></li>
<li>ç†è§£è¿™äº›å·¥å…·èƒŒåçš„åŸç†æœ‰åŠ©äºä»ä¸€ä¸ªå•çº¯çš„ã€ŒAPI ä½¿ç”¨è€…ã€å˜æˆä¸€ä¸ªå·¥ç¨‹å¸ˆèˆ¬çš„ã€Œåˆ›é€ è€…ã€</li>
<li>Demo Timeï¼Let&#39;s write a codemod</li>
<li>ä¸€äº›æœ‰ä»·å€¼çš„å‚è€ƒ</li>
</ul>
<hr>
<h2 id="-">èƒŒæ™¯</h2>
<p>ä½œä¸ºä¸€ä¸ªè‡ªä¿¡è€Œè‡ªè±ªçš„å‰ç«¯å¼„æ½®å„¿ï¼ˆF2Eï¼‰ï¼Œæˆ‘ä»¬æ€»æ˜¯å¸Œæœ›èƒ½å¤Ÿåœ¨è¿™ä¸ªæ¯å¤©éƒ½åœ¨é£é€Ÿè¿­ä»£çš„è¡Œä¸šï¼Œä¸æ—¶æ¸è¿›ã€‚</p>
<p>å‰ç«¯ä»¬æ˜¯ä¸€ç¾¤ä¸å®‰åˆ†çš„äººï¼Œå¤§å®¶å–œçˆ±æ–°æ¡†æ¶ã€æ–°è¯­æ³•ï¼Œè€Œ JavaScript ä¹Ÿæ˜¯ä¸€é—¨éå¸¸çµæ´»çš„è¯­è¨€ï¼Œå®ƒæä¾›ç»™æˆ‘ä»¬çš„ API ä¹Ÿåœ¨ä¸æ—¶æ¸è¿›ã€‚æ¯”å¦‚ï¼Œå½“ <code>ES2015 / ES2016 / ES2017â€¦</code> å‡ºæ¥çš„æ—¶å€™ï¼Œé‚£äº›æ–°è¯­æ³•ç³–ï¼Œç®€æ´æ¼‚äº®ï¼Œä¸”æ›´æ˜“äºç†è§£é€»è¾‘ï¼Œäºæ˜¯æˆ‘ä»¬éƒ½æƒ³å»å°è¯•ä¸‹ã€‚</p>
<p>ä½†æ˜¯å°è¯•å½’å°è¯•ï¼Œå¯¹äºæ–°é¡¹ç›®å°è¯•èµ·æ¥æˆæœ¬å¾ˆä½ï¼Œåªéœ€è¦æŠŠæ–°åŠŸèƒ½éƒ½ç”¨æ–°è¯­æ³•ç¼–å†™å°±å¥½ã€‚</p>
<p>è€Œåˆ›å»ºæ–°é¡¹ç›®çš„åŒæ—¶ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿåœ¨ç»´æŠ¤ç€ä¸€äº›å·²æœ‰çš„æ—§é¡¹ç›®ã€‚å¦‚æœä½ è¿˜å¹¶æ²¡æ€ä¹ˆç†å®ƒä»¬ï¼Œå¯èƒ½å®ƒä»¬è¿˜æ´»å¾—ä¸é”™ã€‚ä½†æ˜¯ä¸€æ—¦ PM å¿ƒæƒ…å¥½æƒ³åŠ ä¸ªæ–°åŠŸèƒ½ï¼Œæˆ–è€…ä½ å“ªå¤©å¿ƒæƒ…å¥½æƒ³å»æ›´æ–°ä¸‹ä»£ç åº“ï¼Œç„¶åçœ‹åˆ°è‡ªå·±ä¹‹å‰å†™çš„é‚£äº›ä»£ç ï¼Œé‚£äº›ç°åœ¨å…¶å®å¯ä»¥æ›´ä¼˜é›…æ¼‚äº®çš„ä»£ç ï¼Œæ˜¯ä¸æ˜¯æ‰‹é‡Œç‰¹ç—’ç—’ç‰¹æƒ³æŠŠå®ƒä»¬æ›´æ–°äº†ï¼Ÿ</p>
<p>æ‰§è¡ŒåŠ›å¼ºçš„å°ä¼™ä¼´å¯èƒ½è¯´å¹²å°±å¹²äº†ã€‚å—¯ï¼Œå°±å‡è®¾æˆ‘ä»¬æœ‰ä¸ªé¡¹ç›®ï¼Œé‡Œé¢ä½¿ç”¨çš„æ˜¯ç”¨<code>ES5</code> ç‰ˆ <code>React</code> ä½œä¸º <code>UI View</code>å±‚ï¼Œç„¶åå®ƒå¤§æ¦‚å››ä¸ªé¡µé¢<code>(Page)</code>ï¼Œæ¯ä¸ªé¡µé¢åŒ…å«å¤§æ¦‚å››ä¸ªç»„ä»¶<code>(Component)</code>ï¼Œç„¶åä½ ä»æŸä¸ªçœ‹èµ·æ¥æ¯”è¾ƒå°ã€ä¸å®¹æ˜“å‡ºé”™çš„<code>Component</code> å…¥æ‰‹ï¼Œå¼€å§‹ä¸€è¡Œä¸€è¡Œæ”¹å†™ä»£ç ï¼Œå—¯ï¼Œ<code>var React = require(&#39;reactâ€™)</code> æ”¹ä¸º <code>import React from &#39;reactâ€™</code>ï¼Œ <code>var API = â€˜/j/app/xxxâ€™</code> æ”¹ä¸º <code>const API = â€˜/j/app/xxxâ€™</code>ï¼Œ<code>var foo</code> æ”¹ä¸º <code>let foo</code>ï¼Œ<code>function () {â€¦}</code> æ”¹ä¸º <code>() =&gt; {â€¦}</code>ï¼Œ<code>module.exports = React.createClass({â€¦})</code> æ”¹ä¸º <code>export default class MyComponent extends React.Component {â€¦}</code> â€¦</p>
<p>å¤©å“ªï¼Œæœ‰å®Œæ²¡å®Œï¼Œä¸€ä¸ªç»„ä»¶æ”¹å®Œä¸‹æ¥ï¼Œä½ å·²ç»æ„Ÿåˆ°èº«ä½“è¢«æç©ºï¼Œæœ›äº†æœ› <code>Components</code> åˆ—è¡¨ï¼Œæ›´ä¸ç”¨è¯´ï¼Œé‡æ–° <code>build</code> è¿‡çš„æµ‹è¯•è¿˜æ²¡è¿‡ã€‚ä½ é™·å…¥äº†ç»æœ›...</p>
<p>é‚£ä¹ˆæœ‰æ²¡æœ‰æ›´å¿«ä¸€ç‚¹çš„åŠæ³•å‘¢ï¼Ÿ</p>
<p>ç¨å¾®æœ‰ç‚¹ç»éªŒçš„å‰ç«¯å„¿å¯èƒ½æƒ³åˆ°ã€Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ›¿æ¢ã€ã€‚Bash <code>Awk | Sed</code> å‘½ä»¤ï¼Œæˆ–è€… Vim <code>:%s/var/let/g</code>ã€‚å¯æ˜¯å¦‚æœéœ€è¦æœ‰äº›å˜é‡æ˜¯ <code>const</code> ç±»å‹ï¼Œæœ‰äº›æ˜¯ <code>let</code>ï¼Œè€Œæœ‰äº›ä¿æŒ <code>var</code> ä¸å˜æ€ä¹ˆåŠï¼Ÿå†æ¯”å¦‚è¯´ä»¥ä¸‹è¿™æ®µå¾ˆå¸¸è§çš„ä»£ç ï¼š</p>
<pre class="hljs"><code><span class="hljs-tag">merge</span>(a, {<span class="hljs-attribute">b</span>: <span class="hljs-number">1</span>}, c);  <span class="hljs-comment">// Old</span>

<span class="hljs-comment">// éœ€è¦å˜ä¸º</span>

({..<span class="hljs-class">.a</span>, <span class="hljs-tag">b</span>: <span class="hljs-tag">1</span>, ..<span class="hljs-class">.c</span>});  <span class="hljs-comment">// New</span></code></pre><p>è¿™é‡Œå…‰æ˜¯è¿™ä¸ªå‡½æ•°çš„ <code>arguments</code> å°±å¯èƒ½æœ‰å¤šç§å½¢å¼ï¼Œæ¯”å¦‚ <code>variable</code>ï¼Œä¸€ä¸ªåŒ¿åå‡½æ•°è¿”å›çš„ Object æˆ–è€… <code>Plain Object</code> é‚£ç§ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œå·²ç»ç›¸å½“äºæ˜¯ä¸€ä¸ª <code>Context-non-free</code> çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>ä¸Šä¸‹æ–‡è¯­ä¹‰</strong>å¾ˆé‡è¦ã€‚</p>
<p>è¿™æ ·çš„è¯ï¼Œæ— è®ºå†æ€ä¹ˆå¼ºå¤§çš„<code>RegExp</code> ä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚å› ä¸ºæ­£åˆ™çš„æœ¬è´¨ï¼Œå…¶å®æ˜¯æ ¹æ®ä¸€å®šçš„ <code>Pattern</code> æ¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œä½†æ˜¯åœ¨çœŸæ­£çš„ä»£ç é‡Œï¼Œæ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½æœ‰è¯­ä¹‰ï¼Œéƒ½æœ‰ä¸Šä¸‹æ–‡ï¼Œè¿™é‡Œçš„æ­£åˆ™è¡¨è¾¾å¼ä¼šæ—¢å¤æ‚åˆæ— ç”¨ã€‚
æ‰€ä»¥ï¼Œæˆ‘ä»¬å¾—<strong>å‡ä¸€ä¸ªç»´åº¦</strong>æ€è€ƒé—®é¢˜ã€‚</p>
<h2 id="codemod">Codemod</h2>
<p>å¯¹ã€Œä»£ç åº“çš„æ‰¹é‡è¿ç§»æ›´æ–°ã€ï¼Œå…¶å®ä¹Ÿæ˜¯ç¨‹åºå‘˜çš„ä¸€ä¸ªéœ€æ±‚ï¼Œæ‰€ä»¥ï¼Œå¾ˆæ„Ÿæ©åœ°ï¼Œå·²ç»æœ‰ä¸€ç¾¤æ‡’æƒ°åˆèªæ˜çš„ç¨‹åºå‘˜é€ å‡ºäº†å·¥å…·ï¼š<strong>Codemod</strong>ï¼Œå°†ã€Œå¤§å‹ä»“åº“ä»£ç çš„æ‰¹é‡è¿ç§»ã€è‡ªåŠ¨åŒ–ï¼Œçœæ—¶çœåŠ›ã€‚</p>
<p>å¥½å§ï¼Œæ‰€ä»¥ <strong>Codemod</strong> åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>å®˜æ–¹æ–‡æ¡£è¿™æ ·å†™ç€ï¼š</p>
<blockquote>
<p>Codemod is a tool/library to assist you with large-scale codebase refactors that can be partially automated but still require human oversight and occasional intervention.</p>
</blockquote>
<p>è¿™æ ·çœ‹æ¥ï¼Œå¯ä»¥å¾ˆå¥½çš„è§£å†³æˆ‘ä»¬çš„éœ€æ±‚äº†ã€‚</p>
<p>åŸºäº Codemodï¼Œåˆå‡ºç°äº†é’ˆå¯¹ JavaScript ä»£ç è¿ç§»çš„å·¥å…· <a href="https://github.com/facebook/jscodeshift">Facebook jscoodeshift</a>.</p>
<p>åŸºäº <strong>jscodeshift</strong>ï¼Œåˆæ„å»ºäº†è¿ç§»ä¸€èˆ¬ JavaScript ä»£ç ï¼ˆæ¯”å¦‚ ES5 -&gt; ES2015) çš„å·¥å…· <a href="https://github.com/cpojer/js-codemod">js-codemod</a> å’Œè¿ç§» React ç›¸å…³é¡¹ç›®çš„ <a href="https://github.com/reactjs/react-codemod">react-codemod</a>ã€‚</p>
<p>å—¯ï¼Œè¿™ä¹ˆçœ‹æ¥ï¼Œæˆ‘ä»¬çš„äº‹æƒ…å°±å˜å¾—å®¹æ˜“å¤šäº†ã€‚</p>
<p>æ ¹æ®ä¸Šé¢é‚£äº›å·¥å…·çš„å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="hljs"><code>&gt; npm i -g jscodeshift
&gt; git clone https:<span class="hljs-comment">//github.com/reactjs/react-codemod.git</span>
&gt; git clone https:<span class="hljs-comment">//github.com/cpojer/js-codemod.git</span>
&gt; jscodeshift -t react-codemod/transforms/<span class="hljs-keyword">class</span>.js --<span class="hljs-keyword">mixin</span>-<span class="hljs-keyword">module</span>-name=react-addons-<span class="hljs-keyword">pure</span>-render-<span class="hljs-keyword">mixin</span> --flow=<span class="hljs-literal">true</span> --<span class="hljs-keyword">pure</span>-component=<span class="hljs-literal">true</span> --remove-runtime-proptypes=<span class="hljs-literal">false</span> src/register/component/myComponent.jsx
&gt; jscodeshift -t js-codemod/transforms/no-vars.js ./src/register/component/myComponent.jsx</code></pre><p>ç„¶åï¼Œå†æ¬¡ <code>git status</code> ä¸€ä¸‹æˆ–è€…ç›´æ¥æ‰“å¼€åˆšæ‰ transform çš„ <code>myComponent.jsx</code> æ–‡ä»¶æŸ¥çœ‹ï¼Œä½ ä¼šå‘ç°ï¼ŒWowï¼Œç¥å¥‡èˆ¬ï¼Œä½ çš„ä»£ç éƒ½æˆä¸ºäº†å®ƒä»¬åº”è¯¥æˆä¸ºçš„æ ·å­ï¼</p>
<p>è¿™é‡Œæš‚æ—¶ä»¥æˆ‘ä¹‹å‰åšçš„ Accounts é¡¹ç›®ä¸ºä¾‹ï¼š</p>
<p><a href="https://github.intra.douban.com/accounts/accounts/pull/553/files#diff-b2286efdea6a62288250264e82bd948b">https://github.intra.douban.com/accounts/accounts/pull/553/files#diff-b2286efdea6a62288250264e82bd948b</a></p>
<p>åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ <code>codemod</code>ï¼Œæ‰€ä»¥æ¯”è¾ƒè°¨æ…ï¼Œä¸€ä¸ªä¸€ä¸ª <code>component</code> æ¥ï¼›</p>
</li>
<li><p>å…ˆç”¨ <code>react-codemod</code> è½¬ï¼ŒæŠŠå¤§éƒ¨å¤´ä»£ç è¿ç§»ï¼›</p>
</li>
<li><p>ç„¶å <code>js-codemod</code> å°æ­¥æ›´æ–°æ•´ç†ï¼›</p>
</li>
<li><p>ç„¶åå†æ ¹æ®ä¸€äº›è‡ªå·±çš„ Code Style åšäº›ç»†èŠ‚ä¸Šçš„ä¿®æ”¹ã€‚æ¯”å¦‚ä½¿ç”¨ <code>standard-format</code> å·¥å…·æ ¼å¼åŒ–ä»£ç ï¼Œç¬¦åˆæˆ‘ä¸ªäººå†™çš„ä»£ç é£æ ¼ã€‚</p>
</li>
<li><p>æ¯•ç«Ÿ JS å¤ªè¿‡äºçµæ´»ï¼Œæ¯ä¸ªäººå†™ä»£ç æ—¶å€™é£æ ¼å’Œç»“æ„éƒ½æ˜¯å„å¼‚çš„ï¼Œæœ‰æ—¶å€™çš„è½¬æ¢è¿˜æ˜¯ä¼šå‡ºç°ä¸€äº›ä¸æƒ³è±¡ä¸­ä¸ä¸€è‡´çš„ç»“æœï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæ˜¯è¯´ä»ç„¶éœ€è¦äººå·¥å¹²é¢„ï¼Œæ‰€ä»¥ä¼šæ ¹æ® transform åçš„ç»“æœæ‰‹åŠ¨ä¿®æ”¹ä¸‹ä»£ç ç»†èŠ‚ï¼›</p>
</li>
<li><p>ä¸€åˆ‡ç»„ä»¶è¿ç§»å°±ç»ªï¼Œ<code>npm run test</code> æµ‹è¯•é€šè¿‡ä»¥åï¼Œé‡æ–° <code>build</code> è¿è¡Œ</p>
<p>â€‹</p>
</li>
</ol>
<p>è¿™é‡Œæˆ‘æŠŠå·²æœ‰çš„åå‡ ä¸ªç»„ä»¶å’Œé¡µé¢æ–‡ä»¶ï¼Œå…¨éƒ¨ä½¿ç”¨ä¸Šé¢çš„å·¥å…·è¿›è¡Œäº†æ›´æ–°ã€‚</p>
<p>ç„¶åå½“ä½ é‡æ–° <code>build</code> åï¼Œä½ ä¼šå‘ç°æµ‹è¯•ä»ç„¶é€šè¿‡ï¼Œç»„ä»¶åŠŸèƒ½ä»ç„¶ workï¼Œä½†æ˜¯ä»£ç åº“å´æ˜¯ä½¿ç”¨æ–°è¯­æ³•ç³–è¿›è¡Œäº†å¤§è§„æ¨¡å½»å½»åº•åº•åœ°æ›´æ–°ï¼ç®€ç›´å¤ªç¥å¥‡äº†ï¼ğŸ¤“
é‚£ä¹ˆï¼Œå®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œå°±è¦å¥½å¥½æ·±ç©¶ä¸‹è¿™ä¸ªå·¥å…·äº†ã€‚</p>
<h2 id="jscodeshift">jscodeshift</h2>
<p>è®©æˆ‘ä»¬æ¥é‡æ–°è¯»ä¸€ä¸‹ jscodeshift çš„<a href="https://github.com/facebook/jscodeshift#jscodeshift-">æ–‡æ¡£</a>ã€‚</p>
<blockquote>
<p>jscodeshift is a toolkit for running codemods over multiple JS files. It provides:</p>
</blockquote>
<ul>
<li>A runner, which executes the provided transform for each file passed to it. It also outputs a summary of how many files have (not) been transformed.</li>
<li>A wrapper around recast, providing a different API. Recast is an AST-to-AST transform tool and also tries to preserve the style of original code as much as possible.</li>
</ul>
<p>é‚£ä¹ˆè¿™é‡Œå°±å‡ºç°äº†ä¸¤ä¸ªå…³é”®çš„æ¦‚å¿µï¼š<em>Runner</em> åŠ <em>AST</em>ã€‚</p>
<ul>
<li><strong>Runner</strong></li>
<li><blockquote>
<p>A runner/worker feature that can apply transforms to thousands of files in parallel.
-- <a href="https://medium.com/@cpojer/effective-javascript-codemods-5a6686bb46fb#.sg03sd9eq">CPojer Effective JavaScript Codemods</a></p>
</blockquote>
</li>
<li><p><strong>AST</strong>ï¼ŒAbstract Syntax Treeï¼ŒæŠ½è±¡è¯­æ³•åˆ†ææ ‘ã€‚</p>
</li>
</ul>
<p>ä¸ºäº†æ›´å¥½ç†è§£ä»¥ä¸Šæ¦‚å¿µï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ä¹‹å‰è¿è¡Œ jscodeshift å‘½ä»¤è¿‡ç¨‹ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ˜¯æŠŠä¸€ä¸ªé‡Œé¢åŒ…å«äº† JS ä»£ç çš„æºæ–‡ä»¶ä¼ ç»™äº†å®ƒï¼Œç„¶åå®ƒè¯»å–äº†æºä»£ç ï¼Œåˆæ ¹æ®å†™å¥½çš„ <code>transform.js</code> å¯¹æºä»£ç è¿›è¡Œäº†ç›¸åº”çš„å˜æ¢ï¼Œæœ€åè¾“å‡ºäº†å˜æ¢åçš„ JS ä»£ç ï¼Œè¦†ç›–äº†åŸæ–‡ä»¶ã€‚</p>
<p>è¿™ä¸ªè¿‡ç¨‹ç®€å•çš„è¯´ï¼Œå°±æ˜¯ï¼š
<code>SourceCode =&gt; codemod =&gt; ObjectCode</code></p>
<p>é‚£ä¹ˆå†è¯¦ç»†ä¸€ç‚¹ï¼Œæ ¹æ® jscodeshift ä½œè€…ä¹‹ä¸€çš„ CPojer åœ¨ä¸€æ¬¡ JSConf ä¸Šå¯¹è¿™ä¸ªå·¥å…·çš„ä»‹ç»ï¼Œjscodeshift æ“ä½œåŸºæœ¬æ˜¯æŒ‰ä»¥ä¸‹è¿‡ç¨‹ï¼š</p>
<p><code>Parse =&gt; Find =&gt; Create =&gt; Update =&gt; Print</code></p>
<ol>
<li><strong>Parse</strong>: SourceCode =&gt; AST ï¼ˆTree Nodes)</li>
<li><strong>Find</strong>: Find the Nodes we want to replace         // Transform</li>
<li><strong>Create</strong>: Create the New Nodes we want to insert  // Transform</li>
<li><strong>Update</strong>: Update the AST at the right location    // Transform</li>
<li><strong>Print</strong>: Print it back into JavaScript Source with proper formatting and should like human wrote this.</li>
</ol>
<h3 id="-parse-ast-">ç¬¬ä¸€æ­¥ï¼Œå°†æºä»£ç è§£æ (parse) æˆ AST.</h3>
<p>ç°åœ¨æˆ‘ä»¬å…ˆå›åˆ°è¯­è¨€çš„æœ¬è´¨ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“è‡ªç„¶è¯­è¨€ï¼ˆNatural Language)ï¼Œæ— è®ºä»€ä¹ˆè¯­ç§ï¼Œéƒ½ä¼šæœ‰ã€Œä¸»è¯­ã€ã€ŒåŠ¨è¯ã€ã€Œå®¾è¯­ã€ã€Œæ ‡ç‚¹ç¬¦å·ã€æ¥æè¿°ä¸€ä¸ªç°å®ä¸–ç•Œæ‰€å‘ç”Ÿçš„äº‹ä»¶ã€‚</p>
<p>è€Œåœ¨è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ (Programming Language)ï¼Œæ— è®ºä»€ä¹ˆè¯­ç§ï¼Œéƒ½ä¼šæœ‰ã€Œç±»å‹ã€ã€Œè¿ç®—ç¬¦ã€ã€Œæµç¨‹è¯­å¥ã€ã€Œå‡½æ•°ã€ã€Œå¯¹è±¡ã€ç­‰æ¦‚å¿µæ¥è¡¨è¾¾è®¡ç®—æœºä¸­å­˜åœ¨å†…å­˜ä¸­çš„0å’Œ1ï¼Œä»¥åŠèƒŒåè¿ç®—ä¸é€»è¾‘ã€‚</p>
<p>ä¸åŒçš„è¯­è¨€ï¼Œéƒ½ä¼šé…ä¹‹ä¸åŒçš„<strong>è¯­æ³•åˆ†æå™¨</strong>ï¼ˆparserï¼‰ã€‚</p>
<p>å¯¹äºè‡ªç„¶è¯­è¨€ï¼Œæˆ‘ä»¬çš„å¤§è„‘å°±æ˜¯ä¸€ä¸ª Parserã€‚å¯¹äºç¼–ç¨‹è¯­è¨€ï¼Œè¯­æ³•åˆ†æå™¨æ˜¯æŠŠæºä»£ç ä½œä¸ºå­—ç¬¦ä¸²è¯»å…¥ã€è§£æï¼Œå¹¶å»ºç«‹è¯­æ³•æ ‘çš„ç¨‹åºã€‚</p>
<p>ä»€ä¹ˆæ˜¯<strong>è¯­æ³•æ ‘</strong>ï¼Ÿæ‘˜è‡ª Wiki ä¸€æ®µï¼š</p>
<blockquote>
<p>è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax tree æˆ–è€…ç¼©å†™ä¸º ASTï¼‰ï¼Œæˆ–è€…è¯­æ³•æ ‘ï¼ˆsyntax treeï¼‰ï¼Œæ˜¯æºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç°å½¢å¼ï¼Œè¿™é‡Œç‰¹æŒ‡ç¼–ç¨‹è¯­è¨€çš„æºä»£ç ã€‚æ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚ä¹‹æ‰€ä»¥è¯´è¯­æ³•æ˜¯ã€ŒæŠ½è±¡ã€çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„è¯­æ³•å¹¶ä¸ä¼šè¡¨ç¤ºå‡ºçœŸå®è¯­æ³•ä¸­å‡ºç°çš„æ¯ä¸ªç»†èŠ‚ã€‚</p>
</blockquote>
<p>è¿™ä¹ˆè¯´å…¶å®è¿˜æ˜¯æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬å…ˆæ‰“å¼€ <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">wiki</a> çœ‹åˆ° wikipedia è¿™ä¸ªå›¾ï¼Œ</p>
<p><img src="../content/images/codemod_ast/ast_tree.png" alt="AST Tree"></p>
<p>å‰ç«¯er ä¸€å®šä¼šè§‰å¾—å¾ˆç›¸ä¼¼ï¼Œè¿™é‡Œä¸å°±æ˜¯ DOM è¯­æ³•æ ‘çš„ç»ˆææŠ½è±¡ç‰ˆæœ¬å—ï¼Œåªæ˜¯æŠŠä¸€ä¸ªä¸ª DOM Nodes æ¢æˆäº†ä¸€ä¸ªä¸ªæ›´åŠ æ— è¯­ä¹‰çš„å­—ç¬¦ Tokenã€‚</p>
<p>FB æœ‰ä¸€ä¸ªå¾ˆæ£’çš„å·¥å…· <a href="http://astexplorer.net/">ASTExplorer</a>ï¼Œå¯ä»¥ç”¨æ¥æ›´å½¢è±¡åœ°å±•ç¤ºã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬ç°åœ¨å°±åªæœ‰ä¸€ä¸ªå¾ˆç®€å•çš„è¡¨è¾¾å¼<code>a+b</code>ï¼Œè¿™é‡Œæ˜¯ recast Parser è§£æåçš„ AST ç»“æ„ï¼š</p>
<p><img src="../content/images/codemod_ast/a+b_ast_tree.png" alt="a + b AST Tree"></p>
<p>çœ‹ä¸Šå»ç‰¹åˆ«å¤æ‚ã€‚æ³¨æ„é‚£äº›è“è‰²å­—ä½“ <code>File</code>, <code>Programme</code>,<code>ExpressionStatement</code>,<code>Identifier</code>â€¦ è¿™äº›éƒ½æ˜¯ AST Nodesï¼Œå…¶ä»–çš„éƒ½æ˜¯å’Œè¿™ä¸ª Node ç›¸å…³çš„æ•°æ®ã€‚</p>
<p>æ ¹æ®å‰æ–‡å¯ä»¥çŸ¥é“ï¼Œæ¯ç§è¯­è¨€çš„ AST éƒ½æ˜¯ä¸åŒçš„ã€‚æœ‰ä¸“é—¨çš„ Parser æ¥ç”Ÿæˆ ASTã€‚</p>
<p>å…³äº <a href="https://en.wikipedia.org/wiki/Parsing#Parser">Parser</a> åˆæ˜¯ä¸€é—¨å¾ˆæ·±çš„å­¦é—®äº†ã€‚</p>
<p>åœ¨ ASTExplorer.net ä¸Šå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤š parserï¼Œæ¯”è¾ƒè‘—åçš„æœ‰ <a href="https://github.com/jquery/esprima/blob/master/src/parser.ts">Esprima(jQuery)</a>ï¼ŒUglify-JS, Babylon(Babel), Acorn(Tern / Webpack), åŠ jscodeshift ä½¿ç”¨çš„ recastã€‚</p>
<p>è™½ç„¶æœ‰å¾ˆå¤š Parserï¼Œä½†æ˜¯åŸºæœ¬ä¸Šï¼Œä¸€ä¸ª parser çš„ç»“æ„éƒ½å·®ä¸å¤šï¼Œå¯¹æºä»£ç è¿›è¡Œè¯æ³•åˆ†æï¼Œç”Ÿæˆ Tokensï¼Œå¯¹ Tokens è¿›è¡Œè¯­æ³•åˆ†æï¼Œç„¶åç”Ÿæˆ ASTã€‚</p>
<p><img src="../content/images/codemod_ast/parser.png" alt="Parser"></p>
<p>å…·ä½“å¯ä»¥å‚è€ƒçœ‹ä¸‹ <a href="http://esprima.org/demo/parse.html#">Esprima Parse Demo</a>ã€‚</p>
<p>ç”Ÿæˆçš„ AST éƒ½éµå¾ªä¸€ä¸ªç»Ÿä¸€æ ‡å‡† <a href="https://github.com/estree/estree/blob/master/es5.md">ESTree</a> or <a href="parser API https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API">Mozilla SpiderMonkey</a>ï¼Œä¹Ÿå°±æ˜¯è¯´éƒ½ä¼šè¿”å›ä¸€ä¸ª ESTree Compatible ASTã€‚</p>
<h3 id="-ast-find-nodes-create-new-nodes-update-nodes-">ç¬¬äºŒä¸‰å››æ­¥ï¼Œå¯¹ç”Ÿæˆçš„ AST è¿›è¡Œæ“ä½œä¿®æ”¹ (Find Nodes &amp; Create New Nodes &amp; Update Nodes)</h3>
<p>Wiki æœ‰ä»‹ç»è¯´ï¼Œparse AST çš„ä»£ç åŸºæœ¬æ˜¯ä½¿ç”¨<code>Visitor Pattern</code>ï¼ˆæ¸¸å®¢æ¨¡å¼ï¼‰ï¼Œå¦‚ï¼š</p>
<pre class="hljs"><code><span class="hljs-comment">// recast</span>
<span class="hljs-keyword">var</span> ast = recast.parse(src);
recast.visit(ast, {
visitIdentifier: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-comment">// do something with path</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
});</code></pre><p>è¿™å…¶å®ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼ŒAST å°±æ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œç„¶åè§£æå®ƒçš„è¯å°±æ˜¯ä»¥ä¸€ä¸ªæ¸¸å®¢ä¸€æ ·éå†è¿™æ£µæ ‘ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªæ¨¡å¼åœ¨å‰ç«¯ä¸­è¿˜æ˜¯ç”¨å¾—æ¯”è¾ƒå°‘çš„ï¼Œæ‰€ä»¥ <code>js-codeshift</code> åŸºäº <a href="https://github.com/facebook/jscodeshift#collections-and-traversal">Collections</a> æ¦‚å¿µï¼Œå¾ˆè´´å¿ƒçš„ç»™è¿™äº› Parser API ç»§ç»­åŒ…äº†ä¸€å±‚ï¼Œæä¾›äº†ä¸€ä¸ªä¸ä¸€æ ·çš„å‰ç«¯å‹å¥½å‹ API.</p>
<pre class="hljs"><code><span class="hljs-comment">// jscodeshift</span>
<span class="hljs-tag">jscodeshift</span>(src)
    <span class="hljs-class">.find</span>(jscodeshift.Identifier)
      <span class="hljs-class">.forEach</span>(<span class="hljs-function">function</span>(path) {
      <span class="hljs-comment">// do something with path</span>
});

<span class="hljs-comment">// Provide jQuery-likely and F2E-friendly Syntax API</span>
<span class="hljs-comment">// Manipulate AST nodes conveniently.</span></code></pre><p>è¯»è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œä¸€ä¸‹å­è§‰å¾—åˆä¼¼æ›¾ç›¸è¯†ã€‚è¿™ä¸å°±å’Œä½¿ç”¨ <code>jQuery</code> æ“ä½œ DOM ä¸€æ ·å˜›ã€‚</p>
<p>å¯ä»¥å¯¹æ¯”ä¸‹ â€œæ™®é€š Parserâ€ ä¸ jscodeshift æ“çºµ AST çš„åŒºåˆ«ï¼š</p>
<p>å¯ä»¥çœ‹åˆ°å¦‚æœä½¿ç”¨ <a href="http://esprima.org/">esprima</a> ï¼ŒAST Traverse / Walk åŸºæœ¬æ˜¯ <code>visitor pattern</code>.
<a href="https://github.intra.douban.com/zhangbinliu/ast_demo/tree/esprima">https://github.intra.douban.com/zhangbinliu/ast_demo/tree/esprima</a></p>
<h3 id="-">ç¬¬äº”æ­¥ï¼Œè¾“å‡ºè½¬æ¢åçš„ä»£ç </h3>
<p>æ® jscodeshift åˆ›é€ è€…ä¹‹ä¸€ CPojer è¯´ï¼Œæ ¹æ®è½¬æ¢åçš„ ASTï¼Œä»¥åŠä¸€äº›è¾“å‡º <a href="https://github.com/benjamn/recast/blob/52a7ec3eaaa37e78436841ed8afc948033a86252/lib/options.js#L61">Options</a>ï¼ˆæ¯”å¦‚æ˜¯å¦å•å¼•å·ã€tab å®½åº¦æ˜¯å¤šå°‘ã€éœ€ä¸éœ€è¦å»æ‰å°¾éƒ¨åˆ†å·â€¦ï¼‰ï¼Œæ˜¯ä¸€ä¸ªæŒºå›°éš¾çš„è¿‡ç¨‹ã€‚</p>
<p>ä½†æ˜¯æœ€ç»ˆï¼Œjscodeshift çš„è¾“å‡º API å´ç®€æ´æ˜äº†ï¼Œåªè¦ä¸€è¡Œä»£ç å³å¯æå®šã€‚</p>
<pre class="hljs"><code><span class="hljs-class">.toSource</span>({<span class="hljs-attribute">quote</span>: <span class="hljs-string">&#39;single&#39;</span>}); <span class="hljs-comment">// sets strings to use single quotes in transformed code.</span></code></pre><p>ï¼ˆå…¶å® Recast åœ¨è¿™åšäº†<a href="(https://github.com/benjamn/recast/blob/master/lib/printer.js">å¤§é‡çš„å·¥ä½œ</a> )ï¼‰</p>
<p>ç»è¿‡è¿™äº”ä¸ªæ­¥éª¤ï¼Œä¸€æ¬¡ jscodeshift çš„è½¬æ¢è¿‡ç¨‹å°±ç®—å®Œæˆå•¦ã€‚</p>
<h2 id="demo-time-write-a-codemod-transform">DEMO TIME!  Write a codemod transform</h2>
<pre class="hljs"><code>jscodeshift -t &lt;transform.js&gt; /<span class="hljs-keyword">to</span>/<span class="hljs-type">file</span>/path</code></pre><p>æˆ‘ä»¬æ¥å†™<code>transform.js</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ æ‰“ç®—ä½¿ç”¨ jscodeshift å¯¹æºä»£ç è¿›è¡Œä½•ç§å˜æ¢ï¼Œè¿™é‡Œé¢å°±æ˜¯å˜æ¢å‡½æ•°ã€‚</p>
<p>ç°åœ¨è€ƒè™‘ä¸€ä¸ª ES5 -&gt; ES6 çš„ç»å…¸é—®é¢˜ï¼š</p>
<h4 id="problem-">Problem:</h4>
<p><code>
// Before
&#39;Hello, &#39; + name + &#39;, I am a string.&#39;
// After
<code>Hello, ${name}, I am a string.</code>
</code></p>
<h4 id="solution-">Solution:</h4>
<ol>
<li>Simplifyï¼Œ ç®€åŒ–é—®é¢˜ï¼Œè€ƒè™‘ä¸€ä¸ªæœ€ç®€å•çš„æƒ…å†µ</li>
</ol>
<p><code>
// Before
a + b
// After
<code>${a}${b}</code>
</code></p>
<p><code>a + b</code> AST:</p>
<p><img src="../content/images/codemod_ast/a+b_ast_tree.png" alt="`a + b` AST"></p>
<p><code>${a}${b}</code> AST:</p>
<p><img src="../content/images/codemod_ast/a+b_tmpl_ast.png" alt="`${a}${b}`"></p>
<p>å¯¹æ¯”ä¸¤ä¸ª AST å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬åªéœ€è¦</p>
<ol>
<li>è¯»å…¥éœ€è½¬æ¢çš„ä»£ç ï¼Œæ‰¾åˆ° <code>BinaryExpression</code></li>
<li>ä¿å­˜ <code>BinaryExpression</code> å·¦å³ä¸¤è¾¹çš„å€¼ï¼ˆnode.left &amp; node.right)</li>
<li>ç”Ÿæˆä¸€ä¸ªä¸º <code>TemlateLiteral</code> Nodeï¼Œ<code>quasis</code> æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸‰ä¸ª <code>TemplateElement</code> çš„æ•°ç»„ï¼Œ<code>cookde &amp; raw keys</code> éƒ½æ˜¯ <code>&#39;&#39;</code>ï¼Œ <code>expressions</code> æ˜¯ä¸€ä¸ªåŒ…å« node.left, node.right å€¼çš„æ•°ç»„ã€‚</li>
<li>ç„¶åå°†å®ƒè¿”å›è¾“å‡ºï¼›</li>
</ol>
<p>è¿™é‡Œè´´ä¸‹æˆ‘çš„ Solution Example:</p>
<ol>
<li><p><a href="http://astexplorer.net/#/gist/33b63b7dc8da6d9ea4936c631adc994d/7905ef5b30dfc0cb3c811af8a8960f11014ef402">http://astexplorer.net/#/gist/33b63b7dc8da6d9ea4936c631adc994d/7905ef5b30dfc0cb3c811af8a8960f11014ef402</a></p>
<pre class="hljs"><code><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transformer</span>(<span class="hljs-params">file, api</span>) </span>{
<span class="hljs-keyword">const</span> j = api.jscodeshift;
<span class="hljs-keyword">const</span> root = j(file.source)

<span class="hljs-keyword">const</span> toTempLiteral = (p) =&gt; {
 <span class="hljs-keyword">const</span> quasis = [
  j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-literal">false</span>),
  j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-literal">false</span>),
  j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-literal">true</span>),
 ]

 <span class="hljs-keyword">const</span> tempLiteral = j.templateLiteral(quasis, [p.node.left, p.node.right])

 <span class="hljs-keyword">return</span> tempLiteral
}

<span class="hljs-keyword">return</span> root
 .find(j.BinaryExpression, {operator : <span class="hljs-string">&#39;+&#39;</span>})
   .replaceWith(toTempLiteral)
 .toSource()
}</code></pre></li>
<li><p><a href="http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/55c4910295973b3a4d09770d94cec73d5096daa4">http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/55c4910295973b3a4d09770d94cec73d5096daa4</a></p>
</li>
</ol>
<pre class="hljs"><code><span class="hljs-literal">export</span> <span class="hljs-keyword">default</span> function transformer(file, api) {
  <span class="hljs-keyword">const</span> j = api.jscodeshift;
  <span class="hljs-keyword">const</span> root = j(file.source)

  <span class="hljs-keyword">const</span> toTempLiteral = (p) =&gt; {
    <span class="hljs-keyword">const</span> quasis = [
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">false</span>),
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">false</span>),
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">true</span>),
    ]

    <span class="hljs-keyword">const</span> extractNodes = (node) =&gt; {
     <span class="hljs-keyword">if</span> (node.type === <span class="hljs-string">&#39;BinaryExpression&#39;</span> &amp;&amp; node.<span class="hljs-literal">operator</span> === <span class="hljs-string">&#39;+&#39;</span>) {
         <span class="hljs-keyword">return</span> [...extractNodes(node.left), ...extractNodes(node.right)]
     }
     <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> [node] }
    }

    <span class="hljs-keyword">const</span> tempLiteral = j.templateLiteral(quasis, extractNodes(p.node))

    <span class="hljs-keyword">return</span> tempLiteral
  }

  <span class="hljs-keyword">return</span> root
    .find(j.BinaryExpression, {<span class="hljs-literal">operator</span> : <span class="hljs-string">&#39;+&#39;</span>})
      .replaceWith(toTempLiteral)
    .toSource()
}</code></pre><ol>
<li><a href="http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/cf3c898c5fe494d08a978dd1a3a3e56fc42828a8">http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/cf3c898c5fe494d08a978dd1a3a3e56fc42828a8</a></li>
</ol>
<pre class="hljs"><code><span class="hljs-literal">export</span> <span class="hljs-keyword">default</span> function transformer(file, api) {
  <span class="hljs-keyword">const</span> j = api.jscodeshift;
  <span class="hljs-keyword">const</span> root = j(file.source)

  <span class="hljs-keyword">const</span> toTempLiteral = (p) =&gt; {
    <span class="hljs-keyword">const</span> quasis = [
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">false</span>),
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">false</span>),
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">true</span>),
    ]

    <span class="hljs-keyword">const</span> extractNodes = (node) =&gt; {
     <span class="hljs-keyword">if</span> (node.type === <span class="hljs-string">&#39;BinaryExpression&#39;</span> &amp;&amp; node.<span class="hljs-literal">operator</span> === <span class="hljs-string">&#39;+&#39;</span>) {
         <span class="hljs-keyword">return</span> [...extractNodes(node.left), ...extractNodes(node.right)]
     }
     <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> [node] }
    }

    <span class="hljs-keyword">const</span> tempLiteral = j.templateLiteral(quasis, extractNodes(p.node))

    <span class="hljs-keyword">return</span> tempLiteral
  }

  <span class="hljs-keyword">return</span> root
    .find(j.BinaryExpression, {<span class="hljs-literal">operator</span> : <span class="hljs-string">&#39;+&#39;</span>})
      .replaceWith(toTempLiteral)
    .toSource()
}</code></pre><p>å®˜æ–¹æ²¡æœ‰å¤ªè¯¦ç»†çš„ transform ç¼–å†™æŒ‡å¯¼ï¼Œå¯ä»¥å¤šè°·æ­Œæˆ–è€…å­¦ä¹ å·²ç¼–å†™å¥½çš„ transformï¼š<code>react-codemod/tranform</code> æˆ–è€… <code>js-codemod/transform</code>ã€‚</p>
<p>æˆ‘ä¸ªäººè§‰å¾—å†™ JS-Codeshift Transform | Babel-Plugin æœ¬è´¨å…¶å®å°±æ˜¯å¯¹æ¯”ä¸¤æ£µè¯­æ³•æ ‘ï¼Œåƒè§£è°œä¸€æ ·ï¼Œçœ‹çœ‹å¦‚ä½•ã€Œåˆå¥½åˆå¿«ã€å˜æ¢æˆè¿™æ ·ã€‚</p>
<p>å‰©ä¸‹çš„ä¸€å¼€å§‹å¦‚ä½•è¯»å–æº JS ä»£ç å¹¶è§£ææˆè¯­æ³•æ ‘ï¼Œå…·ä½“åœ¨ AST ä¸Š traverse &amp; find &amp; create &amp; update ï¼ˆè¿™é‡Œæˆ‘çŒœæµ‹å…¶å®æ˜¯ä¸€ä¸ªé€’å½’éå†èŠ‚ç‚¹æ ‘çš„è¿‡ç¨‹ï¼Ÿï¼‰ï¼ŒåŠä¹‹åå¦‚ä½•æŒ‰ä¸€å®šçš„ code style ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„ä»£ç ï¼Œéƒ½æ˜¯é€æ˜ä¸”ä¸å…³å¿ƒçš„ã€‚</p>
<h2 id="-">æ€»ç»“ &amp; å¼€è„‘æ´</h2>
<ul>
<li><p>æ€»ç»“ä¸‹åŸºæœ¬å¤„ç†æµç¨‹ï¼š
<img src="../content/images/codemod_ast/process.png" alt="Process"></p>
</li>
<li><p>AST æ˜¯å¾ˆæœ‰ç”¨çš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µã€‚ä¸€æ—¦ä½ ç†è§£äº†è¿™äº›è§„åˆ™ï¼Œå”¯ä¸€çš„é™åˆ¶å°±æ˜¯è§£æå™¨å’Œä½ çš„æƒ³è±¡åŠ›ã€‚</p>
</li>
<li>çº¯ AST parse å¤ªè¿‡äºç†è®ºï¼Œæ—¢ç„¶æ˜¯å·¥ç¨‹å¸ˆï¼Œè¿˜æ˜¯éœ€è¦è‡ªå·±åŠ¨æ‰‹å†™ç‚¹ä»€ä¹ˆæ¥è§£å†³è‡ªå·±å®é™…é‡åˆ°çš„é—®é¢˜ã€‚</li>
<li>å¯ä»¥ç»§ç»­æ‹“å±•åˆ°ã€Œè¯­æ³•é«˜äº®ã€ã€ã€Œå…³é”®å­—åŒ¹é…ã€ã€ã€Œä»£ç æ ¼å¼åŒ–ã€ã€ã€Œä½œç”¨åŸŸåˆ¤æ–­ã€ã€ä»¥åŠã€Œä»£ç å‹ç¼©ã€ã€ã€ŒBabel æ’ä»¶ã€ç­‰ç­‰ã€‚</li>
<li>æ¸æ¸æ·±å…¥åº•å±‚è¿›è¡Œåˆ†æï¼Œè®©è‡ªå·±å¯¹è¿™é—¨è¯­è¨€æœ‰äº†æ›´å¤šã€æ›´æ·±å…¥çš„äº†è§£ï¼Œå¯ä»¥æ›´å¥½åœ°æˆä¸ºäº§å“ã€Œåˆ›é€ è€…ã€ï¼Œè€Œä¸å•çº¯æ˜¯ã€Œä½¿ç”¨è€…ã€ã€‚</li>
<li><strong>Write JavaScript that writes JavaScript! The best editor is JavaScript. Cool!</strong></li>
</ul>
<h2 id="-">æ€è€ƒ</h2>
<ul>
<li>å¯ä»¥åœ¨ä¸€ä¸ª codemod transform é‡Œé¢åŒæ—¶è¿›è¡Œä¸¤ä¸ªå˜æ¢å—ï¼Ÿä¸ªäººè§‰å¾—å¯èƒ½ä¼šå¾ˆå¤æ‚ä¸”æ•ˆæœä¸å¤ªå¥½ï¼Œå› ä¸ºæœ‰äº› transform å¹¶ä¸æ˜¯æ­£äº¤çš„ã€‚ğŸ¤”</li>
</ul>
<h2 id="refs-">Refs:</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=d0pOgY8__JM">CPojerâ€™s Talk</a></li>
<li><a href="https://medium.com/@cpojer/effective-javascript-codemods-5a6686bb46fb#.s5kdne4xl">Effective JavaScript Codemods</a></li>
<li><a href="https://survivejs.com/blog/codemod-interview/">Codemod Interview</a></li>
<li><a href="https://vramana.github.io/blog/2015/12/21/codemod-tutorial/">How to write a codemod</a> ç»“åˆ CPojerâ€™s Talk, è¿™ä¸ªè™½å¾ˆé•¿ä½†å¾ˆæœ‰ç”¨ï¼</li>
<li><a href="https://www.sitepoint.com/understanding-asts-building-babel-plugin/">Understanding Babel Plugin</a></li>
<li><a href="http://tech.meituan.com/abstract-syntax-tree.html">AST åœ¨ç¾å›¢çš„åº”ç”¨</a></li>
<li><a href="http://imweb.io/topic/57b13b4f93d9938132cc8dfd">imweb</a></li>
</ul>

        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="/author//" style="background-image: url(/content/images/avatar_zbl.jpg)"><span class="hidden">cool4zbl's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="/author//">cool4zbl</a></h4>

                    <p>ğŸ‘¾ Front End =&gt; Back End =&gt; âˆ</p>
                <div class="author-meta">
                    <span class="author-location icon-location">Beijing</span>
                    <span class="author-link icon-link"><a href="http://localhost:5000/author/ZBL">http://localhost:5000/author/ZBL</a></span>
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Fun%20with%20Codemod%20%26%20AST&amp;url=http://zhangbinliu.me/2017-02-15-fun-with-codemod-and-ast/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://zhangbinliu.me/2017-02-15-fun-with-codemod-and-ast/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://zhangbinliu.me/2017-02-15-fun-with-codemod-and-ast/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>


            <section itemprop="comment" class="post-comments">
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_config = function () {
                  this.page.url = 'http://zhangbinliu.me/2017-02-15-fun-with-codemod-and-ast/';
                  this.page.identifier = '11';
                };
                var disqus_shortname = 'zblsdoodle';
                (function() { // DON'T EDIT BELOW THIS LINE
                  var d = document, s = d.createElement('script');
                  s.async = true;
                  s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
                })();
              </script>
            </section>

        </footer>

    </article>
</main>

<aside class="read-next">
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="http://zhangbinliu.me">Doodles</a> &copy; 2017
            </section>
            <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a>
                &nbsp;&amp;&nbsp;
                <a href="https://github.com/cool4zbl/ghost-render">Ghost-render</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <script type="text/javascript" src="/assets/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- Baidu Statics -->
    <script>
        var _hmt = _hmt || []
            ; (function () {
                var hm = document.createElement('script')
                hm.src = 'https://hm.baidu.com/hm.js?0903b73655adcfdcf265110a12741a3c'
                var s = document.getElementsByTagName('script')[0]
                s.parentNode.insertBefore(hm, s)
            })()
    </script>
    <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-56185102-1', 'auto');
        ga('send', 'pageview');
    </script>

</body>

</html>