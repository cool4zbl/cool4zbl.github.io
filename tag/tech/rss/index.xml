<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[undefined - ZBL's Doodle]]></title><description><![CDATA[Thoughts, ideas]]></description><link>http://zhangbinliu.me/</link><generator>Ghost</generator><lastBuildDate>Tue, 08 Aug 2017 03:06:26 GMT</lastBuildDate><atom:link href="http://zhangbinliu.me/tag/undefined/rss/" rel="self" type="application/rss+xml"/><ttl>60</ttl><item><title><![CDATA[ä»åä¸ª React è¿·ä½ è®¾è®¡æ¨¡å¼è°ˆå¼€å»]]></title><description><![CDATA[<p>å¾ˆæ—©ä¹‹å‰å°±ä¸€ç›´åœ¨è¯»çš„ä¸€ç¯‡æ–‡ç« ï¼Œ<a href="https://hackernoon.com/10-react-mini-patterns-c1da92f068c5">10 ä¸ªReact Mini è®¾è®¡æ¨¡å¼</a>ï¼Œ</p>
<p>ä¸€è¾¹åš <code>Creator</code> é¡¹ç›®ï¼Œä¹Ÿä¸€è¾¹ç»ˆäºæŠŠå®ƒç²¾è¯»å®Œã€‚</p>
<p>ç»“åˆè‡ªå·±çš„å¼€å‘æ—¶å€™çš„é¡¹ç›®ç»éªŒï¼Œåšäº†ç‚¹ç¬”è®°ã€‚</p>
<p><code>Creator</code> é¡¹ç›®æ˜¯ä¸€ä¸ªå¤šç«¯ï¼ˆWeb + Mobileï¼‰React SPAï¼Œä¸”æœ‰ä¸€äº›è¡¨å•å¡«å†™å’Œå¤æ‚çš„äº¤äº’ç»„ä»¶ï¼Œè‡ªå·±å•ç‹¬å°è£…äº†ä¸€ä¸ªå¾ˆç®€å•çš„åŸºäºäº‹ä»¶çš„ <code>Store</code>ï¼Œå¼€å‘è¿‡ç¨‹ä¸­æ”¶è·å¾ˆå¤§ï¼Œè¿™äº›ç»†èŠ‚ä¹‹åå¯ä»¥ç»†è¯´ã€‚</p>
<p>åŸæ–‡ä½œè€…è¯´ä½ æ˜¯ä¸æ˜¯å¤©å¤©å†™ React, å†™ç€å†™ç€å‘ç°è‡ªå·±å¯èƒ½ç»å¸¸ç”¨æ¥å®ç°éœ€æ±‚çš„ï¼Œä¹Ÿæ€»æ˜¯é‚£ä¹ˆå‡ ä¸ªæ–¹æ³•ï¼Œå¾€å¤§äº†è®²å…¶å®å°±æ˜¯å¼€å‘ä¸­çš„ <strong>è®¾è®¡æ¨¡å¼</strong>ã€‚è¿™é‡Œæˆ‘ä»¬ç§°ä¸º <strong>Mini Patterns</strong>ã€‚</p>
<h2 id="-1-sending-data-down-and-up-">#1 Sending data down and up æ•°æ®æµ</h2>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*J5XOQh2WKIl0NFTAMvcVbQ.png" alt="Data-flow"></p>
<ul>
<li>React æ•°æ®æµ</li>
<li>ParentComponent  é€šè¿‡ <code>props</code> ä¼ ç»™ ChildComponent å€¼</li>
<li>ChildComponent é€šè¿‡ <code>props</code> ä¼ è¿‡æ¥çš„ä¸€äº› function å›è°ƒ parent çš„ä¸€äº›æ–¹æ³•ã€‚</li>
</ul>
<h2 id="-2-fixing-html-s-inputs">#2 Fixing HTMLâ€™s inputs</h2>
<blockquote>
<p>If Iâ€™m building a site that will have a lot of user inputs, one of the first things I do is fix this.</p>
<p>You donâ€™t need to keep working with the somewhat ass-about nature of HTMLâ€™s user input elements.</p>
</blockquote>
<p><img src="https://cdn-images-1.medium.com/max/800/1*WTUJjlFOOnetc5NpbykN0w.png" alt="User Inputs"></p>
<ul>
<li><p>å¦‚æœéœ€è¦æœ‰å¤§é‡ user inputsï¼Œæœ€å¥½æ˜¯è‡ªå·±å®ç°ä¸€å¥—ç›¸å…³ç»„ä»¶ã€‚</p>
</li>
<li><p>æ‰€ä»¥åœ¨ Creator ä¸­åŸºæœ¬è‡ªå·±å®ç°äº† <code>input</code>ï¼Œ<code>Select</code> ç­‰ç»„ä»¶ã€‚éœ€æ±‚ç®€å•æ‰€ä»¥å®ç°å¾—ä¹Ÿæ˜¯å¾ˆç®€å•ã€‚æ‰€ä»¥å…¶å® <code>Select</code> ç»„ä»¶ä»ç„¶éœ€è¦ä¼˜åŒ–ï¼Œæ¯”å¦‚è‡ªå®šä¹‰ <code>option</code> æ ·å¼ï¼Œå¤šé€‰ç­‰ç­‰ã€‚</p>
</li>
<li><p>Inputs should return a value via an <code>onChange</code> method, not a JavaScript <code>Event</code> instance, shouldnâ€™t they?</p>
</li>
<li><p>Input æœ€å¥½é€šè¿‡ <code>onChange</code> è¿”å›ä¸€ä¸ªå€¼ï¼Œè€Œä¸æ˜¯é€šè¿‡ä¸€ä¸ª JS <code>Event</code> å®ä¾‹ã€‚</p>
</li>
<li><p>You can go a step further and ensure that the data type returned in <code>onChange</code> matches the type passed in. If the <code>typeof props.value</code> is <code>number</code>, then convert <code>e.target.value</code> back to a number before sending the data out again.</p>
</li>
<li><p>åœ¨è¿”å› <code>onChange</code> çš„å€¼ä¹‹å‰ç¡®ä¿ä¸€ä¸‹æ˜¯ä¸æ˜¯å’Œè¾“å…¥çš„ç±»å‹åŒ¹é…ã€‚æ¯”å¦‚ <code>typeof props.value === &#39;number&#39;</code> çš„è¯ï¼Œåœ¨è¿”å› <code>e.target.value</code> å‰éœ€è¦ç¡®ä¿ä¹Ÿæ˜¯æ•°å­—ç±»å‹ã€‚</p>
</li>
<li><p>è¿™é‡Œé¡¹ç›®ä¸­æœ‰ä¸ªé€‰æ‹©è¯ä»¶ç±»å‹çš„ <code>Select</code>ï¼Œä¸åç«¯é»˜è®¤ èº«ä»½è¯ = 0 / æŠ¤ç…§ = 1ï¼Œä½†æ˜¯åœ¨ <code>e.target.value</code> æ—¶å€™å¿˜è®° convert äº†ã€‚æ‰€ä»¥è¿˜æ˜¯éœ€è¦è®°å¾—åˆ¤æ–­ä¸‹ <code>option</code> çš„å€¼ç±»å‹ã€‚</p>
<pre class="hljs"><code>let {<span class="hljs-keyword">name</span>, <span class="hljs-keyword">value</span>} = e.<span class="hljs-type">target</span>
<span class="hljs-keyword">value</span> = isNaN(<span class="hljs-keyword">Number</span>(<span class="hljs-keyword">value</span>)) ? <span class="hljs-keyword">value</span> : <span class="hljs-keyword">Number</span>(<span class="hljs-keyword">value</span>)</code></pre></li>
<li><p>A set of radio buttons is functionally the same thing as a <code>&lt;select&gt;</code>, right? Itâ€™s messed up to treat them in a completely different manner when the only difference is the UI. Maybe for your app it makes sense to have a single <code>&lt;PickOneFromMany /&gt;</code> component and pass either <code>ui=&quot;radio&quot;</code> or <code>ui=&quot;dropDown&quot;</code>.</p>
</li>
<li><p>ä¸€å †å•é€‰æŒ‰é’®åœ¨åŠŸèƒ½ä¸Šå’Œä¸€ä¸ª <code>&lt;select&gt;</code> ç»„ä»¶æ˜¯ä¸€æ ·çš„ã€‚æ²¡æœ‰å¿…è¦æŠŠå®ƒä»¬å®Œå…¨ä¸ä¸€æ ·åœ°æ¥å¯¹å¾…ï¼Œå› ä¸ºå®ƒä»¬ä»…ä»…æ˜¯ UI ä¸ä¸€æ ·ã€‚å…¶å®å¯èƒ½åªéœ€è¦ä¸€ä¸ª <code>&lt;PickOneFromMany /&gt;</code> ç»„ä»¶å°±å¥½ï¼Œé€šè¿‡ <code>ui=&quot;radio&quot;</code> æˆ–è€…<code>ui=&quot;dropdown&quot;</code> æ¥åŒºåˆ†ã€‚</p>
</li>
<li><p><strong>React Form ä¸ HTML çš„ä¸åŒ</strong></p>
<ul>
<li><code>value/checked</code> è®¾ç½®åç”¨æˆ·è¾“å…¥æ— æ•ˆï¼Œç›¸å½“äºè®¾ç½®äº† value -&gt; controlled component.</li>
<li><code>textarea</code> çš„å€¼è¦è®¾ç½®åœ¨ value å±æ€§</li>
<li><code>select</code> çš„<code>value</code> å±æ€§å¯ä»¥æ˜¯æ•°ç»„ï¼Œä¸å»ºè®®ä½¿ç”¨ <code>option</code> çš„ <code>selected</code> å±æ€§</li>
<li><code>input/textarea</code> çš„ <code>onChange</code> æ¯æ¬¡è¾“å…¥éƒ½ä¼šè§¦å‘ï¼Œå³ä½¿ä¸å¤±å»ç„¦ç‚¹</li>
<li><code>radio/checkbox</code>  ç‚¹å‡»åè§¦å‘ `onChange</li>
</ul>
</li>
</ul>
<h2 id="-3-binding-labels-to-inputs-with-unique-ids">#3 Binding labels to inputs with unique IDs</h2>
<blockquote>
<p>if you care about your users, youâ€™ll bind your <code>&lt;label&gt;</code> elements to your <code>&lt;input&gt;</code>s via an <code>id</code>/<code>for</code> combo.</p>
<p>You <em>could</em> generate a random ID for each input/label pair, but then your client-rendered HTML wonâ€™t match your server-rendered HTML. Checksum error! Thatâ€™s no good.</p>
<p>So, instead you can create a little module that gives an incrementing ID, and use that in an <code>Input</code> component like so:</p>
</blockquote>
<pre class="hljs"><code><span class="hljs-comment">// Input Component</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Input</span> <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> {</span>
  constructor(props) {
    <span class="hljs-keyword">super</span>(props);
    <span class="hljs-keyword">this</span>.id = getNextId();

    <span class="hljs-keyword">this</span>.onChange = <span class="hljs-keyword">this</span>.onChange.bind(<span class="hljs-keyword">this</span>);
  }

  onChange(e) {
    <span class="hljs-keyword">this</span>.props.onChange(e.target.value);
  }

  render() {
    <span class="hljs-keyword">return</span> (
      &lt;label htmlFor={<span class="hljs-keyword">this</span>.id}&gt;
        {<span class="hljs-keyword">this</span>.props.label}

        &lt;input
          id={<span class="hljs-keyword">this</span>.id}
          value={<span class="hljs-keyword">this</span>.props.value}
          onChange={<span class="hljs-keyword">this</span>.onChange}
          /&gt;
      &lt;/label&gt;
    );
  }
}

<span class="hljs-comment">// elementIdCreator.js</span>
let count = <span class="hljs-number">1</span>;

export const resetId = () =&gt; {
  count = <span class="hljs-number">1</span>;
}

export const getNextId = () =&gt; {
  <span class="hljs-keyword">return</span> <code>element-id-${count++}</code>;
}</code></pre><ul>
<li>è¿™é‡Œå¤§æ¦‚æ˜¯è‡ªåŠ¨ç»™ <code>label</code>/<code>input</code> åŠ ä¸Šä¸€å¯¹ä¸€çš„ id. å¯èƒ½æ˜¯ä¸ºäº†åœ¨è¡¨å•å¡«å†™çš„æ—¶å€™ç»™ç”¨æˆ·æ›´å¥½çš„ä½“éªŒå§ã€‚</li>
</ul>
<h2 id="-4-controlling-css-with-props">#4 Controlling CSS with props</h2>
<p>Three distinct ways to control the CSS applied to a component.</p>
<ol>
<li>Using themes. (Used in Proj Creator)</li>
</ol>
<p><code>&lt;Button theme=&quot;secondary&quot;&gt;Hello&lt;/Button&gt;</code></p>
<p>   Tip: Do your best to only require one theme per component.</p>
<p>   è¿™ç§å¯èƒ½é€‚åˆé¡µé¢ä¸»é¢˜å®šåˆ¶åŒ–ã€‚</p>
<p>   Creator ä¸­çš„ <code>&lt;Button /&gt;</code> æœ¬æ¥æ˜¯ç”¨ theme åšåŒºåˆ†ï¼Œä½†æ˜¯å¥½åƒè®¾è®¡é‚£è¾¹çœ‹èµ·æ¥å°±æ˜¯ä¸€ä¸ªä¸»é¢˜ï¼Œè±†ç“£ç»¿ç»å…¸æ¬¾ï¼Œæ‰€ä»¥åæ¥æ”¹ä¸ºäº†ä½¿ç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼ã€‚</p>
<p>   â€‹</p>
<ol>
<li>Using flags. (Used too.)</li>
</ol>
<p><code>&lt;Button theme=&quot;secondary&quot; rounded&gt;Hello&lt;/Button&gt;</code></p>
<p>   åœ¨é¡¹ç›®ä¸­è‡ªå·±å†™çš„ä¸€ä¸ª <code>Button</code> ç»„ä»¶ï¼š</p>
<p>   â€‹</p>
<pre class="hljs"><code> Button.propTypes = {
   size: PropTypes.oneOf([
     <span class="hljs-string">&#39;sm&#39;</span>,
     <span class="hljs-string">&#39;md&#39;</span>,
     <span class="hljs-string">&#39;lg&#39;</span>,
     <span class="hljs-string">&#39;row&#39;</span>
   ]),
   status: PropTypes.oneOf(<span class="hljs-built_in">Object</span>.values(BUTTON_STATUS)),
   type: PropTypes.oneOf([
     <span class="hljs-string">&#39;submit&#39;</span>,
     <span class="hljs-string">&#39;save&#39;</span>,
     <span class="hljs-string">&#39;cancel&#39;</span>
     ])
 }
 <span class="hljs-comment">// use className to control styles</span>
 <span class="hljs-keyword">const</span> cls = classNames(<span class="hljs-string">&#39;btn&#39;</span>, {
  [<span class="hljs-string"><code>&lt;span class=&quot;hljs-subst&quot;&gt;${prefixCls}&lt;/span&gt;-btn</code></span>]: <span class="hljs-literal">true</span>,
  [<span class="hljs-string"><code>&lt;span class=&quot;hljs-subst&quot;&gt;${prefixCls}&lt;/span&gt;-btn-&lt;span class=&quot;hljs-subst&quot;&gt;${size}&lt;/span&gt;</code></span>]: !!size,
  [<span class="hljs-string"><code>&lt;span class=&quot;hljs-subst&quot;&gt;${prefixCls}&lt;/span&gt;-btn-&lt;span class=&quot;hljs-subst&quot;&gt;${status}&lt;/span&gt;</code></span>]: !!status,
  [<span class="hljs-string"><code>&lt;span class=&quot;hljs-subst&quot;&gt;${prefixCls}&lt;/span&gt;-btn-&lt;span class=&quot;hljs-subst&quot;&gt;${type}&lt;/span&gt;</code></span>]: !!type
 }, props.className)</code></pre><ol>
<li><p>Setting values.</p>
<p>Pass the value of a CSS property directly. (set it as an inline style)</p>
</li>
</ol>
<p><code>&lt;Icon width=&quot;25&quot; height=&quot;25&quot; type=&quot;search&quot; /&gt;</code></p>
<p><strong>ä¸¾ä¸ªæ —å­</strong></p>
<p>   <img src="https://cdn-images-1.medium.com/max/800/1*Kx1jOQONhFZPnGe72Fd4tQ.png" alt="creating-a-link-component"></p>
<pre class="hljs"><code><span class="hljs-comment">// Link.js</span>
<span class="hljs-keyword">const</span> Link = (props) =&gt; {
 <span class="hljs-keyword">let</span> className = <code>link link--${props.theme}-theme</code>;

 <span class="hljs-keyword">if</span> (!props.underline) className += <span class="hljs-string">&#39; link--no-underline&#39;</span>;

 <span class="hljs-keyword">return</span> &lt;a href={props.href} className={className}&gt;{props.children}&lt;/a&gt;;
};

Link.propTypes = {
 theme: PropTypes.oneOf([
   <span class="hljs-string">&#39;default&#39;</span>, <span class="hljs-comment">// primary color, no underline</span>
   <span class="hljs-string">&#39;blend&#39;</span>, <span class="hljs-comment">// inherit surrounding styles</span>
   <span class="hljs-string">&#39;primary-button&#39;</span>, <span class="hljs-comment">// primary color, solid block</span>
 ]),
 underline: PropTypes.<span class="hljs-keyword">bool</span>,
 href: PropTypes.<span class="hljs-keyword">string</span>.isRequired,
 children: PropTypes.oneOfType([
   PropTypes.element,
   PropTypes.array,
   PropTypes.<span class="hljs-keyword">string</span>,
 ]).isRequired,
};

Link.defaultProps = {
 theme: <span class="hljs-string">&#39;default&#39;</span>,
 underline: <span class="hljs-keyword">false</span>,
};</code></pre><pre class="hljs"><code><span class="hljs-comment">// Link.css</span>
<span class="hljs-class">.link--default-theme</span>,
<span class="hljs-class">.link--blend-theme</span><span class="hljs-pseudo">:hover</span> {
 <span class="hljs-attribute">color</span>: <span class="hljs-hexcolor">#D84315</span>;
}

<span class="hljs-class">.link--blend-theme</span> {
 <span class="hljs-attribute">color</span>: inherit;
}

<span class="hljs-class">.link--default-theme</span><span class="hljs-pseudo">:hover</span>,
<span class="hljs-class">.link--blend-theme</span><span class="hljs-pseudo">:hover</span> {
 <span class="hljs-attribute">text-decoration</span>: underline;
}

<span class="hljs-class">.link--primary-button-theme</span> {
 <span class="hljs-attribute">display</span>: inline-block;
 <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">25px</span>;
 <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
 <span class="hljs-attribute">background</span>: <span class="hljs-hexcolor">#D84315</span>;
 <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-class">.link--no-underline</span> {
 <span class="hljs-attribute">text-decoration</span>: none;
}</code></pre><p>â€‹</p>
<blockquote>
<p>JavaScript is easy, but with CSS you pay for your sinsâ€Šâ€”â€Šonce youâ€™ve started a mess, itâ€™s not easy to back out of.</p>
<p>True fact: fighting CSS specificity is the number one cause of death among web developers.</p>
</blockquote>
<p>   å—¯ï¼Œè¿™é‡ŒåŸæ–‡ä½œè€…ç”¨ CSS specificity ä¼˜å…ˆçº§ä¸¾äº†ä¸ªä¾‹å­ã€‚æ¯”å¦‚ä»–è¯´ä½ ç°åœ¨å¯ä»¥å»çœ‹çœ‹ medium é¡¶ç«¯å¯¼èˆªä¸Šå¤§ Title çš„CSS æ ·å¼ï¼Œ</p>
<blockquote>
<p>just guess how many CSS rules are combined to make this round circle with a number in it?</p>
<p>Twenty three rules.</p>
<p>Thatâ€™s <em>not </em>including the styles inherited from eleven other rules.</p>
<p>The line-height alone is overridden nine times.</p>
</blockquote>
<p>   å…‰æ˜¯ <code>line-height</code> ç‰¹ä¹ˆçš„å°±é‡å†™äº†ä¹æ¬¡ï¼ï¼ï¼</p>
<p>   <img src="https://cdn-images-1.medium.com/max/800/1*lQzlIf8PPqeLUS5VOvTH4Q.png" alt="line-height-css-rules"></p>
<p>   â€‹</p>
<p>   è¿™ line-height è¦æ˜¯ä¸€åªçŒ«çš„è¯ï¼Œç°åœ¨ä¹Ÿæ—©æ­»äº†å§ã€‚</p>
<p>   React çš„è¯ï¼Œå°±å¥½åŠäº†ã€‚</p>
<ul>
<li>æ§åˆ¶ç»„ä»¶çš„ classes ï¼›<ul>
<li>ç§»æ‰æ‰€æœ‰çš„å…¨å±€ resets ç„¶åéƒ½æŠŠå®ƒä»¬æ‰”åˆ° Button.scss ä¸­ï¼›</li>
<li>å¯ä»¥ç”¨ <code>all: unset</code> å»æ‰æ‰€æœ‰æµè§ˆå™¨åˆå§‹æ ·å¼ã€‚</li>
</ul>
</li>
</ul>
<h2 id="-5-the-switching-component">#5 The switching component</h2>
<p>The switching component, rendering one of many components.</p>
<blockquote>
<p>This may be a <code>&lt;Page&gt;</code> component that displays one of many pages. Or tabs in a tab set, or different modals in a modal component.</p>
</blockquote>
<pre class="hljs"><code><span class="hljs-keyword">import</span> HomePage <span class="hljs-keyword">from</span> <span class="hljs-string">&#39;./HomePage.jsx&#39;</span>;
<span class="hljs-keyword">import</span> AboutPage <span class="hljs-keyword">from</span> <span class="hljs-string">&#39;./AboutPage.jsx&#39;</span>;
<span class="hljs-keyword">import</span> UserPage <span class="hljs-keyword">from</span> <span class="hljs-string">&#39;./UserPage.jsx&#39;</span>;
<span class="hljs-keyword">import</span> FourOhFourPage <span class="hljs-keyword">from</span> <span class="hljs-string">&#39;./FourOhFourPage.jsx&#39;</span>;

<span class="hljs-keyword">const</span> PAGES = {
  home: HomePage,
  about: AboutPage,
  user: UserPage,
};

<span class="hljs-keyword">const</span> Page = (props) =&gt; {
  <span class="hljs-keyword">const</span> Handler = PAGES[props.page] || FourOhFourPage;

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">Handler</span> {<span class="hljs-attribute">...props</span>} /&gt;</span>
};

Page.propTypes = {
    page: PropTypes.oneOf(Object.keys(PAGES)).isRequired,
};

// Usage

<span class="hljs-tag">&lt;<span class="hljs-title">Page</span> <span class="hljs-attribute">page</span>=<span class="hljs-value">&quot;home&quot;</span> /&gt;</span></span></code></pre><p>If you replace the keys <code>home</code>, <code>about</code> and <code>user</code> with <code>/</code>, <code>/about</code>, and <code>/user</code>, youâ€™ve got yourself half a router.</p>
<p>(Future post idea: removing <code>react-router</code>.)</p>
<p>è¿™é‡Œ Creator ä¸­è¿˜æ˜¯ä½¿ç”¨äº† <code>react-router</code> ä½œä¸º SPA è·¯ç”±ã€‚</p>
<p>ä¸ªäººè§‰å¾— <code>React</code>+ <code>react-router</code> + <code>webpack</code> è¿™æ ·çš„é¡¹ç›®ï¼Œå¼€å‘ä¸­ä½¿ç”¨ <code>HashRouter</code>ï¼Œæ—¢èƒ½ä½¿ç”¨ <code>location.hash = xxx</code> ä½œç»„ä»¶é—´æ— åˆ·æ–°è·³è½¬ï¼Œåˆèƒ½ä¿è¯æ‰“åŒ…åè·¯å¾„è®¿é—®æ­£ç¡®ï¼ˆé™¤éä½ å®åœ¨çœ‹ä¸æƒ¯ <code>/#/</code>ï¼Œæƒ³æŠŠå®ƒå¹²æ‰ï¼‰ã€‚</p>
<pre class="hljs"><code><span class="hljs-regexp">//</span> Route.jsx
import React from <span class="hljs-string">&#39;react&#39;</span>
import IntroPage from <span class="hljs-string">&#39;../Page/IntroPage&#39;</span>
import ApplyFormPage from <span class="hljs-string">&#39;../Page/ApplyFormPage&#39;</span>
import AddWorksPage from <span class="hljs-string">&#39;../Page/AddWorksPage&#39;</span>
import ApplyDonePage from <span class="hljs-string">&#39;../Page/ApplyDonePage&#39;</span>
import MyWorksPage from <span class="hljs-string">&#39;../Page/MyWorksPage&#39;</span>

const defaultHeader = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &lt;h1&gt;åˆ›ä½œè€…è®¤è¯ç”³è¯·&lt;/h1&gt;
const routes = [
  { <span class="hljs-attribute">path</span>: <span class="hljs-string">&#39;/&#39;</span>,
    <span class="hljs-attribute">exact</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attribute">header</span>: defaultHeader,
    <span class="hljs-attribute">main</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> (&lt;IntroPage /&gt;)
  },
  { <span class="hljs-attribute">path</span>: <span class="hljs-string">&#39;/apply/intro&#39;</span>,
    <span class="hljs-attribute">header</span>: defaultHeader,
    <span class="hljs-attribute">main</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> (&lt;IntroPage /&gt;)
  },
  { <span class="hljs-attribute">path</span>: <span class="hljs-string">&#39;/apply/step1&#39;</span>,
    <span class="hljs-attribute">header</span>: defaultHeader,
    <span class="hljs-attribute">main</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> (&lt;ApplyFormPage /&gt;)
  },
  { <span class="hljs-attribute">path</span>: <span class="hljs-string">&#39;/apply/step2&#39;</span>,
    <span class="hljs-attribute">header</span>: defaultHeader,
    <span class="hljs-attribute">main</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> (&lt;AddWorksPage /&gt;)
  },
  { <span class="hljs-attribute">path</span>: <span class="hljs-string">&#39;/apply/step3&#39;</span>,
    <span class="hljs-attribute">header</span>: defaultHeader,
    <span class="hljs-attribute">main</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> (&lt;ApplyDonePage /&gt;)
  },
  { <span class="hljs-attribute">path</span>: <span class="hljs-string">&#39;/myworks&#39;</span>,
    <span class="hljs-attribute">header</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &lt;h1&gt;ç®¡ç†æˆ‘çš„ä½œå“&lt;/h1&gt;,
    <span class="hljs-attribute">main</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> (&lt;MyWorksPage /&gt;)
  }
]
export default routes</code></pre><pre class="hljs"><code>// App.js
import {
  HashRouter,
  Route
} from &#39;react-router-dom&#39;
import routes from &#39;./Route&#39;

const App = () =&gt; (
  <span class="hljs-tag">&lt;<span class="hljs-title">HashRouter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">&#39;App&#39;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">&#39;creator-wrapper&#39;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">&#39;header&#39;</span>&gt;</span>
          { routes.map((route, index) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-title">Route</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">{index}</span> <span class="hljs-attribute">path</span>=<span class="hljs-value">{route.path}</span>
              <span class="hljs-attribute">exact</span>=<span class="hljs-value">{route.exact}</span>
              <span class="hljs-attribute">component</span>=<span class="hljs-value">{route.header}</span>
            /&gt;</span>
          )) }
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">&#39;main&#39;</span>&gt;</span>
          { routes.map((route, index) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-title">Route</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">{index}</span> <span class="hljs-attribute">path</span>=<span class="hljs-value">{route.path}</span>
              <span class="hljs-attribute">exact</span>=<span class="hljs-value">{route.exact}</span>
              <span class="hljs-attribute">component</span>=<span class="hljs-value">{route.main}</span> /&gt;</span>
          )) }
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        { isMobile ? Footer() : Sidebar() }
      <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">HashRouter</span>&gt;</span>
)</code></pre><h2 id="-6-reaching-into-a-component">#6 Reaching into a component</h2>
<h3 id="render">render</h3>
<p>React Virtual DOM ==&gt; render= =&gt; DOM</p>
<pre class="hljs"><code>ReactComponent render(
  ReactElement <span class="hljs-keyword">element</span>,
  DOMElement container,
  [<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callback</span>]</span>
)</code></pre><blockquote>
<p>Render a ReactElement into the DOM in the supplied <code>container</code> and return a <a href="more-about-refs.html">reference</a> to the component (or returns <code>null</code> for <a href="reusable-components.html#stateless-functions">stateless components</a>).</p>
<p><code>ReactDOM.render()</code> controls the contents of the container node you pass in. Any existing DOM elements inside are replaced when first called. Later calls use Reactâ€™s DOM diffing algorithm for efficient updates.</p>
</blockquote>
<ul>
<li><code>ReactElement</code> into DOM.</li>
<li>æœ‰çŠ¶æ€ç»„ä»¶ =&gt; <code>refs</code>ï¼Œæ— çŠ¶æ€ç»„ä»¶ =&gt; <code>null</code></li>
<li>ç»„ä»¶åˆæ¬¡æ¸²æŸ“ä¹‹åå†æ¬¡æ›´æ–°ï¼Œä¼šä½¿ç”¨ ReactDOM diffing algorithm</li>
<li>è£…è½½å®Œåï¼Œæ‰§è¡Œå›è°ƒ callback</li>
<li><code>ReactDOM.render()</code> ä¸ä¼šå½±å“ container nodeï¼Œåªä¼šå½±å“ container node çš„ children nodes. ï¼ˆå¯èƒ½æ˜¯è¢«è¦†ç›–æ›¿æ¢å•Š..ï¼‰</li>
</ul>
<pre class="hljs"><code>const myApp = &lt;App /&gt;   <span class="hljs-comment">// just a ReactElement.(a object)</span>

const myAppInstance = ReactDOM.<span class="hljs-function"><span class="hljs-title">render</span><span class="hljs-params">(&lt;App /&gt;, document.getElementById(<span class="hljs-string">&#39;root&#39;</span>)</span></span>)
myAppInstance.<span class="hljs-function"><span class="hljs-title">doSth</span><span class="hljs-params">()</span></span> <span class="hljs-comment">// The ref returned from ReactDOM.render</span></code></pre><p>è¿™é‡Œåˆ©ç”¨ <code>render</code> æ–¹æ³•å¾—åˆ°äº† App ç»„ä»¶çš„å®ä¾‹ï¼Œå°±å¯ä»¥ä½¿ç”¨å®ƒåšç‚¹ä»€ä¹ˆäº†ã€‚</p>
<p>ä½†æ˜¯å¦‚æœåœ¨ç»„ä»¶å†…ï¼ŒJSX å¹¶ä¸ä¼šè¿”å›ä¸€ä¸ªç»„ä»¶çš„å®ä¾‹ã€‚ç»„ä»¶å†…åªæ˜¯ä¸€ä¸ª ReactElementï¼Œå‘Šè¯‰ React åŠ è½½çš„ç»„ä»¶åº”è¯¥é•¿ä»€ä¹ˆæ ·ã€‚</p>
<blockquote>
<p>Keep in mind, however, that the JSX doesn&#39;t return a component instance! It&#39;s just a <strong>ReactElement</strong>: a lightweight representation that tells React what the mounted component should look like.</p>
</blockquote>
<p>æ‰€ä»¥å‡ºç°äº†ï¼š</p>
<h3 id="ref">ref</h3>
<p>ä¸€ä¸ªç¥å¥‡çš„å±æ€§ï¼Œ ä½†æ˜¯å¾ˆæœ‰ç”¨ã€‚æ„Ÿè§‰éƒ½å¯ä»¥ç‹¬ç«‹å†™ç¯‡æ–‡ç« æ¥å¥½å¥½ä»‹ç»äº†ã€‚</p>
<h4 id="the-ref-callback-attribute">The ref Callback Attribute</h4>
<ul>
<li>å¯ä»¥ç»™ä»»æ„ React ç»„ä»¶åŠ ä¸Š <code>ref</code> prop. ç»„ä»¶è¢«è°ƒç”¨æ—¶å€™ä¼šæ–°å»ºä¸€ä¸ªè¯¥ç»„ä»¶å®ä¾‹ï¼Œè€Œ <code>ref</code> ä¼šæŒ‡å‘è¿™ä¸ªå®ä¾‹ã€‚</li>
</ul>
<ul>
<li><p>å¯ä»¥æ˜¯ä¸€ä¸ª callback functionï¼Œä¼šåœ¨ç»„ä»¶åŠ è½½åç«‹å³æ‰§è¡Œã€‚</p>
<pre class="hljs"><code>// <span class="hljs-type">ES5</span>

render: function() {
  <span class="hljs-keyword">return</span> (
    &lt;<span class="hljs-type">TextInput</span>
      <span class="hljs-keyword">ref</span>={function(input) {
        <span class="hljs-keyword">if</span> (input != null) {
          input.focus();
        }
      }} /&gt;
  );
},

// <span class="hljs-keyword">or</span> <span class="hljs-type">ES6</span> arrow function way:
render() {
  <span class="hljs-keyword">return</span> &lt;<span class="hljs-type">TextInput</span> <span class="hljs-keyword">ref</span>={ c =&gt; this._input = c } /&gt;
}
componentDidMount() {
  this._input.focuse()
}</code></pre><p>â€‹</p>
</li>
</ul>
<blockquote>
<p> When attaching a ref to a DOM component like <code>&lt;div /&gt;</code>, you get the DOM node back; when attaching a ref to a composite component like <code>&lt;TextInput /&gt;</code>, you&#39;ll get the React class instance.</p>
</blockquote>
<ul>
<li><code>refs</code> in <code>ReactComponent</code> =&gt; å¾—åˆ° ReactComponent å®ä¾‹ï¼Œå°±å¯ä»¥è°ƒç”¨ç›¸å…³å®ä¾‹æ–¹æ³•äº†ï¼ˆç»§ç»­ findDOMNode(refs) å°±å¯ä»¥å¾—åˆ° DOM èŠ‚ç‚¹ï¼Œä½¿ç”¨ DOM æ–¹æ³•ï¼‰ã€‚</li>
<li><code>refs</code> in <code>DOM</code>  =&gt; å¾—åˆ° DOM èŠ‚ç‚¹ï¼Œå°±å¯ä»¥ä½¿ç”¨ DOM æ–¹æ³•ã€‚</li>
<li><em>Note:</em> Note that when the referenced component is unmounted and whenever the ref changes, the old ref will be called with <code>null</code> as an argument. This prevents memory leaks in the case that the instance is stored, as in the first example. Also note that when writing refs with inline function expressions as in the examples here, React sees a different function object each time so on every update, ref will be called with <code>null</code> immediately before it&#39;s called with the component instance.</li>
<li>ä¸ºé˜²æ­¢å†…å­˜æ³„éœ²ï¼Œå½“å¼•ç”¨ç»„ä»¶è¢«å¸è½½æˆ–è€… <code>ref</code> æ”¹å˜çš„æ—¶å€™ï¼Œ<code>ref = null</code>.</li>
<li>å¦‚æœç”¨ inline functionï¼Œå› ä¸ºæ¯æ¬¡éƒ½æ˜¯ä¸€ä¸ªä¸åŒçš„ function objectï¼Œæ‰€ä»¥å½“ç»„ä»¶æ¯æ¬¡æ›´æ–°çš„æ—¶å€™ï¼Œ<code>ref</code> éƒ½ä¼šè¢«è®¾ç½®ä¸º <code>null</code> ç›´åˆ°ç»„ä»¶å®ä¾‹å†æ¬¡è°ƒç”¨å®ƒã€‚</li>
</ul>
<h4 id="the-ref-string-attribute-legacy-">The ref String Attribute (*legacy)</h4>
<p>è¦è·å–ä¸€ä¸ª React ç»„ä»¶çš„å¼•ç”¨ï¼Œæ—¢å¯ä»¥ä½¿ç”¨ this æ¥è·å–å½“å‰ ReactComponentï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>ref</code> æ¥è·å–å­ç»„ä»¶çš„å¼•ç”¨ã€‚</p>
<pre class="hljs"><code>&lt;input <span class="hljs-keyword">ref</span>=<span class="hljs-string">&quot;myInput&quot;</span> /&gt;

// used <span class="hljs-keyword">in</span> componentDidMount()
<span class="hljs-keyword">var</span> input = this.refs.myInput;
<span class="hljs-keyword">var</span> inputValue = input.value;
<span class="hljs-keyword">var</span> inputRect = input.getBoundingClientRect();</code></pre><h4 id="refs-">refs ä½¿ç”¨</h4>
<ul>
<li>DOM æ“ä½œ</li>
</ul>
<blockquote>
<p>Performing DOM measurements almost always requires reaching out to a &quot;native&quot; component such as <code>&lt;input /&gt;</code> and accessing its underlying DOM node using a ref. Refs are one of the only practical ways of doing this reliably.</p>
</blockquote>
<ul>
<li>å¯¹äº <code>stateless component</code>ï¼Œ <code>findDOMNode()</code> &amp; <code>ref</code> è¿”å›çš„éƒ½æ˜¯ <code>null</code>ï¼Œå› ä¸ºå®ƒåªæ˜¯å‡½æ•°æ‰§è¡Œï¼Œå¹¶ä¸è¿”å›ä¸€ä¸ªå®ä¾‹ <code>a backing instance</code>ã€‚è¦ç”¨çš„è¯åªèƒ½è‡ªå·±å»æ‰‹åŠ¨åŒ…ä¸€å±‚ component.</li>
</ul>
<h4 id="an-example">An example</h4>
<p>Like adding <code>autofucus</code> to the input to pease your users in an easy way.</p>
<p>The React Way</p>
<pre class="hljs"><code><span class="hljs-comment">// Child Component</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Input</span> <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">Compnent</span> {</span>
  focus() {
    <span class="hljs-keyword">this</span>.input.focus()
  }
  render() {
    <span class="hljs-keyword">return</span> (
      &lt;input ref={(el)=&gt; <span class="hljs-keyword">this</span>.input = el} /&gt;
    )
  }
}

<span class="hljs-comment">// Parent Component</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignInModal</span> <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">Component</span> {</span>
  componentDidMount() {
    <span class="hljs-keyword">this</span>.<span class="hljs-type">InputComponent</span>.focus(); <span class="hljs-comment">// æ‹¿åˆ° Input ç»„ä»¶çš„å¼•ç”¨ï¼Œå°±å¯ä»¥è°ƒç”¨ Input ç»„ä»¶æ–¹æ³•</span>
  }

  render() {
    <span class="hljs-keyword">return</span> (
      &lt;div&gt;
        &lt;label&gt;<span class="hljs-type">User</span> name: &lt;/label&gt;
        &lt;<span class="hljs-type">Input</span>
          ref={comp =&gt; { <span class="hljs-keyword">this</span>.<span class="hljs-type">InputComponent</span> = comp; }}
        /&gt;
      &lt;/div&gt;
    )
  }
}</code></pre><h2 id="-7-almost-components">#7 Almost-components</h2>
<blockquote>
<p>Donâ€™t prematurely componentize. Components arenâ€™t like teaspoons; you <em>can </em>have too many.</p>
<p>What I am saying: â€œtake something that you <em>donâ€™t</em> think should be a component, and make it a bit more like its own component (if it can be).â€</p>
</blockquote>
<p>è®©é‚£äº›ä½ å¹¶ä¸è§‰å¾—å®ƒä»¬å¯ä»¥æ˜¯ä¸€ä¸ªç»„ä»¶çš„ä¸œè¥¿ï¼Œé•¿å¾—æ›´åƒç»„ä»¶ä¸€ç‚¹ï¼ˆå¦‚æœå®ƒå¯ä»¥çš„è¯ï¼‰ã€‚</p>
<h2 id="-8-components-for-formatting-text">#8 Components for formatting text</h2>
<p>ç”¨æ¥æ ¼å¼åŒ–çš„ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯ç»„ä»¶ä¹Ÿå¯ä»¥å·¥å…·åŒ–ã€‚</p>
<p>ä¸€èˆ¬å¼€å‘æ—¶å€™ä¼šæŠŠå·¥å…·å‡½æ•°éƒ½æ”¾åœ¨ <code>Utils.js</code> ä¸­ï¼Œè¿™é‡Œæä¾›äº†ä¸€ä¸ªç”¨ç»„ä»¶æ€æƒ³æ¥å†™å·¥å…·çš„æ€è·¯ï¼Œè¿˜çœŸæ˜¯ <strong>ä¸€åˆ‡çš†ç»„ä»¶</strong>ã€‚</p>
<pre class="hljs"><code><span class="hljs-comment">// Hereâ€™s a &lt;Price&gt; component that takes a number and returns a pretty string, with or without decimals and a â€˜$â€™ sign.</span>

<span class="hljs-keyword">const</span> Price = (props) =&gt; {
    <span class="hljs-keyword">const</span> price = props.children.toLocaleString(<span class="hljs-string">&#39;en&#39;</span>, {
      style: props.showSymbol ? <span class="hljs-string">&#39;currency&#39;</span> : undefined,
      currency: props.showSymbol ? <span class="hljs-string">&#39;USD&#39;</span> : undefined,
      maximumFractionDigits: props.showDecimals ? <span class="hljs-number">2</span> : <span class="hljs-number">0</span>,
    });

    <span class="hljs-keyword">return</span> &lt;span className={props.className}&gt;{price}&lt;/span&gt;
};

Price.propTypes = {
  className: React.PropTypes.string,
  children: React.PropTypes.number,
  showDecimals: React.PropTypes.<span class="hljs-built_in">bool</span>,
  showSymbol: React.PropTypes.<span class="hljs-built_in">bool</span>,
};

Price.defaultProps = {
  children: <span class="hljs-number">0</span>,
  showDecimals: <span class="hljs-keyword">true</span>,
  showSymbol: <span class="hljs-keyword">true</span>,
};

<span class="hljs-keyword">const</span> Page = () =&gt; {
  <span class="hljs-keyword">const</span> lambPrice = <span class="hljs-number">1234.567</span>;
  <span class="hljs-keyword">const</span> jetPrice = <span class="hljs-number">999999.99</span>;
  <span class="hljs-keyword">const</span> bootPrice = <span class="hljs-number">34.567</span>;

  <span class="hljs-keyword">return</span> (
    &lt;div&gt;
      &lt;p&gt;One lamb <span class="hljs-keyword">is</span> &lt;Price className=<span class="hljs-string">&quot;expensive&quot;</span>&gt;{lambPrice}&lt;/Price&gt;&lt;/p&gt;
      &lt;p&gt;One jet <span class="hljs-keyword">is</span> &lt;Price showDecimals={<span class="hljs-keyword">false</span>}&gt;{jetPrice}&lt;/Price&gt;&lt;/p&gt;
      &lt;p&gt;Those gumboots will <span class="hljs-literal">set</span> ya back &lt;Price showDecimals={<span class="hljs-keyword">false</span>} showSymbol={<span class="hljs-keyword">false</span>}&gt;{bootPrice}&lt;/Price&gt; bucks.&lt;/p&gt;
    &lt;/div&gt;
  );
};</code></pre><p>è¿™é‡Œå½“ç„¶å¯ä»¥å¾ˆç®€å•çš„ç”¨ <code>function</code> æ¥å®ç°ã€‚</p>
<pre class="hljs"><code><span class="hljs-comment">// could just easily use a function</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">numberToPrice</span><span class="hljs-params">(num, options = {})</span> </span>{
    <span class="hljs-keyword">const</span> showSymbol = options.showSymbol !== <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">const</span> showDecimals = options.showDecimals !== <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">return</span> num.toLocaleString(<span class="hljs-string">&#39;en&#39;</span>, {
      style: showSymbol ? <span class="hljs-string">&#39;currency&#39;</span> : <span class="hljs-literal">undefined</span>,
      currency: showSymbol ? <span class="hljs-string">&#39;USD&#39;</span> : <span class="hljs-literal">undefined</span>,
      maximumFractionDigits: showDecimals ? <span class="hljs-number">2</span> : <span class="hljs-number">0</span>,
    });
}

<span class="hljs-keyword">const</span> Page = () =&gt; {
  <span class="hljs-keyword">const</span> lambPrice = <span class="hljs-number">1234.567</span>;
  <span class="hljs-keyword">const</span> jetPrice = <span class="hljs-number">999999.99</span>;
  <span class="hljs-keyword">const</span> bootPrice = <span class="hljs-number">34.567</span>;

  <span class="hljs-keyword">return</span> (
    &lt;div&gt;
      &lt;p&gt;One lamb <span class="hljs-keyword">is</span> &lt;span className=<span class="hljs-string">&quot;expensive&quot;</span>&gt;{numberToPrice(lambPrice)}&lt;/span&gt;&lt;/p&gt;
      &lt;p&gt;One jet <span class="hljs-keyword">is</span> {numberToPrice(jetPrice, { showDecimals: <span class="hljs-literal">false</span> })}&lt;/p&gt;
      &lt;p&gt;Those gumboots will <span class="hljs-keyword">set</span> ya back {numberToPrice(bootPrice, { showDecimals: <span class="hljs-literal">false</span>, showSymbol: <span class="hljs-literal">false</span> })} bucks.&lt;/p&gt;
    &lt;/div&gt;
  );</code></pre><h2 id="-9-the-store-is-the-component-s-servant">#9 The store is the componentâ€™s servant</h2>
<p>ç”¨ <code>store</code> æ¥ç®¡ç†ç»„ä»¶å¤æ‚åº¦ã€‚</p>
<p>My suggestion:</p>
<ol>
<li>Work out the general structure of your components and the data they will require</li>
<li>Design your store to support those requirements</li>
<li>Do whatever you need to do to your incoming data to make it fit into the store.</li>
</ol>
<p>æ¨èä½¿ç”¨å•ä¸ªæ¨¡å—æ¥ç®¡ç†æ‰€æœ‰ Incoming dataï¼Œæ‰€æœ‰çš„æ•°æ®å¤„ç†æ”¾åœ¨ä¸€èµ·åšï¼Œå•å…ƒæµ‹è¯•ä»€ä¹ˆçš„ä¹Ÿå˜ç®€å•äº†ã€‚</p>
<pre class="hljs"><code><span class="hljs-comment">// react/redux way</span>

<span class="hljs-tag">fetch</span>(<span class="hljs-built_in"><code>/api/search?${queryParams}</code></span>)
  <span class="hljs-class">.then</span>(response =&gt; response.<span class="hljs-function">json</span>())
  <span class="hljs-class">.then</span>(normalizeSearchResultsApiData) <span class="hljs-comment">// the do-it-all data massager</span>
  <span class="hljs-class">.then</span>(normalData =&gt; {
      <span class="hljs-comment">// dispatch normalData to the store here</span>
});</code></pre><p><strong>å…³äºSPAæ•°æ®æµçš„ç®¡ç†ï¼Œæ¨èå¾é£åœ¨ QCon ä¸Šåˆ†äº«çš„ <a href="https://zhuanlan.zhihu.com/p/26426054">å•é¡µå¼•ç”¨çš„æ•°æ®æµæ–¹æ¡ˆæ¢ç´¢</a></strong></p>
<h2 id="-10-importing-components-without-relative-paths">#10 Importing components without relative paths</h2>
<p>Turn</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> Button <span class="hljs-keyword">from</span> <span class="hljs-string">&#39;../../../../Button/Button.jsx&#39;</span>;
<span class="hljs-keyword">import</span> Icon <span class="hljs-keyword">from</span> <span class="hljs-string">&#39;../../../../Icon/Icon.jsx&#39;</span>;
<span class="hljs-keyword">import</span> Footer <span class="hljs-keyword">from</span> <span class="hljs-string">&#39;../../Footer/Footer.jsx&#39;</span>;</code></pre><p>Into</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> {Button, Icon, Footer} <span class="hljs-keyword">from</span> <span class="hljs-string">&#39;Components&#39;</span>;</code></pre><p>è¿™æ ·å°±çœå»äº†ç›¸å¯¹è·¯å¾„çš„çƒ¦æ¼ï¼Œçµæ´»å¼•ç”¨ç»„ä»¶ã€‚</p>
<p>ä½¿ç”¨ <code>Webpack2</code> å¯ä»¥ç›´æ¥é…ç½®</p>
<pre class="hljs"><code><span class="hljs-regexp">//</span> exports all components wherever they are
<span class="hljs-regexp">//</span> <span class="hljs-attribute">Ref</span>: Webpack <span class="hljs-built_in">require</span>.context
<span class="hljs-regexp">//</span> <span class="hljs-attribute">https</span>:<span class="hljs-regexp">//</span>webpack.github.io/docs/context.html

<span class="hljs-regexp">//</span> ./{xxx}/yyy/index.js =&gt; import { yyy } from <span class="hljs-string">&#39;components&#39;</span>
const req = <span class="hljs-built_in">require</span>.context(<span class="hljs-string">&#39;.&#39;</span>, <span class="hljs-literal">true</span>, <span class="hljs-regexp">/.\/[^/</span>]+\<span class="hljs-regexp">/[^/</span>]+\<span class="hljs-regexp">/index.js$/</span>)

req.keys().forEach(<span class="hljs-function"><span class="hljs-params">(key)</span> =&gt;</span> {
  const componentName = key.replace(<span class="hljs-regexp">/^.+\/([^/</span>]+)\<span class="hljs-regexp">/index.js/</span>, <span class="hljs-string">&#39;$1&#39;</span>)
  <span class="hljs-built_in">module</span>.exports[componentName] = req(key).default
})</code></pre><p>Creator ä¸­å› ä¸ºç”¨çš„ <code>create-react-app</code> CLIï¼Œæ— æ³•è‡ªå·±é…ç½® Webpackï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ç”¨åˆ°...</p>
<p>ä»¥ä¸Šå°±æ˜¯ä¸€äº›ä½œè€…è®¤ä¸ºå¾ˆæœ‰ç”¨çš„ react å¼€å‘è¿·ä½ æ¨¡å¼ï¼Œè™½ç„¶æˆ‘æ¥è§¦ react å¾ˆä¹…äº†ï¼Œä½†æ˜¯é¡¹ç›®ä¸­å¼€å‘å°±æ˜¯å¼€å‘ï¼Œä¹Ÿç»å¸¸ <code>C-c/v</code> ç”Ÿæˆç»„ä»¶ï¼Œå´å¹¶æ²¡æœ‰æ²‰ä¸‹å¿ƒæ€è€ƒæ€»ç»“ä¸€äº›åŸºæœ¬çš„è®¾è®¡æ¨¡å¼ï¼Œä¹Ÿæ²¡æœ‰èŠ±æ—¶é—´å»äº†è§£å®ƒèƒŒåçš„åŸç†ï¼Œéœ€è¦å¥½å¥½åæ€ã€‚</p>
<p><strong>ä¸€åˆ‡çš†ç»„ä»¶ã€‚Just coding in react-way! </strong>ğŸ˜†</p>
]]></description><link>/2017-06-28-10-react-mini-patterns-note/index.html</link><guid isPermaLink="true">/2017-06-28-10-react-mini-patterns-note/index.html</guid><category><![CDATA[notes]]></category><category><![CDATA[frontend]]></category><category><![CDATA[tech]]></category><dc:creator><![CDATA[ZBL]]></dc:creator><pubDate>Tue, 27 Jun 2017 16:00:00 GMT</pubDate></item><item><title><![CDATA[Fun with Codemod & AST]]></title><description><![CDATA[<h2 id="tl-dr">TL;DR</h2>
<ul>
<li>Facebook ä¸ºäº†è§£å†³ã€Œå¤§å‹ä»£ç åº“ã€è¿ç§»ï¼ŒåŸºäº AST é€ äº†ä¸ªå·¥å…· <strong>Codemod</strong></li>
<li>åŸºäº Codemod åˆæ„å»ºäº† JavaScript ä»£ç è¿ç§»ä¸“ç”¨çš„å·¥å…· <strong>jscodeshift</strong> å’Œ <strong>React-codemod</strong></li>
<li>ç†è§£è¿™äº›å·¥å…·èƒŒåçš„åŸç†æœ‰åŠ©äºä»ä¸€ä¸ªå•çº¯çš„ã€ŒAPI ä½¿ç”¨è€…ã€å˜æˆä¸€ä¸ªå·¥ç¨‹å¸ˆèˆ¬çš„ã€Œåˆ›é€ è€…ã€</li>
<li>Demo Timeï¼Let&#39;s write a codemod</li>
<li>ä¸€äº›æœ‰ä»·å€¼çš„å‚è€ƒ</li>
</ul>
<hr>
<h2 id="-">èƒŒæ™¯</h2>
<p>ä½œä¸ºä¸€ä¸ªè‡ªä¿¡è€Œè‡ªè±ªçš„å‰ç«¯å¼„æ½®å„¿ï¼ˆF2Eï¼‰ï¼Œæˆ‘ä»¬æ€»æ˜¯å¸Œæœ›èƒ½å¤Ÿåœ¨è¿™ä¸ªæ¯å¤©éƒ½åœ¨é£é€Ÿè¿­ä»£çš„è¡Œä¸šï¼Œä¸æ—¶æ¸è¿›ã€‚
å‰ç«¯ä»¬æ˜¯ä¸€ç¾¤ä¸å®‰åˆ†çš„äººï¼Œå¤§å®¶å–œçˆ±æ–°æ¡†æ¶ã€æ–°è¯­æ³•ï¼Œè€Œ JavaScript ä¹Ÿæ˜¯ä¸€é—¨éå¸¸çµæ´»çš„è¯­è¨€ï¼Œå®ƒæä¾›ç»™æˆ‘ä»¬çš„ API ä¹Ÿåœ¨ä¸æ—¶æ¸è¿›ã€‚æ¯”å¦‚ï¼Œå½“ <code>ES2015 / ES2016 / ES2017â€¦</code> å‡ºæ¥çš„æ—¶å€™ï¼Œé‚£äº›æ–°è¯­æ³•ç³–ï¼Œç®€æ´æ¼‚äº®ï¼Œä¸”æ›´æ˜“äºç†è§£é€»è¾‘ï¼Œäºæ˜¯æˆ‘ä»¬éƒ½æƒ³å»å°è¯•ä¸‹ã€‚
ä½†æ˜¯å°è¯•å½’å°è¯•ï¼Œå¯¹äºæ–°é¡¹ç›®å°è¯•èµ·æ¥æˆæœ¬å¾ˆä½ï¼Œåªéœ€è¦æŠŠæ–°åŠŸèƒ½éƒ½ç”¨æ–°è¯­æ³•ç¼–å†™å°±å¥½ã€‚
è€Œåˆ›å»ºæ–°é¡¹ç›®çš„åŒæ—¶ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿåœ¨ç»´æŠ¤ç€ä¸€äº›å·²æœ‰çš„æ—§é¡¹ç›®ã€‚å¦‚æœä½ è¿˜å¹¶æ²¡æ€ä¹ˆç†å®ƒä»¬ï¼Œå¯èƒ½å®ƒä»¬è¿˜æ´»å¾—ä¸é”™ã€‚ä½†æ˜¯ä¸€æ—¦ PM å¿ƒæƒ…å¥½æƒ³åŠ ä¸ªæ–°åŠŸèƒ½ï¼Œæˆ–è€…ä½ å“ªå¤©å¿ƒæƒ…å¥½æƒ³å»æ›´æ–°ä¸‹ä»£ç åº“ï¼Œç„¶åçœ‹åˆ°è‡ªå·±ä¹‹å‰å†™çš„é‚£äº›ä»£ç ï¼Œé‚£äº›ç°åœ¨å…¶å®å¯ä»¥æ›´ä¼˜é›…æ¼‚äº®çš„ä»£ç ï¼Œæ˜¯ä¸æ˜¯æ‰‹é‡Œç‰¹ç—’ç—’ç‰¹æƒ³æŠŠå®ƒä»¬æ›´æ–°äº†ï¼Ÿ
æ‰§è¡ŒåŠ›å¼ºçš„å°ä¼™ä¼´å¯èƒ½è¯´å¹²å°±å¹²äº†ã€‚å—¯ï¼Œå°±å‡è®¾æˆ‘ä»¬æœ‰ä¸ªé¡¹ç›®ï¼Œé‡Œé¢ä½¿ç”¨çš„æ˜¯ç”¨<code>ES5</code> ç‰ˆ <code>React</code> ä½œä¸º <code>UI View</code>å±‚ï¼Œç„¶åå®ƒå¤§æ¦‚å››ä¸ªé¡µé¢<code>(Page)</code>ï¼Œæ¯ä¸ªé¡µé¢åŒ…å«å¤§æ¦‚å››ä¸ªç»„ä»¶<code>(Component)</code>ï¼Œç„¶åä½ ä»æŸä¸ªçœ‹èµ·æ¥æ¯”è¾ƒå°ã€ä¸å®¹æ˜“å‡ºé”™çš„<code>Component</code> å…¥æ‰‹ï¼Œå¼€å§‹ä¸€è¡Œä¸€è¡Œæ”¹å†™ä»£ç ï¼Œå—¯ï¼Œ<code>var React = require(&#39;reactâ€™)</code> æ”¹ä¸º <code>import React from &#39;reactâ€™</code>ï¼Œ <code>var API = â€˜/j/app/xxxâ€™</code> æ”¹ä¸º <code>const API = â€˜/j/app/xxxâ€™</code>ï¼Œ<code>var foo</code> æ”¹ä¸º <code>let foo</code>ï¼Œ<code>function () {â€¦}</code> æ”¹ä¸º <code>() =&gt; {â€¦}</code>ï¼Œ<code>module.exports = React.createClass({â€¦})</code> æ”¹ä¸º <code>export default class MyComponent extends React.Component {â€¦}</code> â€¦
å¤©å“ªï¼Œæœ‰å®Œæ²¡å®Œï¼Œä¸€ä¸ªç»„ä»¶æ”¹å®Œä¸‹æ¥ï¼Œä½ å·²ç»æ„Ÿåˆ°èº«ä½“è¢«æç©ºï¼Œæœ›äº†æœ› <code>Components</code> åˆ—è¡¨ï¼Œæ›´ä¸ç”¨è¯´ï¼Œé‡æ–° <code>build</code> è¿‡çš„æµ‹è¯•è¿˜æ²¡è¿‡ã€‚ä½ é™·å…¥äº†ç»æœ›...</p>
<p>é‚£ä¹ˆæœ‰æ²¡æœ‰æ›´å¿«ä¸€ç‚¹çš„åŠæ³•å‘¢ï¼Ÿ
ç¨å¾®æœ‰ç‚¹ç»éªŒçš„å‰ç«¯å„¿å¯èƒ½æƒ³åˆ°ã€Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ›¿æ¢ã€ã€‚Bash <code>Awk | Sed</code> å‘½ä»¤ï¼Œæˆ–è€… Vim <code>:%s/var/let/g</code>ã€‚å¯æ˜¯å¦‚æœéœ€è¦æœ‰äº›å˜é‡æ˜¯ <code>const</code> ç±»å‹ï¼Œæœ‰äº›æ˜¯ <code>let</code>ï¼Œè€Œæœ‰äº›ä¿æŒ <code>var</code> ä¸å˜æ€ä¹ˆåŠï¼Ÿå†æ¯”å¦‚è¯´ä»¥ä¸‹è¿™æ®µå¾ˆå¸¸è§çš„ä»£ç ï¼š</p>
<pre class="hljs"><code><span class="hljs-tag">merge</span>(a, {<span class="hljs-attribute">b</span>: <span class="hljs-number">1</span>}, c);  <span class="hljs-comment">// Old</span>

<span class="hljs-comment">// éœ€è¦å˜ä¸º</span>

({..<span class="hljs-class">.a</span>, <span class="hljs-tag">b</span>: <span class="hljs-tag">1</span>, ..<span class="hljs-class">.c</span>});  <span class="hljs-comment">// New</span></code></pre><p>è¿™é‡Œå…‰æ˜¯è¿™ä¸ªå‡½æ•°çš„ <code>arguments</code> å°±å¯èƒ½æœ‰å¤šç§å½¢å¼ï¼Œæ¯”å¦‚ <code>variable</code>ï¼Œä¸€ä¸ªåŒ¿åå‡½æ•°è¿”å›çš„ Object æˆ–è€… <code>Plain Object</code> é‚£ç§ã€‚
æ‰€ä»¥è¿™é‡Œå·²ç»ç›¸å½“äºæ˜¯ä¸€ä¸ª <code>Context-non-free</code> çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>ä¸Šä¸‹æ–‡è¯­ä¹‰</strong>å¾ˆé‡è¦ã€‚
è¿™æ ·çš„è¯ï¼Œæ— è®ºå†æ€ä¹ˆå¼ºå¤§çš„<code>RegExp</code> ä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚å› ä¸ºæ­£åˆ™çš„æœ¬è´¨ï¼Œå…¶å®æ˜¯æ ¹æ®ä¸€å®šçš„ <code>Pattern</code> æ¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œä½†æ˜¯åœ¨çœŸæ­£çš„ä»£ç é‡Œï¼Œæ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½æœ‰è¯­ä¹‰ï¼Œéƒ½æœ‰ä¸Šä¸‹æ–‡ï¼Œè¿™é‡Œçš„æ­£åˆ™è¡¨è¾¾å¼ä¼šæ—¢å¤æ‚åˆæ— ç”¨ã€‚
æ‰€ä»¥ï¼Œæˆ‘ä»¬å¾—<strong>å‡ä¸€ä¸ªç»´åº¦</strong>æ€è€ƒé—®é¢˜ã€‚</p>
<h2 id="codemod">Codemod</h2>
<p>å¯¹ã€Œä»£ç åº“çš„æ‰¹é‡è¿ç§»æ›´æ–°ã€ï¼Œå…¶å®ä¹Ÿæ˜¯ç¨‹åºå‘˜çš„ä¸€ä¸ªéœ€æ±‚ï¼Œæ‰€ä»¥ï¼Œå¾ˆæ„Ÿæ©åœ°ï¼Œå·²ç»æœ‰ä¸€ç¾¤æ‡’æƒ°åˆèªæ˜çš„ç¨‹åºå‘˜é€ å‡ºäº†å·¥å…·ï¼š<strong>Codemod</strong>ï¼Œå°†ã€Œå¤§å‹ä»“åº“ä»£ç çš„æ‰¹é‡è¿ç§»ã€è‡ªåŠ¨åŒ–ï¼Œçœæ—¶çœåŠ›ã€‚</p>
<p>å¥½å§ï¼Œæ‰€ä»¥ <strong>Codemod</strong> åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
å®˜æ–¹æ–‡æ¡£è¿™æ ·å†™ç€ï¼š</p>
<blockquote>
<p>Codemod is a tool/library to assist you with large-scale codebase refactors that can be partially automated but still require human oversight and occasional intervention.</p>
</blockquote>
<p>è¿™æ ·çœ‹æ¥ï¼Œå¯ä»¥å¾ˆå¥½çš„è§£å†³æˆ‘ä»¬çš„éœ€æ±‚äº†ã€‚
åŸºäº Codemodï¼Œåˆå‡ºç°äº†é’ˆå¯¹ JavaScript ä»£ç è¿ç§»çš„å·¥å…· <a href="https://github.com/facebook/jscodeshift">Facebook jscoodeshift</a>ï¼Œ
åŸºäº <strong>jscodeshift</strong>ï¼Œåˆæ„å»ºäº†è¿ç§»ä¸€èˆ¬ JavaScript ä»£ç ï¼ˆæ¯”å¦‚ ES5 -&gt; ES2015) çš„å·¥å…· <a href="https://github.com/cpojer/js-codemod">js-codemod</a> å’Œè¿ç§» React ç›¸å…³é¡¹ç›®çš„ <a href="https://github.com/reactjs/react-codemod">react-codemod</a>ã€‚</p>
<p>å—¯ï¼Œè¿™ä¹ˆçœ‹æ¥ï¼Œæˆ‘ä»¬çš„äº‹æƒ…å°±å˜å¾—å®¹æ˜“å¤šäº†ã€‚
æ ¹æ®ä¸Šé¢é‚£äº›å·¥å…·çš„å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="hljs"><code>&gt; npm i -g jscodeshift
&gt; git clone https:<span class="hljs-comment">//github.com/reactjs/react-codemod.git</span>
&gt; git clone https:<span class="hljs-comment">//github.com/cpojer/js-codemod.git</span>
&gt; jscodeshift -t react-codemod/transforms/<span class="hljs-keyword">class</span>.js --<span class="hljs-keyword">mixin</span>-<span class="hljs-keyword">module</span>-name=react-addons-<span class="hljs-keyword">pure</span>-render-<span class="hljs-keyword">mixin</span> --flow=<span class="hljs-literal">true</span> --<span class="hljs-keyword">pure</span>-component=<span class="hljs-literal">true</span> --remove-runtime-proptypes=<span class="hljs-literal">false</span> src/register/component/myComponent.jsx
&gt; jscodeshift -t js-codemod/transforms/no-vars.js ./src/register/component/myComponent.jsx</code></pre><p>ç„¶åï¼Œå†æ¬¡ <code>git status</code> ä¸€ä¸‹æˆ–è€…ç›´æ¥æ‰“å¼€åˆšæ‰ transform çš„ <code>myComponent.jsx</code> æ–‡ä»¶æŸ¥çœ‹ï¼Œä½ ä¼šå‘ç°ï¼ŒWowï¼Œç¥å¥‡èˆ¬ï¼Œä½ çš„ä»£ç éƒ½æˆä¸ºäº†å®ƒä»¬åº”è¯¥æˆä¸ºçš„æ ·å­ï¼</p>
<p>è¿™é‡Œæš‚æ—¶ä»¥æˆ‘ä¹‹å‰åšçš„ Accounts é¡¹ç›®ä¸ºä¾‹ï¼š
<a href="https://github.intra.douban.com/accounts/accounts/pull/553/files#diff-b2286efdea6a62288250264e82bd948b">https://github.intra.douban.com/accounts/accounts/pull/553/files#diff-b2286efdea6a62288250264e82bd948b</a></p>
<p>åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ <code>codemod</code>ï¼Œæ‰€ä»¥æ¯”è¾ƒè°¨æ…ï¼Œä¸€ä¸ªä¸€ä¸ª <code>component</code> æ¥ï¼›</li>
<li>å…ˆç”¨ <code>react-codemod</code> è½¬ï¼ŒæŠŠå¤§éƒ¨å¤´ä»£ç è¿ç§»ï¼›</li>
<li>ç„¶å <code>js-codemod</code> å°æ­¥æ›´æ–°æ•´ç†ï¼›</li>
<li>ç„¶åå†æ ¹æ®ä¸€äº›è‡ªå·±çš„ Code Style åšäº›ç»†èŠ‚ä¸Šçš„ä¿®æ”¹ã€‚æ¯”å¦‚ä½¿ç”¨ <code>standard-format</code> å·¥å…·æ ¼å¼åŒ–ä»£ç ï¼Œç¬¦åˆæˆ‘ä¸ªäººå†™çš„ä»£ç é£æ ¼ã€‚</li>
<li>æ¯•ç«Ÿ JS å¤ªè¿‡äºçµæ´»ï¼Œæ¯ä¸ªäººå†™ä»£ç æ—¶å€™é£æ ¼å’Œç»“æ„éƒ½æ˜¯å„å¼‚çš„ï¼Œæœ‰æ—¶å€™çš„è½¬æ¢è¿˜æ˜¯ä¼šå‡ºç°ä¸€äº›ä¸æƒ³è±¡ä¸­ä¸ä¸€è‡´çš„ç»“æœï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæ˜¯è¯´ä»ç„¶éœ€è¦äººå·¥å¹²é¢„ï¼Œæ‰€ä»¥ä¼šæ ¹æ® transform åçš„ç»“æœæ‰‹åŠ¨ä¿®æ”¹ä¸‹ä»£ç ç»†èŠ‚ï¼›</li>
<li>ä¸€åˆ‡ç»„ä»¶è¿ç§»å°±ç»ªï¼Œ<code>npm run test</code> æµ‹è¯•é€šè¿‡ä»¥åï¼Œé‡æ–° <code>build</code> è¿è¡Œ</li>
</ol>
<p>è¿™é‡Œæˆ‘æŠŠå·²æœ‰çš„åå‡ ä¸ªç»„ä»¶å’Œé¡µé¢æ–‡ä»¶ï¼Œå…¨éƒ¨ä½¿ç”¨ä¸Šé¢çš„å·¥å…·è¿›è¡Œäº†æ›´æ–°ã€‚
ç„¶åå½“ä½ é‡æ–° <code>build</code> åï¼Œä½ ä¼šå‘ç°æµ‹è¯•ä»ç„¶é€šè¿‡ï¼Œç»„ä»¶åŠŸèƒ½ä»ç„¶ workï¼Œä½†æ˜¯ä»£ç åº“å´æ˜¯ä½¿ç”¨æ–°è¯­æ³•ç³–è¿›è¡Œäº†å¤§è§„æ¨¡å½»å½»åº•åº•åœ°æ›´æ–°ï¼ç®€ç›´å¤ªç¥å¥‡äº†ï¼ğŸ¤“
é‚£ä¹ˆï¼Œå®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ
è¿™é‡Œå°±è¦å¥½å¥½æ·±ç©¶ä¸‹è¿™ä¸ªå·¥å…·äº†ã€‚</p>
<h2 id="jscodeshift">jscodeshift</h2>
<p>è®©æˆ‘ä»¬æ¥é‡æ–°è¯»ä¸€ä¸‹ jscodeshift çš„<a href="https://github.com/facebook/jscodeshift#jscodeshift-">æ–‡æ¡£</a>ã€‚</p>
<blockquote>
<p>jscodeshift is a toolkit for running codemods over multiple JS files. It provides:</p>
</blockquote>
<ul>
<li>A runner, which executes the provided transform for each file passed to it. It also outputs a summary of how many files have (not) been transformed.</li>
<li>A wrapper around recast, providing a different API. Recast is an AST-to-AST transform tool and also tries to preserve the style of original code as much as possible.</li>
</ul>
<p>é‚£ä¹ˆè¿™é‡Œå°±å‡ºç°äº†ä¸¤ä¸ªå…³é”®çš„æ¦‚å¿µï¼š<em>Runner</em> åŠ <em>AST</em>ã€‚</p>
<ul>
<li><strong>Runner</strong></li>
<li><blockquote>
<p>A runner/worker feature that can apply transforms to thousands of files in parallel.
-- <a href="https://medium.com/@cpojer/effective-javascript-codemods-5a6686bb46fb#.sg03sd9eq">CPojer Effective JavaScript Codemods</a></p>
</blockquote>
</li>
<li><p><strong>AST</strong>ï¼ŒAbstract Syntax Treeï¼ŒæŠ½è±¡è¯­æ³•åˆ†ææ ‘ã€‚</p>
</li>
</ul>
<p>ä¸ºäº†æ›´å¥½ç†è§£ä»¥ä¸Šæ¦‚å¿µï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ä¹‹å‰è¿è¡Œ jscodeshift å‘½ä»¤è¿‡ç¨‹ã€‚
æˆ‘ä»¬å…ˆæ˜¯æŠŠä¸€ä¸ªé‡Œé¢åŒ…å«äº† JS ä»£ç çš„æºæ–‡ä»¶ä¼ ç»™äº†å®ƒï¼Œç„¶åå®ƒè¯»å–äº†æºä»£ç ï¼Œåˆæ ¹æ®å†™å¥½çš„ <code>transform.js</code> å¯¹æºä»£ç è¿›è¡Œäº†ç›¸åº”çš„å˜æ¢ï¼Œæœ€åè¾“å‡ºäº†å˜æ¢åçš„ JS ä»£ç ï¼Œè¦†ç›–äº†åŸæ–‡ä»¶ã€‚
è¿™ä¸ªè¿‡ç¨‹ç®€å•çš„è¯´ï¼Œå°±æ˜¯ï¼š
<code>SourceCode =&gt; codemod =&gt; ObjectCode</code></p>
<p>é‚£ä¹ˆå†è¯¦ç»†ä¸€ç‚¹ï¼Œæ ¹æ® jscodeshift ä½œè€…ä¹‹ä¸€çš„ CPojer åœ¨ä¸€æ¬¡ JSConf ä¸Šå¯¹è¿™ä¸ªå·¥å…·çš„ä»‹ç»ï¼Œjscodeshift æ“ä½œåŸºæœ¬æ˜¯æŒ‰ä»¥ä¸‹è¿‡ç¨‹ï¼š
<code>Parse =&gt; Find =&gt; Create =&gt; Update =&gt; Print</code></p>
<ol>
<li><strong>Parse</strong>: SourceCode =&gt; AST ï¼ˆTree Nodes)</li>
<li><strong>Find</strong>: Find the Nodes we want to replace         // Transform</li>
<li><strong>Create</strong>: Create the New Nodes we want to insert  // Transform</li>
<li><strong>Update</strong>: Update the AST at the right location    // Transform</li>
<li><strong>Print</strong>: Print it back into JavaScript Source with proper formatting and should like human wrote this.</li>
</ol>
<h3 id="-parse-ast-">ç¬¬ä¸€æ­¥ï¼Œå°†æºä»£ç è§£æ (parse) æˆ AST.</h3>
<p>ç°åœ¨æˆ‘ä»¬å…ˆå›åˆ°è¯­è¨€çš„æœ¬è´¨ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“è‡ªç„¶è¯­è¨€ï¼ˆNatural Language)ï¼Œæ— è®ºä»€ä¹ˆè¯­ç§ï¼Œéƒ½ä¼šæœ‰ã€Œä¸»è¯­ã€ã€ŒåŠ¨è¯ã€ã€Œå®¾è¯­ã€ã€Œæ ‡ç‚¹ç¬¦å·ã€æ¥æè¿°ä¸€ä¸ªç°å®ä¸–ç•Œæ‰€å‘ç”Ÿçš„äº‹ä»¶ã€‚
è€Œåœ¨è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ (Programming Language)ï¼Œæ— è®ºä»€ä¹ˆè¯­ç§ï¼Œéƒ½ä¼šæœ‰ã€Œç±»å‹ã€ã€Œè¿ç®—ç¬¦ã€ã€Œæµç¨‹è¯­å¥ã€ã€Œå‡½æ•°ã€ã€Œå¯¹è±¡ã€ç­‰æ¦‚å¿µæ¥è¡¨è¾¾è®¡ç®—æœºä¸­å­˜åœ¨å†…å­˜ä¸­çš„0å’Œ1ï¼Œä»¥åŠèƒŒåè¿ç®—ä¸é€»è¾‘ã€‚</p>
<p>ä¸åŒçš„è¯­è¨€ï¼Œéƒ½ä¼šé…ä¹‹ä¸åŒçš„<strong>è¯­æ³•åˆ†æå™¨</strong>(parser)ã€‚</p>
<p>å¯¹äºè‡ªç„¶è¯­è¨€ï¼Œæˆ‘ä»¬çš„å¤§è„‘å°±æ˜¯ä¸€ä¸ª Parserã€‚</p>
<p>å¯¹äºç¼–ç¨‹è¯­è¨€ï¼Œè¯­æ³•åˆ†æå™¨æ˜¯æŠŠæºä»£ç ä½œä¸ºå­—ç¬¦ä¸²è¯»å…¥ã€è§£æï¼Œå¹¶å»ºç«‹è¯­æ³•æ ‘çš„ç¨‹åºã€‚</p>
<p>ä»€ä¹ˆæ˜¯<strong>è¯­æ³•æ ‘</strong>ï¼Ÿæ‘˜è‡ª Wiki ä¸€æ®µï¼š</p>
<blockquote>
<p>è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax tree æˆ–è€…ç¼©å†™ä¸º ASTï¼‰ï¼Œæˆ–è€…è¯­æ³•æ ‘ï¼ˆsyntax treeï¼‰ï¼Œæ˜¯æºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç°å½¢å¼ï¼Œè¿™é‡Œç‰¹æŒ‡ç¼–ç¨‹è¯­è¨€çš„æºä»£ç ã€‚æ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚ä¹‹æ‰€ä»¥è¯´è¯­æ³•æ˜¯ã€ŒæŠ½è±¡ã€çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„è¯­æ³•å¹¶ä¸ä¼šè¡¨ç¤ºå‡ºçœŸå®è¯­æ³•ä¸­å‡ºç°çš„æ¯ä¸ªç»†èŠ‚ã€‚</p>
</blockquote>
<p>è¿™ä¹ˆè¯´å…¶å®è¿˜æ˜¯æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬å…ˆæ‰“å¼€ <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">wiki</a> çœ‹åˆ° wikipedia è¿™ä¸ªå›¾ï¼Œ</p>
<p><img src="../content/images/codemod_ast/ast_tree.png" alt="AST Tree"></p>
<p>å‰ç«¯er ä¸€å®šä¼šè§‰å¾—å¾ˆç›¸ä¼¼ï¼Œè¿™é‡Œä¸å°±æ˜¯ DOM è¯­æ³•æ ‘çš„ç»ˆææŠ½è±¡ç‰ˆæœ¬å—ï¼Œåªæ˜¯æŠŠä¸€ä¸ªä¸ª DOM Nodes æ¢æˆäº†ä¸€ä¸ªä¸ªæ›´åŠ æ— è¯­ä¹‰çš„å­—ç¬¦ Tokenã€‚
FB æœ‰ä¸€ä¸ªå¾ˆæ£’çš„å·¥å…· <a href="http://astexplorer.net/">ASTExplorer</a>ï¼Œå¯ä»¥ç”¨æ¥æ›´å½¢è±¡åœ°å±•ç¤ºã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬ç°åœ¨å°±åªæœ‰ä¸€ä¸ªå¾ˆç®€å•çš„è¡¨è¾¾å¼<code>a+b</code>ï¼Œè¿™é‡Œæ˜¯ recast Parser è§£æåçš„ AST ç»“æ„ï¼š</p>
<p><img src="../content/images/codemod_ast/a+b_ast_tree.png" alt="a + b AST Tree"></p>
<p>çœ‹ä¸Šå»ç‰¹åˆ«å¤æ‚ã€‚æ³¨æ„é‚£äº›è“è‰²å­—ä½“ <code>File</code>, <code>Programme</code>,<code>ExpressionStatement</code>,<code>Identifier</code>â€¦ è¿™äº›éƒ½æ˜¯ AST Nodesï¼Œå…¶ä»–çš„éƒ½æ˜¯å’Œè¿™ä¸ª Node ç›¸å…³çš„æ•°æ®ã€‚</p>
<p>æ ¹æ®å‰æ–‡å¯ä»¥çŸ¥é“ï¼Œæ¯ç§è¯­è¨€çš„ AST éƒ½æ˜¯ä¸åŒçš„ã€‚æœ‰ä¸“é—¨çš„ Parser æ¥ç”Ÿæˆ ASTã€‚</p>
<p>å…³äº <a href="https://en.wikipedia.org/wiki/Parsing#Parser">Parser</a> åˆæ˜¯ä¸€é—¨å¾ˆæ·±çš„å­¦é—®äº†ã€‚</p>
<p>åœ¨ ASTExplorer.net ä¸Šå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤š parserï¼Œæ¯”è¾ƒè‘—åçš„æœ‰ <a href="https://github.com/jquery/esprima/blob/master/src/parser.ts">Esprima(jQuery)</a>ï¼ŒUglify-JS, Babylon(Babel), Acorn(Tern / Webpack), åŠ jscodeshift ä½¿ç”¨çš„ recastã€‚</p>
<p>è™½ç„¶æœ‰å¾ˆå¤š Parserï¼Œä½†æ˜¯åŸºæœ¬ä¸Šï¼Œä¸€ä¸ª parser çš„ç»“æ„éƒ½å·®ä¸å¤šï¼Œå¯¹æºä»£ç è¿›è¡Œè¯æ³•åˆ†æï¼Œç”Ÿæˆ Tokensï¼Œå¯¹ Tokens è¿›è¡Œè¯­æ³•åˆ†æï¼Œç„¶åç”Ÿæˆ ASTã€‚</p>
<p><img src="../content/images/codemod_ast/parser.png" alt="Parser"></p>
<p>å…·ä½“å¯ä»¥å‚è€ƒçœ‹ä¸‹ <a href="http://esprima.org/demo/parse.html#">Esprima Parse Demo</a>ã€‚
ç”Ÿæˆçš„ AST éƒ½éµå¾ªä¸€ä¸ªç»Ÿä¸€æ ‡å‡† <a href="https://github.com/estree/estree/blob/master/es5.md">ESTree</a> or <a href="parser API https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API">Mozilla SpiderMonkey</a>ï¼Œä¹Ÿå°±æ˜¯è¯´éƒ½ä¼šè¿”å›ä¸€ä¸ª ESTree Compatible ASTã€‚</p>
<h3 id="-ast-find-nodes-create-new-nodes-update-nodes-">ç¬¬äºŒä¸‰å››æ­¥ï¼Œå¯¹ç”Ÿæˆçš„ AST è¿›è¡Œæ“ä½œä¿®æ”¹ (Find Nodes &amp; Create New Nodes &amp; Update Nodes)</h3>
<p>Wiki æœ‰ä»‹ç»è¯´ï¼Œparse AST çš„ä»£ç åŸºæœ¬æ˜¯ä½¿ç”¨<code>Visitor Pattern</code>ï¼ˆæ¸¸å®¢æ¨¡å¼ï¼‰ï¼Œå¦‚ï¼š</p>
<pre class="hljs"><code><span class="hljs-comment">// recast</span>
<span class="hljs-keyword">var</span> ast = recast.parse(src);
recast.visit(ast, {
visitIdentifier: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
    <span class="hljs-comment">// do something with path</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
});</code></pre><p>è¿™å…¶å®ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼ŒAST å°±æ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œç„¶åè§£æå®ƒçš„è¯å°±æ˜¯ä»¥ä¸€ä¸ªæ¸¸å®¢ä¸€æ ·éå†è¿™æ£µæ ‘ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªæ¨¡å¼åœ¨å‰ç«¯ä¸­è¿˜æ˜¯ç”¨å¾—æ¯”è¾ƒå°‘çš„ï¼Œæ‰€ä»¥ <code>js-codeshift</code> åŸºäº <a href="https://github.com/facebook/jscodeshift#collections-and-traversal">Collections</a> æ¦‚å¿µï¼Œå¾ˆè´´å¿ƒçš„ç»™è¿™äº› Parser API ç»§ç»­åŒ…äº†ä¸€å±‚ï¼Œæä¾›äº†ä¸€ä¸ªä¸ä¸€æ ·çš„å‰ç«¯å‹å¥½å‹ API.</p>
<pre class="hljs"><code><span class="hljs-comment">// jscodeshift</span>
<span class="hljs-tag">jscodeshift</span>(src)
    <span class="hljs-class">.find</span>(jscodeshift.Identifier)
      <span class="hljs-class">.forEach</span>(<span class="hljs-function">function</span>(path) {
      <span class="hljs-comment">// do something with path</span>
});

<span class="hljs-comment">// Provide jQuery-likely and F2E-friendly Syntax API</span>
<span class="hljs-comment">// Manipulate AST nodes conveniently.</span></code></pre><p>è¯»è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œä¸€ä¸‹å­è§‰å¾—åˆä¼¼æ›¾ç›¸è¯†ã€‚è¿™ä¸å°±å’Œä½¿ç”¨ <code>jQuery</code> æ“ä½œ DOM ä¸€æ ·å˜›ã€‚</p>
<p>å¯ä»¥å¯¹æ¯”ä¸‹ â€œæ™®é€š Parserâ€ ä¸ jscodeshift æ“çºµ AST çš„åŒºåˆ«ï¼š</p>
<p>å¯ä»¥çœ‹åˆ°å¦‚æœä½¿ç”¨ <a href="http://esprima.org/">esprima</a> ï¼ŒAST Traverse / Walk åŸºæœ¬æ˜¯ <code>visitor pattern</code>.
<a href="https://github.intra.douban.com/zhangbinliu/ast_demo/tree/esprima">https://github.intra.douban.com/zhangbinliu/ast_demo/tree/esprima</a></p>
<h3 id="-">ç¬¬äº”æ­¥ï¼Œè¾“å‡ºè½¬æ¢åçš„ä»£ç </h3>
<p>æ® jscodeshift åˆ›é€ è€…ä¹‹ä¸€ CPojer è¯´ï¼Œæ ¹æ®è½¬æ¢åçš„ ASTï¼Œä»¥åŠä¸€äº›è¾“å‡º <a href="https://github.com/benjamn/recast/blob/52a7ec3eaaa37e78436841ed8afc948033a86252/lib/options.js#L61">Options</a>ï¼ˆæ¯”å¦‚æ˜¯å¦å•å¼•å·ã€tab å®½åº¦æ˜¯å¤šå°‘ã€éœ€ä¸éœ€è¦å»æ‰å°¾éƒ¨åˆ†å·â€¦ï¼‰ï¼Œæ˜¯ä¸€ä¸ªæŒºå›°éš¾çš„è¿‡ç¨‹ã€‚
ä½†æ˜¯æœ€ç»ˆï¼Œjscodeshift çš„è¾“å‡º API å´ç®€æ´æ˜äº†ï¼Œåªè¦ä¸€è¡Œä»£ç å³å¯æå®šã€‚</p>
<pre class="hljs"><code><span class="hljs-class">.toSource</span>({<span class="hljs-attribute">quote</span>: <span class="hljs-string">&#39;single&#39;</span>}); <span class="hljs-comment">// sets strings to use single quotes in transformed code.</span></code></pre><p>ï¼ˆå…¶å® Recast åœ¨è¿™åšäº†<a href="(https://github.com/benjamn/recast/blob/master/lib/printer.js">å¤§é‡çš„å·¥ä½œ</a> )ï¼‰</p>
<p>ç»è¿‡è¿™äº”ä¸ªæ­¥éª¤ï¼Œä¸€æ¬¡ jscodeshift çš„è½¬æ¢è¿‡ç¨‹å°±ç®—å®Œæˆå•¦ã€‚</p>
<h2 id="demo-time-write-a-codemod-transform">DEMO TIME!  Write a codemod transform</h2>
<pre class="hljs"><code>jscodeshift -t &lt;transform.js&gt; /<span class="hljs-keyword">to</span>/<span class="hljs-type">file</span>/path</code></pre><p>æˆ‘ä»¬æ¥å†™<code>transform.js</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ æ‰“ç®—ä½¿ç”¨ jscodeshift å¯¹æºä»£ç è¿›è¡Œä½•ç§å˜æ¢ï¼Œè¿™é‡Œé¢å°±æ˜¯å˜æ¢å‡½æ•°ã€‚</p>
<p>ç°åœ¨è€ƒè™‘ä¸€ä¸ª ES5 -&gt; ES6 çš„ç»å…¸é—®é¢˜ï¼š</p>
<h4 id="problem-">Problem:</h4>
<p><code>
// Before
&#39;Hello, &#39; + name + &#39;, I am a string.&#39;
// After
<code>Hello, ${name}, I am a string.</code>
</code></p>
<h4 id="solution-">Solution:</h4>
<ol>
<li>Simplifyï¼Œ è€ƒè™‘ä¸€ä¸ªæœ€ç®€å•çš„æƒ…å†µ</li>
</ol>
<p><code>
// Before
a + b
// After
<code>${a}${b}</code>
</code></p>
<p><code>a + b</code> AST:</p>
<p><img src="../content/images/codemod_ast/a+b_ast_tree.png" alt="`a + b` AST"></p>
<p><code>${a}${b}</code> AST:</p>
<p><img src="../content/images/codemod_ast/a+b_tmpl_ast.png" alt="`${a}${b}`"></p>
<p>å¯¹æ¯”ä¸¤ä¸ª AST å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬åªéœ€è¦</p>
<ol>
<li>è¯»å…¥éœ€è½¬æ¢çš„ä»£ç ï¼Œæ‰¾åˆ° <code>BinaryExpression</code></li>
<li>ä¿å­˜ <code>BinaryExpression</code> å·¦å³ä¸¤è¾¹çš„å€¼ï¼ˆnode.left &amp; node.right)</li>
<li>ç”Ÿæˆä¸€ä¸ªä¸º <code>TemlateLiteral</code> Nodeï¼Œ<code>quasis</code> æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸‰ä¸ª <code>TemplateElement</code> çš„æ•°ç»„ï¼Œ<code>cookde &amp; raw keys</code> éƒ½æ˜¯ <code>&#39;&#39;</code>ï¼Œ <code>expressions</code> æ˜¯ä¸€ä¸ªåŒ…å« node.left, node.right å€¼çš„æ•°ç»„ã€‚</li>
<li>ç„¶åå°†å®ƒè¿”å›è¾“å‡ºï¼›</li>
</ol>
<p>è¿™é‡Œè´´ä¸‹æˆ‘çš„ Solution Example:</p>
<ol>
<li><p><a href="http://astexplorer.net/#/gist/33b63b7dc8da6d9ea4936c631adc994d/7905ef5b30dfc0cb3c811af8a8960f11014ef402">http://astexplorer.net/#/gist/33b63b7dc8da6d9ea4936c631adc994d/7905ef5b30dfc0cb3c811af8a8960f11014ef402</a></p>
<pre class="hljs"><code><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transformer</span>(<span class="hljs-params">file, api</span>) </span>{
<span class="hljs-keyword">const</span> j = api.jscodeshift;
<span class="hljs-keyword">const</span> root = j(file.source)

<span class="hljs-keyword">const</span> toTempLiteral = (p) =&gt; {
 <span class="hljs-keyword">const</span> quasis = [
  j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-literal">false</span>),
  j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-literal">false</span>),
  j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-literal">true</span>),
 ]

 <span class="hljs-keyword">const</span> tempLiteral = j.templateLiteral(quasis, [p.node.left, p.node.right])

 <span class="hljs-keyword">return</span> tempLiteral
}

<span class="hljs-keyword">return</span> root
 .find(j.BinaryExpression, {operator : <span class="hljs-string">&#39;+&#39;</span>})
   .replaceWith(toTempLiteral)
 .toSource()
}</code></pre></li>
<li><p><a href="http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/55c4910295973b3a4d09770d94cec73d5096daa4">http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/55c4910295973b3a4d09770d94cec73d5096daa4</a></p>
</li>
</ol>
<pre class="hljs"><code><span class="hljs-literal">export</span> <span class="hljs-keyword">default</span> function transformer(file, api) {
  <span class="hljs-keyword">const</span> j = api.jscodeshift;
  <span class="hljs-keyword">const</span> root = j(file.source)

  <span class="hljs-keyword">const</span> toTempLiteral = (p) =&gt; {
    <span class="hljs-keyword">const</span> quasis = [
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">false</span>),
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">false</span>),
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">true</span>),
    ]

    <span class="hljs-keyword">const</span> extractNodes = (node) =&gt; {
     <span class="hljs-keyword">if</span> (node.type === <span class="hljs-string">&#39;BinaryExpression&#39;</span> &amp;&amp; node.<span class="hljs-literal">operator</span> === <span class="hljs-string">&#39;+&#39;</span>) {
         <span class="hljs-keyword">return</span> [...extractNodes(node.left), ...extractNodes(node.right)]
     }
     <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> [node] }
    }

    <span class="hljs-keyword">const</span> tempLiteral = j.templateLiteral(quasis, extractNodes(p.node))

    <span class="hljs-keyword">return</span> tempLiteral
  }

  <span class="hljs-keyword">return</span> root
    .find(j.BinaryExpression, {<span class="hljs-literal">operator</span> : <span class="hljs-string">&#39;+&#39;</span>})
      .replaceWith(toTempLiteral)
    .toSource()
}</code></pre><ol>
<li><a href="http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/cf3c898c5fe494d08a978dd1a3a3e56fc42828a8">http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/cf3c898c5fe494d08a978dd1a3a3e56fc42828a8</a></li>
</ol>
<pre class="hljs"><code><span class="hljs-literal">export</span> <span class="hljs-keyword">default</span> function transformer(file, api) {
  <span class="hljs-keyword">const</span> j = api.jscodeshift;
  <span class="hljs-keyword">const</span> root = j(file.source)

  <span class="hljs-keyword">const</span> toTempLiteral = (p) =&gt; {
    <span class="hljs-keyword">const</span> quasis = [
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">false</span>),
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">false</span>),
     j.templateElement({<span class="hljs-string">&quot;cooked&quot;</span>: <span class="hljs-string">&#39;&#39;</span>, <span class="hljs-string">&quot;raw&quot;</span>: <span class="hljs-string">&#39;&#39;</span>}, <span class="hljs-keyword">true</span>),
    ]

    <span class="hljs-keyword">const</span> extractNodes = (node) =&gt; {
     <span class="hljs-keyword">if</span> (node.type === <span class="hljs-string">&#39;BinaryExpression&#39;</span> &amp;&amp; node.<span class="hljs-literal">operator</span> === <span class="hljs-string">&#39;+&#39;</span>) {
         <span class="hljs-keyword">return</span> [...extractNodes(node.left), ...extractNodes(node.right)]
     }
     <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> [node] }
    }

    <span class="hljs-keyword">const</span> tempLiteral = j.templateLiteral(quasis, extractNodes(p.node))

    <span class="hljs-keyword">return</span> tempLiteral
  }

  <span class="hljs-keyword">return</span> root
    .find(j.BinaryExpression, {<span class="hljs-literal">operator</span> : <span class="hljs-string">&#39;+&#39;</span>})
      .replaceWith(toTempLiteral)
    .toSource()
}</code></pre><p>å®˜æ–¹æ²¡æœ‰å¤ªè¯¦ç»†çš„ transform ç¼–å†™æŒ‡å¯¼ï¼Œå¯ä»¥å¤šè°·æ­Œæˆ–è€…å­¦ä¹ å·²ç¼–å†™å¥½çš„ transformï¼š<code>react-codemod/tranform</code> æˆ–è€… <code>js-codemod/transform</code>ã€‚</p>
<p>æˆ‘ä¸ªäººè§‰å¾—å†™ JS-Codeshift Transform | Babel-Plugin æœ¬è´¨å…¶å®å°±æ˜¯å¯¹æ¯”ä¸¤æ£µè¯­æ³•æ ‘ï¼Œåƒè§£è°œä¸€æ ·ï¼Œçœ‹çœ‹å¦‚ä½•ã€Œåˆå¥½åˆå¿«ã€å˜æ¢æˆè¿™æ ·ã€‚</p>
<p>å‰©ä¸‹çš„ä¸€å¼€å§‹å¦‚ä½•è¯»å–æº JS ä»£ç å¹¶è§£ææˆè¯­æ³•æ ‘ï¼Œå…·ä½“åœ¨ AST ä¸Š traverse &amp; find &amp; create &amp; update ï¼ˆè¿™é‡Œæˆ‘çŒœæµ‹å…¶å®æ˜¯ä¸€ä¸ªé€’å½’éå†èŠ‚ç‚¹æ ‘çš„è¿‡ç¨‹ï¼Ÿï¼‰ï¼ŒåŠä¹‹åå¦‚ä½•æŒ‰ä¸€å®šçš„ code style ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„ä»£ç ï¼Œéƒ½æ˜¯é€æ˜ä¸”ä¸å…³å¿ƒçš„ã€‚</p>
<h2 id="-">æ€»ç»“ &amp; å¼€è„‘æ´</h2>
<ul>
<li><p>æ€»ç»“ä¸‹åŸºæœ¬å¤„ç†æµç¨‹ï¼š
<img src="../content/images/codemod_ast/process.png" alt="Process"></p>
</li>
<li><p>AST æ˜¯å¾ˆæœ‰ç”¨çš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µã€‚ä¸€æ—¦ä½ ç†è§£äº†è¿™äº›è§„åˆ™ï¼Œå”¯ä¸€çš„é™åˆ¶å°±æ˜¯è§£æå™¨å’Œä½ çš„æƒ³è±¡åŠ›ã€‚</p>
</li>
<li>çº¯ AST parse å¤ªè¿‡äºç†è®ºï¼Œæ—¢ç„¶æ˜¯å·¥ç¨‹å¸ˆï¼Œè¿˜æ˜¯éœ€è¦è‡ªå·±åŠ¨æ‰‹å†™ç‚¹ä»€ä¹ˆæ¥è§£å†³è‡ªå·±å®é™…é‡åˆ°çš„é—®é¢˜ã€‚</li>
<li>å¯ä»¥ç»§ç»­æ‹“å±•åˆ°ã€Œè¯­æ³•é«˜äº®ã€ã€ã€Œå…³é”®å­—åŒ¹é…ã€ã€ã€Œä»£ç æ ¼å¼åŒ–ã€ã€ã€Œä½œç”¨åŸŸåˆ¤æ–­ã€ã€ä»¥åŠã€Œä»£ç å‹ç¼©ã€ã€ã€ŒBabel æ’ä»¶ã€ç­‰ç­‰ã€‚</li>
<li>æ¸æ¸æ·±å…¥åº•å±‚è¿›è¡Œåˆ†æï¼Œè®©è‡ªå·±å¯¹è¿™é—¨è¯­è¨€æœ‰äº†æ›´å¤šã€æ›´æ·±å…¥çš„äº†è§£ï¼Œå¯ä»¥æ›´å¥½åœ°æˆä¸ºäº§å“ã€Œåˆ›é€ è€…ã€ï¼Œè€Œä¸å•çº¯æ˜¯ã€Œä½¿ç”¨è€…ã€ã€‚</li>
<li><strong>Write JavaScript that writes JavaScript! The best editor is JavaScript. Cool!</strong></li>
</ul>
<h2 id="-">æ€è€ƒ</h2>
<ul>
<li>å¯ä»¥åœ¨ä¸€ä¸ª codemod transform é‡Œé¢åŒæ—¶è¿›è¡Œä¸¤ä¸ªå˜æ¢å—ï¼Ÿä¸ªäººè§‰å¾—å¯èƒ½ä¼šå¾ˆå¤æ‚ä¸”æ•ˆæœä¸å¤ªå¥½ï¼Œå› ä¸ºæœ‰äº› transform å¹¶ä¸æ˜¯æ­£äº¤çš„ã€‚ğŸ¤”</li>
</ul>
<h2 id="refs-">Refs:</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=d0pOgY8__JM">CPojerâ€™s Talk</a></li>
<li><a href="https://medium.com/@cpojer/effective-javascript-codemods-5a6686bb46fb#.s5kdne4xl">Effective JavaScript Codemods</a></li>
<li><a href="https://survivejs.com/blog/codemod-interview/">Codemod Interview</a></li>
<li><a href="https://vramana.github.io/blog/2015/12/21/codemod-tutorial/">How to write a codemod</a> ç»“åˆ CPojerâ€™s Talk, è¿™ä¸ªè™½å¾ˆé•¿ä½†å¾ˆæœ‰ç”¨ï¼</li>
<li><a href="https://www.sitepoint.com/understanding-asts-building-babel-plugin/">Understanding Babel Plugin</a></li>
<li><a href="http://tech.meituan.com/abstract-syntax-tree.html">AST åœ¨ç¾å›¢çš„åº”ç”¨</a></li>
<li><a href="http://imweb.io/topic/57b13b4f93d9938132cc8dfd">imweb</a></li>
</ul>
]]></description><link>/2017-02-15-fun-with-codemod-and-ast/index.html</link><guid isPermaLink="true">/2017-02-15-fun-with-codemod-and-ast/index.html</guid><category><![CDATA[tech]]></category><category><![CDATA[programming]]></category><category><![CDATA[frontend]]></category><dc:creator><![CDATA[ZBL]]></dc:creator><pubDate>Tue, 14 Feb 2017 17:21:00 GMT</pubDate></item><item><title><![CDATA[ç§»åŠ¨ç¯å¢ƒä¸‹çš„ SEO]]></title><description><![CDATA[<p>çœŸçš„æœ‰å¾ˆä¹…å¾ˆä¹…æ²¡æ¥ç†è¿™ä¸ªåšå®¢ï¼Œè·ç¦»ä¸Šä¸€ç¯‡æ–‡ç« çš„å‘å¸ƒæ—¥æœŸæ˜¯ä¸¤å¹´å‰ã€‚
æ¯•ä¸šå·¥ä½œåæ¥äº†è±†ç“£ï¼Œæœ€è¿‘å¯¹ç§»åŠ¨ç¯å¢ƒï¼ˆä¸»è¦æ˜¯æµè§ˆå™¨åŠå¾®ä¿¡ï¼‰çš„ SEO ç›¸å…³è¿›è¡Œäº†ä¸‹ç ”ç©¶ï¼Œæ­£å¥½åœ¨è¿™é‡Œåˆ†äº«ä¸€ä¸‹ã€‚</p>
<p>ä»¥ä¸‹ï¼ŒEnjoyã€‚</p>
<hr>
<h3 id="1-seo-search-engine-optimazition">1. SEOï¼šSearch Engine Optimazition</h3>
<p>äº§å“ï¼šæœç´¢å¼•æ“ä¼˜åŒ–ï¼Œä¿ƒè¿›å†…å®¹ç½‘ç«™ä¿¡æ¯åˆ†äº«ï¼ä¼ æ’­ï¼Œæé«˜ç›®æ ‡è½¬åŒ–ç‡ï¼Œç•™å­˜ç‡</p>
<p>å·¥ç¨‹ï¼šä¸ºå„ç±»é¡µé¢å®ç°ç»Ÿä¸€çš„ä¿¡æ¯åˆ†äº«ã€ä¼ æ’­ï¼Œæé«˜æœç´¢æ’åï¼ˆsearch rankingï¼‰</p>
<p>ä¸ªäººè§‰å¾—ï¼š</p>
<ul>
<li>è±†ç“£æ˜¯ä¸€ä¸ªå†…å®¹ç½‘ç«™ï¼Œæ‹¥æœ‰ä¸€äº› UGC ä¼˜è´¨å†…å®¹ï¼ŒSEO é—´æ¥å¸®åŠ©ç”¨æˆ·åˆ†äº«ã€‚
ä¸”åˆ†äº«ç‡è¶Šé«˜ï¼Œä¹Ÿä¼šæé«˜æœç´¢æ’åã€‚</li>
<li>M ç«™çš„ç›®å‰é¢å‘<strong> äººï¼ˆUserï¼‰ </strong>çš„ UX æ¯”è¾ƒå®Œå–„ï¼Œä½†æ˜¯ä»éœ€è¦ä¸°å¯Œä¸€äº›ç»†èŠ‚ï¼Œè®© <strong>Search Engine</strong> çš„ UX æ›´å¥½ï¼Œæ›´å¥½åœ°ç†è§£ M ç«™ã€‚</li>
</ul>
<h3 id="2-seo-">2. å‰ç«¯åœ¨ SEO ä¸­çš„ä½ç½®</h3>
<ul>
<li><strong>å¸®åŠ©äº§å“è¿›è¡ŒTDK ï¼ˆTitle / Description / Keywordï¼‰ä¼˜åŒ–</strong></li>
<li><strong>æ·»åŠ ä¸€äº› Social Meta Tag ï¼ˆFacebook / Twitter / G+ / WeChat / Weiboï¼‰</strong></li>
<li>é¡µé¢å†…å®¹ä¼˜åŒ–ï¼ˆHTML5 æ ‡ç­¾è¯­ä¹‰åŒ–ã€å”¯ä¸€çš„ H1 æ ‡é¢˜ã€img è®¾ç½® <code>alt</code> å±æ€§ï¼Œä¸éœ€è¦çˆ¬è™«è·Ÿè¸ªçš„é“¾æ¥åŠ  <code>nofollow</code>ï¼‰</li>
<li>URL ä¼˜åŒ– (<strong>canonical</strong>ï¼Œæ ‡ç­¾è¡¨ç¤ºé¡µé¢çš„å”¯ä¸€æ€§)<ul>
<li>åœ¨æœç´¢å¼•æ“é‡Œï¼Œ<strong>åªæœ‰é“¾æ¥å®Œå…¨ä¸€æ ·ï¼Œæ‰ä¼šè®¤ä¸ºæ˜¯åŒä¸€ä¸ªé“¾æ¥</strong>ï¼Œå¦‚æœé“¾æ¥å¸¦ä¸Šå‚æ•°ï¼Œè™½ç„¶è®¿é—®åˆ°çš„å†…å®¹è¿˜æ˜¯ä¸€æ ·ï¼Œä½†æ˜¯åœ¨æœç´¢å¼•æ“çœ‹æ¥ç¡®æ˜¯ä¸åŒçš„é“¾æ¥ï¼Œé¡µé¢æŠ“å–ä¹Ÿä¼šå‡ºç°å¤šæ¬¡ï¼Œä»è€Œå¯¼è‡´å¤šä¸ªé“¾æ¥ï¼Œå†…å®¹ä¸€æ ·ã€‚</li>
<li>å› æ­¤ URL ä¸­æœ€å¥½æ˜¯ä¸è¦å¸¦ä¸ŠæŸ¥è¯¢å‚æ•°ã€‚ä½†ä¸ºäº†äº§å“ç»Ÿè®¡æ•°æ®ï¼Œæ€»éœ€è¦ <code>?from=xxx&amp;refer=xxx</code>ç­‰å‚æ•°ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>canonical</code>æ ‡ç­¾æ¥ç¡®ä¿é“¾æ¥å”¯ä¸€æ€§ï¼Œé¿å…æƒé‡åˆ†æ•£ã€æµå¤±ã€‚</li>
<li>æ¯”å¦‚ <code>m.douban.com/group/topics[?start=xxx]</code>å‡è§†ä¸ºåŒä¸€ä¸ªé¡µé¢è¿™é‡Œçš„ <code>?start=xxx</code>æ˜¯ä¸€ä¸ªåˆ†é¡µæŸ¥è¯¢å‚æ•°ï¼Œæ‰€ä»¥ä¸ºäº†ç¡®ä¿è¿™äº›é¡µé¢éƒ½èƒ½ç»§æ‰¿ m.douban.group/toics è¿™ä¸ª url  çš„æƒé‡ï¼Œåœ¨<code>head</code>ä¸­å¢åŠ äº†<code>canonical</code>æ ‡ç­¾</li>
</ul>
</li>
<li>Meta robots</li>
<li>Sitemap</li>
</ul>
<h3 id="3-">3. å…·ä½“å®ç°</h3>
<blockquote>
<p><strong>ç»Ÿä¸€ SNS æŠ“å–</strong></p>
<p>æä¾›ä¸€ä¸ª mako å‡½æ•°ï¼Œç»Ÿä¸€åˆ†äº«çš„æ ‡é¢˜ã€å›¾ç‰‡ã€æè¿°</p>
<ul>
<li>Open Graph</li>
<li>Twitter Card</li>
</ul>
<p><strong>å®ç°ç»Ÿä¸€çš„åˆ†äº«æ¥å£</strong></p>
<p>å¯å˜çš„å›¾ç‰‡ã€æ ‡é¢˜ã€æè¿°</p>
<ul>
<li><p>å¾®ä¿¡ ï¼ˆiOSã€Android ç³»ç»Ÿåˆ†äº«èœå•ã€å¾®ä¿¡å†…ç½®åˆ†äº«ï¼‰</p>
</li>
<li><ul>
<li>å¤–éƒ¨è°ƒç”¨åˆ†äº«å¯èƒ½ä¼šæŠ“å–æ ‡é¢˜ã€ç¬¬ä¸€ä¸ªå›¾ç‰‡åœ°å€ï¼ˆOpen Graphï¼‰</li>
<li>è°ƒç”¨å†…ç½®åˆ†äº«å¯ç”¨ç¬¬ä¸‰ä¸ªé“¾æ¥ (API è·¨å­åŸŸ)</li>
</ul>
</li>
<li><p>å¾®åš</p>
</li>
</ul>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p><a href="https://developers.facebook.com/docs/sharing/opengraph">https://developers.facebook.com/docs/sharing/opengraph</a></p>
<p><a href="https://dev.twitter.com/cards/overview">https://dev.twitter.com/cards/overview</a></p>
<p><a href="http://github.intra.douban.com/frodo/Talion/blob/master/views/j/wechat/__init__.py">http://github.intra.douban.com/frodo/Talion/blob/master/views/j/wechat/<strong>init</strong>.py</a> </p>
<p>â€” From <a href="https://paper.dropbox.com/doc/-SEO-UVIgU3WYPUeiJv3nOPP0N">Douban FE Dropbox</a></p>
</blockquote>
<h3 id="-">å®ç°æ–¹æ¡ˆ</h3>
<h4 id="1-seo_meta-mako-widget">1. å¢åŠ äº† <code>seo_meta()</code> Mako widget</h4>
<p> <a href="http://github.intra.douban.com/frodo/Talion/blob/master/templates/card/widgets.html#L527">http://github.intra.douban.com/frodo/Talion/blob/master/templates/card/widgets.html#L527</a></p>
<pre class="hljs"><code><span class="xml"></span>&lt;%<span class="perl">def name=<span class="hljs-string">&quot;seo_meta(title, desc, image=None, url=None, type=None, rating_count=None, rating_val=None, wechat_timeline_title=None,wechat_chat_title=None, wechat_desc=None, wechat_image=None)&quot;</span>&gt;
    &lt;%
        from douban.image.qiniu import qiniu_proxy_url

        default_title = <span class="hljs-string">&#39;è±†ç“£&#39;</span>
        default_desc = <span class="hljs-string">&#39;è¯»ä¹¦ã€çœ‹ç”µå½±ã€æ¶¨çŸ¥è¯†ã€å­¦ç©¿æ­...ï¼ŒåŠ å…¥å…´è¶£å°ç»„ï¼Œè·å¾—è¾¾äººä»¬çš„é«˜è´¨é‡ç”Ÿæ´»ç»éªŒï¼Œæ‰¾åˆ°æœ‰ç›¸åŒçˆ±å¥½çš„å°ä¼™ä¼´ã€‚&#39;</span>
        default_image = static(<span class="hljs-string">&#39;/pics/icon/m_logo_180.png&#39;</span>)
        default_url = <span class="hljs-string">&#39;<a href="http://m.douban.com/">http://m.douban.com/</a>&#39;</span>
        default_type = <span class="hljs-string">&#39;article&#39;</span>
        image = qiniu_proxy_url(image, <span class="hljs-number">300</span>, <span class="hljs-number">300</span>, mode=<span class="hljs-string">&#39;1&#39;</span>) <span class="hljs-keyword">if</span> image <span class="hljs-keyword">else</span> <span class="hljs-string">&#39;&#39;</span>
    </span>%&gt;<span class="xml">
    <span class="hljs-comment">&lt;!-- Schema.org markup for Google+ --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">itemprop</span>=<span class="hljs-value">&quot;name&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ title or default_title }&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">itemprop</span>=<span class="hljs-value">&quot;description&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ desc or default_desc }&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">itemprop</span>=<span class="hljs-value">&quot;image&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ image or default_image }&quot;</span>&gt;</span>
</span><span class="perl">    % <span class="hljs-keyword">if</span> rating_count:</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">itemprop</span>=<span class="hljs-value">&quot;reviewCount&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ rating_count }&quot;</span>&gt;</span>
</span><span class="perl">    % endif</span><span class="xml">
</span><span class="perl">    % <span class="hljs-keyword">if</span> rating_val:</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">itemprop</span>=<span class="hljs-value">&quot;ratingValue&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ rating_val }&quot;</span>&gt;</span>
</span><span class="perl">    % endif</span><span class="xml">
    <span class="hljs-comment">&lt;!-- Twitter meta --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">&quot;twitter:card&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;summary&quot;</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- Open Graph meta --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;og:title&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ title or default_title }&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;og:description&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ desc or default_desc }&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;og:site_name&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;è±†ç“£(æ‰‹æœºç‰ˆ)&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;og:url&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ url or default_url }&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;og:image&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ image or default_image }&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;og:image:type&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;image/png&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;og:image:width&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;300&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;og:image:height&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;300&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;og:type&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ type or default_type }&quot;</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- Wechat meta --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;weixin:timeline_title&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ wechat_timeline_title or &#39;&#39; }&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;weixin:chat_title&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ wechat_chat_title or &#39;&#39; }&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;weixin:description&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ wechat_desc or &#39;&#39; }&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">property</span>=<span class="hljs-value">&quot;weixin:image&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">&quot;${ image or default_image }&quot;</span> /&gt;</span>
    </span>&lt;%<span class="perl">block filter=<span class="hljs-string">&quot;collect_js&quot;</span>&gt;
    ;(function () {
        window.setMeta = function (name, val) {
          var meta = document.querySelectorAll(<span class="hljs-string">&#39;meta[property=&quot;&#39;</span> + name + <span class="hljs-string">&#39;&quot;], meta[name=&quot;&#39;</span> + name + <span class="hljs-string">&#39;&quot;]&#39;</span>)
          <span class="hljs-keyword">if</span> (!meta.<span class="hljs-keyword">length</span>) {
            meta = document.createElement(<span class="hljs-string">&#39;meta&#39;</span>)
            meta.name = name
            document.head.appendChild(meta)
          }
         meta[<span class="hljs-number">0</span>].content = val || <span class="hljs-string">&#39;&#39;</span>
        }
        window.getMeta = function (name) {
          var meta = document.querySelectorAll(<span class="hljs-string">&#39;meta[property=&quot;&#39;</span> + name + <span class="hljs-string">&#39;&quot;], meta[name=&quot;&#39;</span> + name + <span class="hljs-string">&#39;&quot;]&#39;</span>)
          <span class="hljs-keyword">if</span> (!meta.<span class="hljs-keyword">length</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">&#39;&#39;</span>
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> meta[<span class="hljs-number">0</span>].content
          }
        }
        setMeta(<span class="hljs-string">&#39;og:url&#39;</span>, location.href)
        !getMeta(<span class="hljs-string">&#39;weixin:chat_title&#39;</span>) &amp;&amp; setMeta(<span class="hljs-string">&#39;weixin:chat_title&#39;</span>, document.title)
        !getMeta(<span class="hljs-string">&#39;weixin:timeline_title&#39;</span>) &amp;&amp; setMeta(<span class="hljs-string">&#39;weixin:timeline_title&#39;</span>, document.title)
        !getMeta(<span class="hljs-string">&#39;weixin:description&#39;</span>) &amp;&amp; setMeta(<span class="hljs-string">&#39;weixin:description&#39;</span>, getMeta(<span class="hljs-string">&#39;og:description&#39;</span>))
    })();
    &lt;<span class="hljs-regexp">/%block&gt;
&lt;/</span><span class="hljs-variable">%def</span>&gt;</span></code></pre><h4 id="2-m-seo-meta-tags">2. ç»™ m ç«™å¤§éƒ¨åˆ†é¡µé¢å¢åŠ äº† SEO Meta Tags</h4>
<p>ä¹‹å‰åˆ†äº«å‡ºå»æŠ“ä¸åˆ°è‡ªå®šä¹‰çš„ description å’Œ image ï¼Œç°é»˜è®¤åˆ†äº«åˆ° weixin çš„ title ã€ description ã€image å€¼éƒ½å’Œ Open Graph ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹</p>
<ul>
<li><code>og:title</code>ï¼Œ <code>og:description</code> å’Œä¹‹å‰çš„ title, description ä¸€æ ·ï¼›</li>
</ul>
<ul>
<li><code>og:url</code> ï¼š å½“å‰é¡µé¢ urlï¼›</li>
<li><code>og:image</code>ï¼š<ul>
<li>å°ç»„å¸–å­é¡µå’Œå•ä¸ªæ—¥è®°é¡µå¦‚æœ‰å›¾ç‰‡ï¼Œåˆ™ä¸ºç¬¬ä¸€å¼ å›¾ç‰‡çš„ src urlï¼Œæ²¡æœ‰çš„è¯ä¸ºç°åœ¨é»˜è®¤çš„åˆ†äº« icon src urlï¼›</li>
<li>æ¡ç›®é¡µçš„å‡ä¸ºè¯¥æ¡ç›®çš„ image src urlï¼›</li>
<li>ç›¸å†Œé¡µä¸ºè¯¥ç›¸å†Œç¬¬ä¸€å¼  image srcï¼›</li>
<li>è±†åˆ—ã€æ ‡ç­¾é¡µä¸ºé»˜è®¤çš„åˆ†äº« icon src</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>Hashtag é¡µ</strong></p>
<ul>
<li>image: è¿è¥å¤´å›¾ || è±† iconï¼›</li>
<li>title: { hashtag_name} - è±†ç“£ï¼›</li>
<li>description: è¿è¥æè¿° || &#39;æœ‰å…³#{ hashtag_name }#çš„è¯é¢˜è®¨è®ºï¼Œè±†ç“£ç”¨æˆ·å‚ä¸çš„ç²¾å½©è¯é¢˜&#39;ï¼›</li>
</ul>
</li>
<li><p><strong>å•æ¡å¹¿æ’­é¡µ</strong></p>
<ul>
<li>å¾®ä¿¡èŠå¤©ã€æœ‹å‹åœˆï¼šimage =  å¹¿æ’­ç¬¬ä¸€å¼ å›¾ || è±† iconï¼›</li>
<li>å¾®ä¿¡èŠå¤©é¡µï¼š title = XXX çš„è±†ç“£å¹¿æ’­; description = å¹¿æ’­æ–‡å­—å†…å®¹çš„å‰åäº”ä¸ªå­— || é»˜è®¤çš„ m ç«™æè¿°ï¼›</li>
<li>å¾®ä¿¡æœ‹å‹åœˆï¼š title = å¹¿æ’­æ–‡å­—å†…å®¹å‰åäº”ä¸ªå­— || XXX çš„è±†ç“£å¹¿æ’­</li>
</ul>
</li>
<li><p>å…³äº image å›¾ç‰‡è§„æ ¼ï¼š</p>
<p>ä¸ºäº†ä½¿æŠ“å–çš„å›¾ç‰‡æ›´ä¼˜é›…ï¼Œä¸è¢«å‹ç¼©å˜å½¢ï¼Œä½¿ç”¨ã€Œä¸ƒç‰›å›¾ç‰‡æœåŠ¡ã€è¿›è¡Œå‰ªè£ã€‚</p>
<p>é»˜è®¤ <code>og:image</code> ç­‰ image å‡ä¼šè¢«ä»¥ <code>width = height = 300</code> è¿›è¡Œå¤„ç†ã€‚</p>
<ul>
<li><a href="http://github.intra.douban.com/frodo/Talion/tree/23fe149cc3186f15195634cca774861d3ce9efca">Talion</a>/<a href="http://github.intra.douban.com/frodo/Talion/tree/23fe149cc3186f15195634cca774861d3ce9efca/libs">libs</a>/<strong>image.py</strong></li>
<li><a href="http://github.intra.douban.com/frodo/Talion/blob/23fe149cc3186f15195634cca774861d3ce9efca/libs/image.py#L11">http://github.intra.douban.com/frodo/Talion/blob/23fe149cc3186f15195634cca774861d3ce9efca/libs/image.py#L11</a></li>
<li><code>from douban.image.qiniu import qiniu_proxy_url</code></li>
</ul>
<p>â€‹</p>
</li>
</ul>
<p>æ•ˆæœæˆªå±ï¼š</p>
<p><a href="http://github.intra.douban.com/frodo/Talion/pull/253">http://github.intra.douban.com/frodo/Talion/pull/253</a></p>
<h4 id="3-">3. ç»Ÿä¸€åˆ†äº«æ¥å£ï¼ˆå¾®ä¿¡é‡åº¦ä½¿ç”¨æ‚£è€…ï¼‰</h4>
<ul>
<li><a href="http://github.intra.douban.com/frodo/Talion/blob/master/static/js/card/weixin.js#L52">weixin.js</a>ã€ <a href="https://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html#.E5.88.86.E4.BA.AB.E6.8E.A5.E5.8F.A3">å¾®ä¿¡ JSSDK æ–‡æ¡£</a></li>
</ul>
<pre class="hljs"><code>
wx.onMenuShareTimeline($.extend({}, shareData,{
    title: <span class="hljs-built_in">window</span>.getMeta(<span class="hljs-string">&#39;weixin:timeline_title&#39;</span>) || <span class="hljs-built_in">document</span>.title,
    success: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        wxShareStat.target = <span class="hljs-string">&#39;timeline&#39;</span>;
        $.get(<span class="hljs-string">&#39;/j/wechat/shared&#39;</span>, wxShareStat);
    },
    cancel: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}
}));

wx.onMenuShareAppMessage($.extend({}, shareData,{
    title: <span class="hljs-built_in">window</span>.getMeta(<span class="hljs-string">&#39;weixin:chat_title&#39;</span>) || <span class="hljs-built_in">document</span>.title,
    desc: <span class="hljs-built_in">window</span>.getMeta(<span class="hljs-string">&#39;weixin:description&#39;</span>) || <span class="hljs-built_in">window</span>.getMeta(<span class="hljs-string">&#39;og:description&#39;</span>),
    success: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        wxShareStat.target = <span class="hljs-string">&#39;friend&#39;</span>;
        $.get(<span class="hljs-string">&#39;/j/wechat/shared&#39;</span>, wxShareStat);
    },
    cancel: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}
}));</code></pre><p>  ç»“åˆä½¿ç”¨ <code>meta[name=&quot;weixin:image&quot;]</code></p>
<pre class="hljs"><code>&lt;meta property=<span class="hljs-string">&quot;weixin:timeline_title&quot;</span> content=<span class="hljs-string">&quot;<span class="hljs-subst">${ wechat_timeline_title <span class="hljs-keyword">or</span> <span class="hljs-string">&#39;&#39;</span> }</span>&quot;</span> /&gt;
&lt;meta property=<span class="hljs-string">&quot;weixin:chat_title&quot;</span> content=<span class="hljs-string">&quot;<span class="hljs-subst">${ wechat_chat_title <span class="hljs-keyword">or</span> <span class="hljs-string">&#39;&#39;</span> }</span>&quot;</span> /&gt;
&lt;meta property=<span class="hljs-string">&quot;weixin:description&quot;</span> content=<span class="hljs-string">&quot;<span class="hljs-subst">${ wechat_desc <span class="hljs-keyword">or</span> <span class="hljs-string">&#39;&#39;</span> }</span>&quot;</span> /&gt;
&lt;meta property=<span class="hljs-string">&quot;weixin:image&quot;</span> content=<span class="hljs-string">&quot;<span class="hljs-subst">${ image <span class="hljs-keyword">or</span> default_image }</span>&quot;</span> /&gt;</code></pre><ul>
<li><p>è‡ªå®šä¹‰å¾®ä¿¡åˆ†äº«åˆ°èŠå¤©ã€æœ‹å‹åœˆçš„æ˜¾ç¤ºå†…å®¹ï¼Œæ–‡æ¡ˆ<code>setMeta()</code>, <code>getMeta()</code></p>
</li>
<li><p><strong>Tips:</strong> å¦‚æœæ²¡æœ‰è®¾ç½® <code>wx.onMenuShareTimeline()</code>/ <code>wx.onMenuShareAppMessage()</code> ä¸­çš„ title / imgUrl / desc å‚æ•°ï¼Œå¾®ä¿¡å†…ç½®æµè§ˆå™¨é»˜è®¤æŠ“å–å¯¹åº”çš„<code>og:xxx</code> ç›¸å…³ã€‚</p>
</li>
<li><p><strong>Bugs:</strong> é€šè¿‡ Safari Extension åˆ†äº«å‡ºæ¥çš„æ°¸è¿œæŠ“çš„æ˜¯ <code>apple-touch-icon</code> ğŸ˜‚</p>
</li>
</ul>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">&quot;apple-touch-icon-precomposed&quot;</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">&quot;<a href="https://img3.doubanio.com/f/talion/315ba4fc82e5cdb5c50ef1d9f88c8aa2c5c0c4ba/pics/icon/m_logo_76.png">https://img3.doubanio.com/f/talion/315ba4fc82e5cdb5c50ef1d9f88c8aa2c5c0c4ba/pics/icon/m_logo_76.png</a>&quot;</span>&gt;</span></code></pre><p>å¾®ä¿¡åˆ†äº«æ•ˆæœå›¾ï¼š
<img src="&#39;/content/images/seo_in_mobile/seo_1.png&#39;" alt="after_seo_1">
<img src="&#39;/content/images/seo_in_mobile/seo_2.png&#39;" alt="after_seo_2">
<img src="&#39;/content/images/seo_in_mobile/seo_3.png&#39;" alt="after_seo_3"></p>
<h3 id="further-reading-resource">Further Reading &amp; Resource</h3>
<ol>
<li>Sitemap &amp; <a href="http://baiduseoguide.com/news/20141128113.html">Deadlink</a></li>
<li>Social Meta Tag Cheatsheet</li>
<li>Google SEO TOP1: Baidu Baike ğŸ˜‚</li>
<li><a href="https://developer.apple.com/library/safari/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html">Apple Safari supported meta tags</a></li>
<li><a href="http://static.googleusercontent.com/media/www.google.com/en//webmasters/docs/search-engine-optimization-starter-guide.pdf">Google SEO search-engine-optimization-starter-guide</a></li>
<li>Google ç»“æ„åŒ–æ•°æ®æ ‡è®°è¾…åŠ©å·¥å…·</li>
<li><a href="http://www.hobo-web.co.uk/seo-tutorial/">SEO Tutorial</a></li>
<li><a href="http://www.ghugo.com/jd-seo/">äº¬ä¸œ SEO</a></li>
<li>SEO Tools<ul>
<li><a href="https://www.google.com/webmasters/">Google Webmasters Search Console</a></li>
<li><a href="https://varvy.com/tools/">Varvy SEO tool</a></li>
<li><a href="http://keywordtool.io/">Keyword Tool</a></li>
</ul>
</li>
</ol>
]]></description><link>/2016-05-20-seo-in-mobile/index.html</link><guid isPermaLink="true">/2016-05-20-seo-in-mobile/index.html</guid><category><![CDATA[SEO]]></category><category><![CDATA[shares]]></category><category><![CDATA[tech]]></category><dc:creator><![CDATA[ZBL]]></dc:creator><pubDate>Thu, 19 May 2016 18:21:00 GMT</pubDate></item></channel></rss>