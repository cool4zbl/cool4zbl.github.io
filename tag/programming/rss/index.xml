<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[undefined - ZBL's Doodle]]></title><description><![CDATA[Thoughts, ideas]]></description><link>http://localhost:5000/</link><generator>Ghost</generator><lastBuildDate>Sun, 02 Jul 2017 15:11:08 GMT</lastBuildDate><atom:link href="http://localhost:5000/tag/undefined/rss/" rel="self" type="application/rss+xml"/><ttl>60</ttl><item><title><![CDATA[Fun with Codemod & AST]]></title><description><![CDATA[<h1 id="fun-with-codemod-ast">Fun with Codemod &amp; AST</h1>
<hr>
<h2 id="content">Content</h2>
<ul>
<li>èƒŒæ™¯</li>
<li>Codemod</li>
<li>jscodeshift</li>
<li>Demo Time</li>
<li>Refs</li>
</ul>
<hr>
<h2 id="-">èƒŒæ™¯</h2>
<p>  ä½œä¸ºä¸€ä¸ªè‡ªä¿¡è€Œè‡ªè±ªçš„å‰ç«¯å¼„æ½®å„¿ï¼ˆF2Eï¼‰ï¼Œæˆ‘ä»¬æ€»æ˜¯å¸Œæœ›èƒ½å¤Ÿåœ¨è¿™ä¸ªæ¯å¤©éƒ½åœ¨é£é€Ÿè¿­ä»£çš„è¡Œä¸šï¼Œä¸æ—¶æ¸è¿›ã€‚
  å‰ç«¯ä»¬æ˜¯ä¸€ç¾¤ä¸å®‰åˆ†çš„äººï¼Œå¤§å®¶å–œçˆ±æ–°æ¡†æ¶ã€æ–°è¯­æ³•ï¼Œè€Œ JavaScript ä¹Ÿæ˜¯ä¸€é—¨éå¸¸çµæ´»çš„è¯­è¨€ï¼Œå®ƒæä¾›ç»™æˆ‘ä»¬çš„ API ä¹Ÿåœ¨ä¸æ—¶æ¸è¿›ã€‚æ¯”å¦‚ï¼Œå½“ <code>ES2015 ES2016 ES2017â€¦</code> å‡ºæ¥çš„æ—¶å€™ï¼Œé‚£äº›æ–°è¯­æ³•ç³–ï¼Œç®€æ´æ¼‚äº®ï¼Œä¸”æ›´æ˜“äºç†è§£é€»è¾‘ï¼Œäºæ˜¯æˆ‘ä»¬éƒ½æƒ³å»å°è¯•ä¸‹ã€‚
  ä½†æ˜¯å°è¯•å½’å°è¯•ï¼Œå¯¹äºæ–°é¡¹ç›®å°è¯•èµ·æ¥æˆæœ¬å¾ˆä½ï¼Œåªéœ€è¦æŠŠæ–°åŠŸèƒ½éƒ½ç”¨æ–°è¯­æ³•ç¼–å†™å°±å¥½ã€‚
  è€Œåˆ›å»ºæ–°é¡¹ç›®çš„åŒæ—¶ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿåœ¨ç»´æŠ¤ç€ä¸€äº›å·²æœ‰çš„æ—§é¡¹ç›®ã€‚å¦‚æœä½ è¿˜å¹¶æ²¡æ€ä¹ˆç†å®ƒä»¬ï¼Œå¯èƒ½å®ƒä»¬è¿˜æ´»å¾—ä¸é”™ã€‚ä½†æ˜¯ä¸€æ—¦ PM å¿ƒæƒ…å¥½æƒ³åŠ ä¸ªæ–°åŠŸèƒ½ï¼Œæˆ–è€…ä½ å“ªå¤©å¿ƒæƒ…å¥½æƒ³å»æ›´æ–°ä¸‹ä»£ç åº“ï¼Œç„¶åçœ‹åˆ°è‡ªå·±ä¹‹å‰å†™çš„é‚£äº›ä»£ç ï¼Œé‚£äº›ç°åœ¨å…¶å®å¯ä»¥æ›´ä¼˜é›…æ¼‚äº®çš„ä»£ç ï¼Œæ˜¯ä¸æ˜¯æ‰‹é‡Œç‰¹ç—’ç—’ç‰¹æƒ³æŠŠå®ƒä»¬æ›´æ–°äº†ï¼Ÿ
  æ‰§è¡ŒåŠ›å¼ºçš„å‰ç«¯å„¿å¯èƒ½è¯´å¹²å°±å¹²äº†ï¼Œå—¯ï¼Œå°±å‡è®¾æˆ‘ä»¬æœ‰ä¸ªé¡¹ç›® Projectï¼Œé‡Œé¢ä½¿ç”¨çš„æ˜¯ç”¨<code>ES5</code> ç‰ˆ <code>React</code> ä½œä¸º <code>UI View</code>ã€‚ç„¶åå®ƒå¤§æ¦‚å››ä¸ªé¡µé¢<code>(Page)</code>ï¼Œæ¯ä¸ªé¡µé¢åŒ…å«å¤§æ¦‚å››ä¸ªç»„ä»¶<code>(Component)</code>ï¼Œç„¶åä½ ä»æŸä¸ªçœ‹èµ·æ¥æ¯”è¾ƒå°ã€ä¸å®¹æ˜“å‡ºé”™çš„<code>Component</code> å…¥æ‰‹ï¼Œå¼€å§‹ä¸€è¡Œä¸€è¡Œæ”¹å†™ä»£ç ï¼Œå—¯ï¼Œ<code>var React = require(&#39;reactâ€™)</code> æ”¹ä¸º <code>import React from &#39;reactâ€™</code>ï¼Œ <code>var API = â€˜/j/app/xxxâ€™</code> æ”¹ä¸º <code>const API = â€˜/j/app/xxxâ€™</code>ï¼Œ<code>var foo</code> æ”¹ä¸º <code>let foo</code>ï¼Œ<code>function () {â€¦}</code> æ”¹ä¸º <code>() =&gt; {â€¦}</code>ï¼Œ<code>module.exports = React.createClass({â€¦})</code> æ”¹ä¸º <code>export default class MyComponent extends React.Component {â€¦}</code> â€¦ 
  å¤©å“ªï¼Œæœ‰å®Œæ²¡å®Œï¼Œä¸€ä¸ªç»„ä»¶æ”¹å®Œä¸‹æ¥ï¼Œä½ å·²ç»æ„Ÿåˆ°èº«ä½“è¢«æç©ºï¼Œæœ›äº†æœ› <code>Components</code> åˆ—è¡¨ï¼Œæ›´ä¸ç”¨è¯´ï¼Œé‡æ–° <code>build</code> è¿‡çš„æµ‹è¯•è¿˜æ²¡è¿‡ã€‚ä½ é™·å…¥äº†ç»æœ›...</p>
<p>  é‚£ä¹ˆæœ‰æ²¡æœ‰æ›´å¿«ä¸€ç‚¹çš„åŠæ³•å‘¢ï¼Ÿ
  ç¨å¾®æœ‰ç‚¹ç»éªŒçš„å‰ç«¯å„¿å¯èƒ½æƒ³åˆ°ã€Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ›¿æ¢ã€ã€‚Bash <code>Awk | Sed</code> å‘½ä»¤ï¼Œæˆ–è€… Vim <code>:%s/var/let/g</code>ã€‚å¯æ˜¯å¦‚æœéœ€è¦æœ‰äº›å˜é‡æ˜¯ <code>const</code> ç±»å‹ï¼Œæœ‰äº›æ˜¯ <code>let</code>ï¼Œè€Œæœ‰äº›ä¿æŒ <code>var</code> ä¸å˜æ€ä¹ˆåŠï¼Ÿå†æ¯”å¦‚è¯´ </p>
<pre class="hljs"><code>  <span class="hljs-tag">merge</span>(a, {<span class="hljs-attribute">b</span>: <span class="hljs-number">1</span>}, c);  <span class="hljs-comment">// Old</span>

  éœ€è¦å˜ä¸º

  ({..<span class="hljs-class">.a</span>, <span class="hljs-tag">b</span>: <span class="hljs-tag">1</span>, ..<span class="hljs-class">.c</span>});  <span class="hljs-comment">// New</span></code></pre><p>  è¿™é‡Œå…‰æ˜¯è¿™ä¸ªå‡½æ•°çš„ <code>arguments</code> å°±å¯èƒ½æœ‰å¤šç§å½¢å¼ï¼Œæ¯”å¦‚ <code>variable</code>ï¼Œä¸€ä¸ªåŒ¿åå‡½æ•°è¿”å›çš„ Object æˆ–è€… <code>Plain Object</code> é‚£ç§ã€‚
  è¿™é‡Œç›¸å½“äºæ˜¯ä¸€ä¸ª <code>Context-non-free</code> çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸‹æ–‡è¯­ä¹‰å¾ˆé‡è¦ã€‚
  è¿™æ ·çš„è¯ï¼Œæ— è®ºå†æ€ä¹ˆå¼ºå¤§çš„<code>RegExp</code> ä¹Ÿæ— èƒ½ä¸ºåŠ›ã€‚å› ä¸ºæ­£åˆ™çš„æœ¬è´¨ï¼Œå…¶å®æ˜¯æ ¹æ®ä¸€å®šçš„ <code>Pattern</code> æ¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œä½†æ˜¯åœ¨çœŸæ­£çš„ä»£ç é‡Œé¢ï¼Œæ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½æœ‰è¯­ä¹‰ï¼Œéƒ½æœ‰ä¸Šä¸‹æ–‡ï¼Œè¿™é‡Œçš„æ­£åˆ™è¡¨è¾¾å¼ä¼šæ—¢å¤æ‚åˆæ— ç”¨ã€‚
  æ‰€ä»¥ï¼Œæˆ‘ä»¬å¾—æ¢ä¸€ä¸ªç»´åº¦æ€è€ƒé—®é¢˜ã€‚</p>
<hr>
<h2 id="codemod">Codemod</h2>
<p>  å¯¹ã€Œä»£ç åº“çš„æ‰¹é‡è¿ç§»æ›´æ–°ã€ï¼Œå…¶å®ä¹Ÿæ˜¯ç¨‹åºå‘˜çš„ä¸€ä¸ªéœ€æ±‚ï¼Œæ‰€ä»¥ä¹Ÿæ„Ÿæ¿€åœ°ï¼Œå·²ç»æœ‰ä¸€ç¾¤æ‡’æƒ°åˆèªæ˜çš„ç¨‹åºå‘˜é€ å‡ºäº†å·¥å…·ï¼š<code>Codemod</code>ï¼Œå°†ã€Œå¤§å‹ä»“åº“ä»£ç çš„æ‰¹é‡è¿ç§»ã€è‡ªåŠ¨åŒ–ï¼Œçœæ—¶çœåŠ›ã€‚</p>
<p>  å¥½å§ï¼Œæ‰€ä»¥ Codemod åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
  å®˜æ–¹æ–‡æ¡£è¿™æ ·å†™ç€ï¼š</p>
<blockquote>
<p>Codemod is a tool/library to assist you with large-scale codebase refactors that can be partially automated but still require human oversight and occasional intervention.</p>
</blockquote>
<p>  è¿™æ ·çœ‹æ¥ï¼Œå¯ä»¥å¾ˆå¥½çš„è§£å†³æˆ‘ä»¬çš„éœ€æ±‚äº†ã€‚
  åŸºäº Codemodï¼Œåˆå‡ºç°äº†é’ˆå¯¹ JavaScript ä»£ç è¿ç§»çš„å·¥å…· <a href="https://github.com/facebook/jscodeshift">Facebook jscoodeshift</a>ï¼Œ
  åŸºäº jscodeshiftï¼Œåˆæ„å»ºäº†è¿ç§»ä¸€èˆ¬ JavaScript ä»£ç ï¼ˆæ¯”å¦‚ ES5 -&gt; ES2015) çš„å·¥å…· <a href="https://github.com/cpojer/js-codemod">js-codemod</a> å’Œè¿ç§» React ç›¸å…³é¡¹ç›®çš„ <a href="https://github.com/reactjs/react-codemod">react-codemod</a>ã€‚</p>
<p>  å—¯ï¼Œè¿™ä¹ˆçœ‹æ¥ï¼Œæˆ‘ä»¬çš„äº‹æƒ…å°±å˜å¾—å®¹æ˜“å¤šäº†ã€‚
  æ ¹æ®ä¸Šé¢é‚£äº›å·¥å…·çš„å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre class="hljs"><code>  &gt; npm i -g jscodeshift
  &gt; git clone https:<span class="hljs-comment">//github.com/reactjs/react-codemod.git</span>
  &gt; git clone https:<span class="hljs-comment">//github.com/cpojer/js-codemod.git</span>
  &gt; jscodeshift -t react-codemod/transforms/<span class="hljs-keyword">class</span>.js --<span class="hljs-keyword">mixin</span>-<span class="hljs-keyword">module</span>-name=react-addons-<span class="hljs-keyword">pure</span>-render-<span class="hljs-keyword">mixin</span> --flow=<span class="hljs-literal">true</span> --<span class="hljs-keyword">pure</span>-component=<span class="hljs-literal">true</span> --remove-runtime-proptypes=<span class="hljs-literal">false</span> src/register/component/myComponent.jsx
  &gt; jscodeshift -t js-codemod/transforms/no-vars.js ./src/register/component/myComponent.jsx</code></pre><p>  ç„¶åï¼Œå†æ¬¡ <code>git status</code> ä¸€ä¸‹æˆ–è€…ç›´æ¥æ‰“å¼€åˆšæ‰ transform çš„ <code>myComponent.jsx</code> æ–‡ä»¶æŸ¥çœ‹ï¼Œä½ ä¼šå‘ç°ï¼Œç¥å¥‡èˆ¬ï¼Œä½ çš„ä»£ç éƒ½æˆä¸ºäº†å®ƒä»¬åº”è¯¥æˆä¸ºçš„æ ·å­ã€‚</p>
<p>  è¿™é‡Œæš‚æ—¶ä»¥æˆ‘ä¹‹å‰åšçš„ Accounts é¡¹ç›®ä¸ºä¾‹ï¼š
  <a href="https://github.intra.douban.com/accounts/accounts/pull/553/files#diff-b2286efdea6a62288250264e82bd948b">https://github.intra.douban.com/accounts/accounts/pull/553/files#diff-b2286efdea6a62288250264e82bd948b</a></p>
<ul>
<li><p>åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ <code>codemod</code>ï¼Œæ‰€ä»¥æ¯”è¾ƒè°¨æ…ï¼Œä¸€ä¸ªä¸€ä¸ª <code>component</code> æ¥ï¼›</li>
<li>å…ˆç”¨ <code>react-codemod</code> è½¬ï¼ŒæŠŠå¤§éƒ¨å¤´ä»£ç è¿ç§»ï¼›</li>
<li>ç„¶å <code>js-codemod</code> å°æ­¥æ›´æ–°æ•´ç†ï¼›</li>
<li>ç„¶åå†æ ¹æ®ä¸€äº›è‡ªå·±çš„ Code Style åšäº›ç»†èŠ‚ä¸Šçš„ä¿®æ”¹ã€‚æ¯”å¦‚ä½¿ç”¨ <code>standard-format</code> å·¥å…·æ ¼å¼åŒ–ä»£ç ï¼Œç¬¦åˆæˆ‘ä¸ªäººå†™çš„ä»£ç é£æ ¼ã€‚</li>
<li>æ¯•ç«Ÿ JS å¤ªè¿‡äºçµæ´»ï¼Œæ¯ä¸ªäººå†™ä»£ç æ—¶å€™é£æ ¼å’Œç»“æ„éƒ½æ˜¯å„å¼‚çš„ï¼Œæœ‰æ—¶å€™çš„è½¬æ¢è¿˜æ˜¯ä¼šå‡ºç°ä¸€äº›ä¸æƒ³è±¡ä¸­ä¸ä¸€è‡´çš„ç»“æœï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæ˜¯è¯´ä»ç„¶éœ€è¦äººå·¥å¹²é¢„ï¼Œæ‰€ä»¥ä¼šæ‰‹åŠ¨ä¿®æ”¹ä¸‹ä»£ç ç»†èŠ‚ï¼›</li>
<li>ä¸€åˆ‡ç»„ä»¶è¿ç§»å°±ç»ªï¼Œ<code>npm run test</code> æµ‹è¯•é€šè¿‡ä»¥åï¼Œé‡æ–° <code>build</code> è¿è¡Œ</li>
</ul>
<p>è¿™é‡Œæˆ‘æŠŠå·²æœ‰çš„åå‡ ä¸ªç»„ä»¶å’Œé¡µé¢æ–‡ä»¶ï¼Œå…¨éƒ¨ä½¿ç”¨ä¸Šé¢çš„å·¥å…·è¿›è¡Œäº†æ›´æ–°ã€‚
ç„¶åå½“ä½ é‡æ–° <code>build</code> åï¼Œä½ ä¼šå‘ç°æµ‹è¯•ä»ç„¶é€šè¿‡ï¼Œç»„ä»¶åŠŸèƒ½ä»ç„¶ workï¼Œä½†æ˜¯ä»£ç åº“å´æ˜¯ä½¿ç”¨æ–°è¯­æ³•ç³–è¿›è¡Œäº†å¤§è§„æ¨¡å½»å½»åº•åº•åœ°æ›´æ–°ï¼ç®€ç›´å¤ªç¥å¥‡äº†ï¼
é‚£ä¹ˆï¼Œå®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p>
</li>
</ul>
<hr>
<h2 id="jscodeshift">jscodeshift</h2>
<p>  è®©æˆ‘ä»¬æ¥é‡æ–°è¯»ä¸€ä¸‹ jscodeshift çš„<a href="https://github.com/facebook/jscodeshift#jscodeshift-">æ–‡æ¡£</a>ã€‚</p>
<blockquote>
<p>jscodeshift is a toolkit for running codemods over multiple JS files. It provides:</p>
</blockquote>
<ul>
<li>A runner, which executes the provided transform for each file passed to it. It also outputs a summary of how many files have (not) been transformed.</li>
<li><p>A wrapper around recast, providing a different API. Recast is an AST-to-AST transform tool and also tries to preserve the style of original code as much as possible.</p>
<p>é‚£ä¹ˆè¿™é‡Œå°±å‡ºç°äº†ä¸¤ä¸ªå…³é”®çš„æ¦‚å¿µï¼š<em>Runner</em> åŠ <em>AST</em>ã€‚</p>
</li>
<li><p>Runnerï¼Œ</p>
</li>
<li><blockquote>
<p>A runner/worker feature that can apply transforms to thousands of files in parallel.</p>
<pre class="hljs"><code>  -- <a href="span class=&quot;hljs-link_url&quot;&gt;https://medium.com/@cpojer/effective-javascript-codemods-5a6686bb46fb#.sg03sd9eq&lt;/span"><span class="hljs-link_label">CPojer Effective JavaScript Codemods</span></a></code></pre></blockquote>
</li>
<li><p>ASTï¼ŒAbstract Syntax Treeï¼ŒæŠ½è±¡è¯­æ³•åˆ†ææ ‘ã€‚</p>
<p>ä¸ºäº†æ›´å¥½ç†è§£ä»¥ä¸Šæ¦‚å¿µï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ä¹‹å‰è¿è¡Œ jscodeshift å‘½ä»¤è¿‡ç¨‹ã€‚
æˆ‘ä»¬å…ˆæ˜¯æŠŠä¸€ä¸ªé‡Œé¢åŒ…å«äº† JS ä»£ç çš„æºæ–‡ä»¶ä¼ ç»™äº†å®ƒï¼Œç„¶åå®ƒè¯»å–äº†æºä»£ç ï¼Œåˆæ ¹æ®å†™å¥½çš„ <code>transform.js</code> å¯¹æºä»£ç è¿›è¡Œäº†ç›¸åº”çš„å˜æ¢ï¼Œæœ€åè¾“å‡ºäº†å˜æ¢åçš„ JS ä»£ç ï¼Œè¦†ç›–äº†åŸæ–‡ä»¶ã€‚
ç®€å•çš„è¯´ï¼Œå°±æ˜¯ 
<code>SourceCode =&gt; codemod =&gt; ObjectCode</code></p>
<p>é‚£ä¹ˆå†è¯¦ç»†ä¸€ç‚¹ï¼Œæ ¹æ® jscodeshift ä½œè€…ä¹‹ä¸€çš„ CPojer åœ¨ä¸€æ¬¡ JSConf ä¸Šå¯¹è¿™ä¸ªå·¥å…·çš„ä»‹ç»ï¼Œjscodeshift æ“ä½œåŸºæœ¬æ˜¯æŒ‰ä»¥ä¸‹è¿‡ç¨‹ï¼š
<code>Parse =&gt; Find =&gt; Create =&gt; Update =&gt; Print</code></p>
</li>
<li><p>Parse: SourceCode =&gt; AST ï¼ˆTree Nodes)</p>
</li>
<li>Find: Find the Nodes we want to replace         // Transform</li>
<li>Create: Create the New Nodes we want to insert  // Transform</li>
<li>Update: Update the AST at the right location    // Transform</li>
<li><p>Print: Print it back into JavaScript Source with proper formatting and should like human wrote this.</p>
<h3 id="-parse-ast-">ç¬¬ä¸€æ­¥ï¼Œå°†æºä»£ç è§£æ (parse) æˆ AST.</h3>
<p>æˆ‘ä»¬çŸ¥é“è‡ªç„¶è¯­è¨€ï¼ˆNatural Language)ï¼Œæ— è®ºä»€ä¹ˆè¯­ç§ï¼Œéƒ½ä¼šæœ‰ã€Œä¸»è¯­ã€ã€ŒåŠ¨è¯ã€ã€Œå®¾è¯­ã€ã€Œæ ‡ç‚¹ç¬¦å·ã€æ¥æè¿°ä¸€ä¸ªç°å®ä¸–ç•Œæ‰€å‘ç”Ÿçš„äº‹ä»¶ã€‚
è€Œåœ¨è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ (Programming Language)ï¼Œæ— è®ºä»€ä¹ˆè¯­ç§ï¼Œéƒ½ä¼šæœ‰ã€Œç±»å‹ã€ã€Œè¿ç®—ç¬¦ã€ã€Œæµç¨‹è¯­å¥ã€ã€Œå‡½æ•°ã€ã€Œå¯¹è±¡ã€ç­‰æ¦‚å¿µæ¥è¡¨è¾¾è®¡ç®—æœºä¸­å­˜åœ¨å†…å­˜ä¸­çš„0å’Œ1ï¼Œä»¥åŠèƒŒåè¿ç®—ä¸é€»è¾‘ã€‚
ä¸åŒçš„è¯­è¨€ï¼Œéƒ½ä¼šé…ä¹‹ä¸åŒçš„è¯­æ³•åˆ†æå™¨(parser)ã€‚
å¯¹äºè‡ªç„¶è¯­è¨€ï¼Œæˆ‘ä»¬çš„å¤§è„‘å°±æ˜¯ä¸€ä¸ª Parserã€‚å¯¹äºç¼–ç¨‹è¯­è¨€ï¼Œè¯­æ³•åˆ†æå™¨æ˜¯æŠŠæºä»£ç ä½œä¸ºå­—ç¬¦ä¸²è¯»å…¥ã€è§£æï¼Œå¹¶å»ºç«‹è¯­æ³•æ ‘çš„ç¨‹åºã€‚</p>
<p>ä»€ä¹ˆæ˜¯è¯­æ³•æ ‘ï¼Ÿæ‘˜è‡ª Wiki ä¸€æ®µï¼š</p>
<blockquote>
<p>è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax tree æˆ–è€…ç¼©å†™ä¸º ASTï¼‰ï¼Œæˆ–è€…è¯­æ³•æ ‘ï¼ˆsyntax treeï¼‰ï¼Œæ˜¯æºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç°å½¢å¼ï¼Œè¿™é‡Œç‰¹æŒ‡ç¼–ç¨‹è¯­è¨€çš„æºä»£ç ã€‚æ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚ä¹‹æ‰€ä»¥è¯´è¯­æ³•æ˜¯ã€ŒæŠ½è±¡ã€çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„è¯­æ³•å¹¶ä¸ä¼šè¡¨ç¤ºå‡ºçœŸå®è¯­æ³•ä¸­å‡ºç°çš„æ¯ä¸ªç»†èŠ‚ã€‚</p>
</blockquote>
<p>è¿™ä¹ˆè¯´å…¶å®è¿˜æ˜¯æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬å…ˆæ‰“å¼€ <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">wiki</a> çœ‹åˆ° wikipedia è¿™ä¸ªå›¾ï¼Œ</p>
<p><img src="https://media.github.intra.douban.com/user/62/files/9d7500be-f370-11e6-972f-f5ede1c448f8" alt="image"></p>
</li>
</ul>
<p>  å‰ç«¯er ä¸€å®šä¼šè§‰å¾—å¾ˆç›¸ä¼¼ï¼Œè¿™é‡Œä¸å°±æ˜¯ DOM è¯­æ³•æ ‘çš„ç»ˆææŠ½è±¡ç‰ˆæœ¬å—ï¼Œåªæ˜¯æŠŠä¸€ä¸ªä¸ª DOM Nodes æ¢æˆäº†ä¸€ä¸ªä¸ªæ›´åŠ æ— è¯­ä¹‰çš„å­—ç¬¦ Tokenã€‚
  FB æœ‰ä¸€ä¸ªå¾ˆæ£’çš„å·¥å…· <a href="http://astexplorer.net/">ASTExplorer</a>ï¼Œå¯ä»¥ç”¨æ¥æ›´å½¢è±¡åœ°å±•ç¤ºã€‚</p>
<p>  æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬ç°åœ¨å°±åªæœ‰ä¸€ä¸ªå¾ˆç®€å•çš„è¡¨è¾¾å¼<code>a+b</code>ï¼Œè¿™é‡Œæ˜¯ recast Parser è§£æåçš„ AST ç»“æ„ï¼š</p>
<p>  <img src="https://media.github.intra.douban.com/user/62/files/758a6076-f370-11e6-97e4-f6152c3814bf" alt="image"></p>
<p>  çœ‹ä¸Šå»ç‰¹åˆ«å¤æ‚ã€‚æ³¨æ„é‚£äº›è“è‰²å­—ä½“ <code>File</code>, <code>Programme</code>,<code>ExpressionStatement</code>,<code>Identifier</code>â€¦ è¿™äº›éƒ½æ˜¯ AST Nodesï¼Œå…¶ä»–çš„éƒ½æ˜¯å’Œè¿™ä¸ª Node ç›¸å…³çš„æ•°æ®ã€‚</p>
<p>  æ ¹æ®å‰æ–‡å¯ä»¥çŸ¥é“ï¼Œæ¯ç§è¯­è¨€çš„ AST éƒ½æ˜¯ä¸åŒçš„ã€‚æœ‰ä¸“é—¨çš„ Parser æ¥ç”Ÿæˆ ASTã€‚</p>
<p>  å…³äº <a href="https://en.wikipedia.org/wiki/Parsing#Parser">Parser</a> åˆæ˜¯ä¸€é—¨å¾ˆæ·±çš„å­¦é—®äº†ã€‚
  åœ¨ ASTExplorer.net ä¸Šå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤š parserï¼Œæ¯”è¾ƒè‘—åçš„æœ‰ <a href="https://github.com/jquery/esprima/blob/master/src/parser.ts">Esprima(jQuery)</a>ï¼ŒUglify-JS, Babylon(Babel), Acorn(Tern / Webpack), åŠ jscodeshift ä½¿ç”¨çš„ recast. è™½ç„¶æœ‰å¾ˆå¤š Parserï¼Œä½†æ˜¯åŸºæœ¬ä¸Šï¼Œä¸€ä¸ª parser çš„ç»“æ„éƒ½å·®ä¸å¤šï¼Œå¯¹æºä»£ç è¿›è¡Œè¯æ³•åˆ†æï¼Œç”Ÿæˆ Tokensï¼Œå¯¹ Tokens è¿›è¡Œè¯­æ³•åˆ†æï¼Œç„¶åç”Ÿæˆ ASTã€‚</p>
<p>  <img src="https://media.github.intra.douban.com/user/62/files/5751ac04-f370-11e6-849e-692ab4b47bbf" alt="image"></p>
<p>  å…·ä½“å¯ä»¥å‚è€ƒçœ‹ä¸‹ <a href="http://esprima.org/demo/parse.html#">Esprima Parse Demo</a>ã€‚
  ç”Ÿæˆçš„ AST éƒ½éµå¾ªä¸€ä¸ªç»Ÿä¸€æ ‡å‡† <a href="https://github.com/estree/estree/blob/master/es5.md">ESTree</a> or <a href="parser API https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API">Mozilla SpiderMonkey</a>ï¼Œä¹Ÿå°±æ˜¯è¯´éƒ½ä¼šè¿”å› ESTree Compatible AST.</p>
<h3 id="-ast-find-nodes-create-new-nodes-update-nodes-">ç¬¬äºŒä¸‰å››æ­¥ï¼Œå¯¹ç”Ÿæˆçš„ AST è¿›è¡Œæ“ä½œä¿®æ”¹ (Find Nodes &amp; Create New Nodes &amp; Update Nodes)</h3>
<p>  Wiki æœ‰ä»‹ç»è¯´ï¼Œparse AST çš„ä»£ç åŸºæœ¬æ˜¯ä½¿ç”¨<code>Visitor Pattern</code>ï¼Œå¦‚ï¼š</p>
<pre class="hljs"><code>  <span class="hljs-comment">// recast</span>
  <span class="hljs-keyword">var</span> ast = recast.parse(src);
  recast.visit(ast, {
    visitIdentifier: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span> </span>{
      <span class="hljs-comment">// do something with path</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  });</code></pre><p>  ä½†æ˜¯ js-codeshift åŸºäº <a href="https://github.com/facebook/jscodeshift#collections-and-traversal"><code>Collections</code></a> æ¦‚å¿µï¼Œå¾ˆè´´å¿ƒçš„ç»™è¿™äº› Parser API ç»§ç»­åŒ…äº†ä¸€å±‚ï¼Œæä¾›äº†ä¸€ä¸ªä¸ä¸€æ ·çš„å‰ç«¯å‹å¥½å‹ API.</p>
<pre class="hljs"><code>  <span class="hljs-comment">// jscodeshift</span>
  <span class="hljs-tag">jscodeshift</span>(src)
    <span class="hljs-class">.find</span>(jscodeshift.Identifier)
    <span class="hljs-class">.forEach</span>(<span class="hljs-function">function</span>(path) {
      <span class="hljs-comment">// do something with path</span>
    });

  <span class="hljs-comment">// Provide jQuery-likely and F2E-friendly Syntax API</span>
  <span class="hljs-comment">// Manipulate AST nodes conveniently.</span></code></pre><p>  è¯»è¿™æ®µä»£ç çš„æ—¶å€™ï¼Œä¸€ä¸‹å­è§‰å¾—åˆä¼¼æ›¾ç›¸è¯†ã€‚è¿™ä¸å°±å’Œä½¿ç”¨ <code>jQuery</code> æ“ä½œ DOM ä¸€æ ·å˜›ã€‚
  å¯ä»¥å¯¹æ¯”ä¸‹ â€œæ™®é€š Parserâ€ ä¸ jscodeshift æ“çºµ AST çš„åŒºåˆ«ï¼š
  å¯ä»¥çœ‹åˆ°å¦‚æœä½¿ç”¨ <a href="http://esprima.org/">esprima</a> ï¼ŒAST Traverse / Walk åŸºæœ¬æ˜¯ <code>visitor pattern</code>.
  <a href="https://github.intra.douban.com/zhangbinliu/ast_demo/tree/esprima">https://github.intra.douban.com/zhangbinliu/ast_demo/tree/esprima</a></p>
<h3 id="-">ç¬¬äº”æ­¥ï¼Œè¾“å‡ºè½¬æ¢åçš„ä»£ç </h3>
<p>  è¿™ä¸ªæ® CPojer è¯´ï¼Œæ ¹æ®è½¬æ¢åçš„ ASTï¼Œä»¥åŠä¸€äº›è¾“å‡º <a href="https://github.com/benjamn/recast/blob/52a7ec3eaaa37e78436841ed8afc948033a86252/lib/options.js#L61">Options</a>ï¼ˆæ¯”å¦‚æ˜¯å¦å•å¼•å·ã€tab å®½åº¦æ˜¯å¤šå°‘ã€éœ€ä¸éœ€è¦å»æ‰å°¾éƒ¨åˆ†å·â€¦ï¼‰æ˜¯ä¸€ä¸ªæŒºå›°éš¾çš„è¿‡ç¨‹ã€‚
  ä½†æœ€ç»ˆï¼Œjscodeshift çš„ print API è¯­æ³•å´æ˜¯åªè¦ä¸€è¡Œä»£ç å³å¯ã€‚</p>
<pre class="hljs"><code>  <span class="hljs-class">.toSource</span>({<span class="hljs-attribute">quote</span>: <span class="hljs-string">&#39;single&#39;</span>}); <span class="hljs-comment">// sets strings to use single quotes in transformed code.</span></code></pre><p>  å…¶å® Recast åœ¨è¿™åšäº†<a href="(https://github.com/benjamn/recast/blob/master/lib/printer.js">å¤§é‡çš„å·¥ä½œ</a> )ã€‚</p>
<p>  ç»è¿‡è¿™äº”ä¸ªæ­¥éª¤ï¼Œä¸€æ¬¡ jscodeshift çš„è½¬æ¢è¿‡ç¨‹å°±ç®—å®Œæˆäº†ã€‚</p>
<hr>
<h2 id="demo-time-">DEMO TIME!</h2>
<h3 id="write-a-codemod-transform">Write a codemod transform</h3>
<pre class="hljs"><code><span class="hljs-escape"><code>j&lt;/span&gt;scodeshift -t &amp;lt;transform.js&amp;gt; /to/file/path&lt;span class=&quot;hljs-escape&quot;&gt;</code> </span>çš„ <span class="hljs-escape"><code>t&lt;/span&gt;ransform.js&lt;span class=&quot;hljs-escape&quot;&gt;</code>ï¼Œ</span>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ æ‰“ç®—ä½¿ç”¨ jscodeshift å¯¹æºæ–‡ä»¶è¿›è¡Œä½•ç§å˜æ¢ï¼Œè¿™é‡Œé¢å°±æ˜¯å˜æ¢å‡½æ•°ï¼›</code></pre><h4 id="problem-">Problem:</h4>
<pre class="hljs"><code>  <span class="hljs-comment">// Before</span>
  <span class="hljs-string">&#39;Hello, &#39;</span> + name + <span class="hljs-string">&#39;, this is a string.&#39;</span>
  <span class="hljs-comment">// After</span>
  <code>Hello, ${name}, &lt;span class=&quot;hljs-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;is&lt;/span&gt; a &lt;span class=&quot;hljs-keyword&quot;&gt;string&lt;/span&gt;.</code></code></pre><h4 id="solution-">Solution:</h4>
<ol>
<li><p>Simplify:</p>
<pre class="hljs"><code><span class="hljs-comment">// Before</span>
a + b
<span class="hljs-comment">// After</span>
<span class="hljs-string"><code>&lt;span class=&quot;hljs-subst&quot;&gt;${a}&lt;/span&gt;&lt;span class=&quot;hljs-subst&quot;&gt;${b}&lt;/span&gt;</code></span></code></pre><p><code>a + b</code> AST:</p>
<p><img src="https://media.github.intra.douban.com/user/62/files/e4d3c126-f36f-11e6-98aa-382c3afd9bcf" alt="image"></p>
<p><code>${a}${b}</code> AST:</p>
<p><img src="https://media.github.intra.douban.com/user/62/files/ea450a52-f36f-11e6-9a28-f715785d13a2" alt="image"></p>
<p>å¯¹æ¯”ä¸¤ä¸ª AST å¯ä»¥å‘ç°
æˆ‘ä»¬åªéœ€è¦ </p>
</li>
<li><p>è¯»å…¥éœ€è½¬æ¢çš„ä»£ç ï¼Œæ‰¾åˆ° <code>BinaryExpression</code></p>
</li>
<li>ä¿å­˜ <code>BinaryExpression</code> å·¦å³ä¸¤è¾¹çš„å€¼ï¼ˆnode.left &amp; node.right)</li>
<li>ç”Ÿæˆä¸€ä¸ªä¸º <code>TemlateLiteral</code> Nodeï¼Œ<code>quasis</code> æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸‰ä¸ª <code>TemplateElement</code> çš„æ•°ç»„ï¼Œ<code>cookde &amp; raw keys</code> éƒ½æ˜¯ <code>&#39;&#39;</code>ï¼Œ <code>expressions</code> æ˜¯ä¸€ä¸ªåŒ…å« node.left, node.right å€¼çš„æ•°ç»„ã€‚</li>
<li><p>ç„¶åå°†å®ƒè¿”å›è¾“å‡ºï¼›</p>
<p>Solution Example:</p>
</li>
<li><p><a href="http://astexplorer.net/#/gist/33b63b7dc8da6d9ea4936c631adc994d/7905ef5b30dfc0cb3c811af8a8960f11014ef402">http://astexplorer.net/#/gist/33b63b7dc8da6d9ea4936c631adc994d/7905ef5b30dfc0cb3c811af8a8960f11014ef402</a></p>
</li>
<li><a href="http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/55c4910295973b3a4d09770d94cec73d5096daa4">http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/55c4910295973b3a4d09770d94cec73d5096daa4</a></li>
<li><p><a href="http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/cf3c898c5fe494d08a978dd1a3a3e56fc42828a8">http://astexplorer.net/#/gist/a71957902ec1fd79f199eb37e5e6801a/cf3c898c5fe494d08a978dd1a3a3e56fc42828a8</a></p>
<p>å®˜æ–¹æ²¡æœ‰å¤ªè¯¦ç»†çš„ transform ç¼–å†™æŒ‡å¯¼ï¼Œå¯ä»¥å¤šè°·æ­Œæˆ–è€…å­¦ä¹  react-codemod/tranform or js-codemod/transformï¼Œ
ä¸ªäººè§‰å¾—å†™ JS-codeshift Transform | Babel-Plugin æœ¬è´¨å…¶å®å°±æ˜¯å¯¹æ¯”ä¸¤æ£µè¯­æ³•æ ‘ï¼Œåƒè§£è°œä¸€æ ·ï¼Œçœ‹çœ‹å¦‚ä½•ã€Œåˆå¥½åˆå¿«ã€å˜æ¢æˆè¿™æ ·ã€‚
å‰©ä¸‹çš„ä¸€å¼€å§‹å¦‚ä½•è¯»å–æº JS ä»£ç å¹¶è§£ææˆè¯­æ³•æ ‘ï¼Œå…·ä½“åœ¨ AST ä¸Š traverse &amp; find &amp; create &amp; update ï¼ˆè¿™é‡Œæˆ‘çŒœæµ‹å…¶å®æ˜¯ä¸€ä¸ªé€’å½’éå†èŠ‚ç‚¹æ ‘çš„è¿‡ç¨‹ï¼Ÿï¼‰ï¼ŒåŠä¹‹åå¦‚ä½•æŒ‰ä¸€å®šçš„ code style ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„ä»£ç ï¼Œéƒ½æ˜¯é€æ˜ä¸”ä¸å…³å¿ƒçš„ã€‚</p>
</li>
</ol>
<hr>
<h2 id="-">æ€»ç»“ &amp; å¼€è„‘æ´</h2>
<ul>
<li><p>åŸºæœ¬å¤„ç†æµç¨‹ï¼š
<img src="https://media.github.intra.douban.com/user/62/files/7fe54aa4-f370-11e6-90d8-9f191a40a5cc" alt="image"></p>
</li>
<li><p>AST æ˜¯å¾ˆæœ‰ç”¨çš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µã€‚ä¸€æ—¦ä½ ç†è§£äº†è¿™äº›è§„åˆ™ï¼Œå”¯ä¸€çš„é™åˆ¶å°±æ˜¯è§£æå™¨å’Œä½ çš„æƒ³è±¡åŠ›ã€‚</p>
</li>
<li>çº¯ AST parse å¤ªè¿‡äºç†è®ºï¼Œæ—¢ç„¶æ˜¯å·¥ç¨‹å¸ˆï¼Œè¿˜æ˜¯éœ€è¦è‡ªå·±åŠ¨æ‰‹å†™ç‚¹ä»€ä¹ˆæ¥è§£å†³è‡ªå·±å®é™…é‡åˆ°çš„é—®é¢˜ã€‚</li>
<li>å¯ä»¥ç»§ç»­æ‹“å±•åˆ°ã€Œè¯­æ³•é«˜äº®ã€ã€ã€Œå…³é”®å­—åŒ¹é…ã€ã€ã€Œä»£ç æ ¼å¼åŒ–ã€ã€ã€Œä½œç”¨åŸŸåˆ¤æ–­ã€ã€ä»¥åŠã€Œä»£ç å‹ç¼©ã€ã€ã€ŒBabel æ’ä»¶ã€ç­‰ç­‰ã€‚</li>
<li>æ¸æ¸æ·±å…¥åº•å±‚è¿›è¡Œåˆ†æï¼Œè®©è‡ªå·±å¯¹è¿™é—¨è¯­è¨€æœ‰äº†æ›´å¤šã€æ›´æ·±å…¥çš„äº†è§£ï¼Œå¯ä»¥æ›´å¥½åœ°æˆä¸ºäº§å“ã€Œåˆ›é€ è€…ã€ï¼Œè€Œä¸å•çº¯æ˜¯ã€Œä½¿ç”¨è€…ã€ã€‚</li>
<li>Write JavaScript that write JavaScript! The best editor is JavaScript. Cool!</li>
</ul>
<hr>
<h2 id="-">æ€è€ƒ</h2>
<ul>
<li>å¯ä»¥åœ¨ä¸€ä¸ª codemod transform é‡Œé¢åŒæ—¶è¿›è¡Œä¸¤ä¸ªå˜æ¢å—ï¼Ÿä¸ªäººè§‰å¾—å¯èƒ½ä¼šå¾ˆå¤æ‚ä¸”æ•ˆæœä¸å¤ªå¥½ï¼Œå› ä¸ºæœ‰äº› transform å¹¶ä¸æ˜¯æ­£äº¤çš„ã€‚ğŸ¤”</li>
</ul>
<hr>
<h2 id="refs-">Refs:</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=d0pOgY8__JM">CPojerâ€™s Talk</a></li>
<li><a href="https://medium.com/@cpojer/effective-javascript-codemods-5a6686bb46fb#.s5kdne4xl">Effective JavaScript Codemods</a></li>
<li><a href="https://survivejs.com/blog/codemod-interview/">Codemod Interview</a></li>
<li><a href="https://vramana.github.io/blog/2015/12/21/codemod-tutorial/">How to write a codemod</a> ç»“åˆ CPojerâ€™s Talk, è¿™ä¸ªè™½å¾ˆé•¿ä½†å¾ˆæœ‰ç”¨ï¼</li>
<li><a href="https://www.sitepoint.com/understanding-asts-building-babel-plugin/">Understanding Babel Plugin</a></li>
<li><a href="http://tech.meituan.com/abstract-syntax-tree.html">AST åœ¨ç¾å›¢çš„åº”ç”¨</a></li>
<li><a href="http://imweb.io/topic/57b13b4f93d9938132cc8dfd">imweb</a></li>
</ul>
]]></description><link>/2017-02-15-fun-with-codemod-and-ast/index.html</link><guid isPermaLink="true">/2017-02-15-fun-with-codemod-and-ast/index.html</guid><category><![CDATA[programming]]></category><category><![CDATA[frontend]]></category><dc:creator><![CDATA[ZBL]]></dc:creator><pubDate>Thu, 19 May 2016 18:21:00 GMT</pubDate></item></channel></rss>